Object.defineProperty&&Object.getOwnPropertyDescriptor&&Object.getOwnPropertyDescriptor(Element.prototype,"textContent")&&!Object.getOwnPropertyDescriptor(Element.prototype,"textContent").get&&function(){var n=Object.getOwnPropertyDescriptor(Element.prototype,"innerText");Object.defineProperty(Element.prototype,"textContent",{get:function(){return n.get.call(this)},set:function(e){return n.set.call(this,e)}})}(),Array.isArray||(Array.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)});/**
 * @license wysihtml5x v0.4.15
 * https://github.com/Edicy/wysihtml5
 *
 * Author: Christopher Blum (https://github.com/tiff)
 * Secondary author of extended features: Oliver Pulges (https://github.com/pulges)
 *
 * Copyright (C) 2012 XING AG
 * Licensed under the MIT license (MIT)
 *
 */var wysihtml5={version:"0.4.15",// namespaces
commands:{},dom:{},quirks:{},toolbar:{},lang:{},selection:{},views:{},INVISIBLE_SPACE:"\uFEFF",EMPTY_FUNCTION:function(){},ELEMENT_NODE:1,TEXT_NODE:3,BACKSPACE_KEY:8,ENTER_KEY:13,ESCAPE_KEY:27,SPACE_KEY:32,DELETE_KEY:46};(function(n,e){"function"==typeof define&&define.amd?define(n):e.rangy=n()})(function(){/*----------------------------------------------------------------------------------------------------------------*/ // Trio of functions taken from Peter Michaux's article:
// http://peter.michaux.ca/articles/feature-detection-state-of-the-art-browser-scripting
function i(t,e){var n=typeof t[e];return"function"==n||!!("object"==n&&t[e])||"unknown"==n}function O(n,e){return!!("object"==typeof n[e]&&n[e])}function e(n,e){return"undefined"!=typeof n[e]}// Creates a convenience function to save verbose repeated calls to tests functions
function t(a){return function(e,t){for(var n=t.length;n--;)if(!a(e,t[n]))return!1;return!0}}// Next trio of functions are a convenience to save verbose repeated calls to previous two functions
function L(t){return t&&y(t,f)&&w(t,u)}function a(t){return O(t,"body")?t.body:t.getElementsByTagName("body")[0]}function o(e){O(window,"console")&&i(window.console,"log")&&window.console.log(e)}function n(n,e){e?window.alert(n):o(n)}function r(t){N.initialized=!0,N.supported=!1,n("Rangy is not supported on this page in your browser. Reason: "+t,N.config.alertOnFail)}function s(t){return t.message||t.description||t+""}// Initialization
function l(){if(!N.initialized){var e,m=!1,x=!1;i(document,"createRange")&&(e=document.createRange(),y(e,h)&&w(e,g)&&(m=!0));var S=a(document);if(!S||"body"!=S.nodeName.toLowerCase())return void r("No body element found");if(S&&i(S,"createTextRange")&&(e=S.createTextRange(),L(e)&&(x=!0)),!m&&!x)return void r("Neither Range nor TextRange are available");N.initialized=!0,N.features={implementsDomRange:m,implementsTextRange:x};// Initialize modules
var l,v;for(var T in C)(l=C[T])instanceof d&&l.init(l,N);// Call init listeners
for(var f=0,R=E.length;f<R;++f)try{E[f](N)}catch(t){v="Rangy init listener threw an exception. Continuing. Detail: "+s(t),o(v)}}}// Allow external scripts to initialize this library in case it's loaded after the document has loaded
function d(o,e,t){this.name=o,this.dependencies=e,this.initialized=!1,this.supported=!1,this.initializer=t}function m(r,l,e,t){var n=new d(l,e,function(a){if(!a.initialized){a.initialized=!0;try{t(N,a),a.supported=!0}catch(t){var r="Module '"+l+"' failed to load: "+s(t);o(r)}}});C[l]=n}/*----------------------------------------------------------------------------------------------------------------*/ // Ensure rangy.rangePrototype and rangy.selectionPrototype are available immediately
function p(){}var g=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],h=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],u=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],f=["collapse","compareEndPoints","duplicate","moveToElementText","parentElement","select","setEndPoint","getBoundingClientRect"],y=t(i),b=t(O),w=t(e),C={},N={version:"1.3alpha.20140804",initialized:!1,supported:!0,util:{isHostMethod:i,isHostObject:O,isHostProperty:e,areHostMethods:y,areHostObjects:b,areHostProperties:w,isTextRange:L,getBody:a},features:{},modules:C,config:{alertOnFail:!0,alertOnWarn:!1,preferTextRange:!1,autoInitialize:"undefined"==typeof rangyAutoInitialize||rangyAutoInitialize}};// Minimal set of properties required for DOM Level 2 Range compliance. Comparison constants such as START_TO_START
// are omitted because ranges in KHTML do not have them but otherwise work perfectly well. See issue 113.
N.fail=r,N.warn=function(t){n("Rangy warning: "+t,N.config.alertOnWarn)},{}.hasOwnProperty?N.util.extend=function(o,e,t){var n,l;for(var i in e)e.hasOwnProperty(i)&&(n=o[i],l=e[i],t&&null!==n&&"object"==typeof n&&null!==l&&"object"==typeof l&&N.util.extend(n,l,!0),o[i]=l);// Special case for toString, which does not show up in for...in loops in IE <= 8
return e.hasOwnProperty("toString")&&(o.toString=e.toString),o}:r("hasOwnProperty not supported"),function(){var o=document.createElement("div");o.appendChild(document.createElement("span"));var e,a=[].slice;try{1==a.call(o.childNodes,0)[0].nodeType&&(e=function(t){return a.call(t,0)})}catch(e){}e||(e=function(a){for(var e=[],t=0,r=a.length;t<r;++t)e[t]=a[t];return e}),N.util.toArray=e}();// Very simple event handler wrapper function that doesn't attempt to solve issues such as "this" handling or
// normalization of event properties
var x;i(document,"addEventListener")?x=function(o,e,t){o.addEventListener(e,t,!1)}:i(document,"attachEvent")?x=function(o,e,t){o.attachEvent("on"+e,t)}:r("Document does not have required addEventListener or attachEvent method"),N.util.addListener=x;var E=[];N.init=l,N.addInitListener=function(t){N.initialized?t(N):E.push(t)};var S=[];N.addShimListener=function(t){S.push(t)},N.shim=N.createMissingNativeApi=function(o){o=o||window,l();// Notify listeners
for(var a=0,r=S.length;a<r;++a)S[a](o)},d.prototype={init:function n(){for(var r,s,l=this.dependencies||[],e=0,i=l.length;e<i;++e){if(s=l[e],r=C[s],!r||!(r instanceof d))throw new Error("required module '"+s+"' not found");if(r.init(),!r.supported)throw new Error("required module '"+s+"' not supported")}// Now run initializer
this.initializer(this)},fail:function e(t){throw this.initialized=!0,this.supported=!1,new Error("Module '"+this.name+"' failed to load: "+t)},warn:function(t){N.warn("Module "+this.name+": "+t)},deprecationNotice:function(n,e){N.warn("DEPRECATED: "+n+" in module "+this.name+"is deprecated. Please use "+e+" instead")},createError:function(t){return new Error("Error in Rangy "+this.name+" module: "+t)}},N.createModule=function(a){// Allow 2 or 3 arguments (second argument is an optional array of dependencies)
var e,r;2==arguments.length?(e=arguments[1],r=[]):(e=arguments[2],r=arguments[1]);var s=m(!1,a,r,e);// Initialize the module immediately if the core is already initialized
N.initialized&&s.init()},N.createCoreModule=function(o,e,t){m(!0,o,e,t)},N.RangePrototype=p,N.rangePrototype=new p,N.selectionPrototype=new function(){};/*----------------------------------------------------------------------------------------------------------------*/ // Wait for document to load before running tests
var T=!1,R=function(){T||(T=!0,!N.initialized&&N.config.autoInitialize&&l())};// Test whether we have window and document objects that we will need
return"undefined"==typeof window?void r("No window found"):"undefined"==typeof document?void r("No document found"):(i(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",R,!1),x(window,"load",R),N.createCoreModule("DomUtil",[],function(S,v){// Opera 11 puts HTML elements in the null namespace, it seems, and IE 7 has undefined namespaceURI
function T(n){for(var o=0;n=n.previousSibling;)++o;return o}function t(r,e){var t,s=[];for(t=r;t;t=t.parentNode)s.push(t);for(t=e;t;t=t.parentNode)if(n(s,t))return t;return null}function o(n,e,t){for(var o=t?e:e.parentNode;o;){if(o===n)return!0;o=o.parentNode}return!1}function a(n,e,t){for(var o,s=t?n:n.parentNode;s;){if(o=s.parentNode,o===e)return s;s=o}return null}function r(t){var e=t.nodeType;return 3==e||4==e||8==e;// Text, CDataSection or Comment
}function l(a,e){var t=e.nextSibling,n=e.parentNode;return t?n.insertBefore(a,t):n.appendChild(a),a}// Note that we cannot use splitText() because it is bugridden in IE 9.
function s(t){if(9==t.nodeType)return t;if("undefined"!=typeof t.ownerDocument)return t.ownerDocument;if("undefined"!=typeof t.document)return t.document;if(t.parentNode)return s(t.parentNode);throw v.createError("getDocument: no document found for node")}function d(t){var e=s(t);if("undefined"!=typeof e.defaultView)return e.defaultView;if("undefined"!=typeof e.parentWindow)return e.parentWindow;throw v.createError("Cannot get a window object for node")}function m(t){if("undefined"!=typeof t.contentDocument)return t.contentDocument;if("undefined"!=typeof t.contentWindow)return t.contentWindow.document;throw v.createError("getIframeDocument: No Document object found for iframe element")}// This looks bad. Is it worth it?
function p(t){return t&&y.isHostMethod(t,"setTimeout")&&y.isHostObject(t,"document")}function g(n){var e;try{return e=n.parentNode,!1}catch(e){return!0}}/*----------------------------------------------------------------------------------------------------------------*/function e(n){if(!n)return"[No node]";if(i&&g(n))return"[Broken node]";if(r(n))return"\""+n.data+"\"";if(1==n.nodeType){var e=n.id?" id=\""+n.id+"\"":"";return"<"+n.nodeName+e+">[index:"+T(n)+",length:"+n.childNodes.length+"]["+(n.innerHTML||"[innerHTML not supported]").slice(0,25)+"]"}return n.nodeName}function u(t){this.root=t,this._next=t}function f(n,e){this.node=n,this.offset=e}function h(t){this.code=this[t],this.codeName=t,this.message="DOMException: "+this.codeName}var y=S.util;y.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||v.fail("document missing a Node creation method"),y.isHostMethod(document,"getElementsByTagName")||v.fail("document missing getElementsByTagName method");var b=document.createElement("div");y.areHostMethods(b,["insertBefore","appendChild","cloneNode"])||v.fail("Incomplete Element implementation"),y.isHostProperty(b,"innerHTML")||v.fail("Element is missing innerHTML property");var C=document.createTextNode("test");y.areHostMethods(C,["splitText","deleteData","insertData","appendData","cloneNode"])||v.fail("Incomplete Text Node implementation");/*----------------------------------------------------------------------------------------------------------------*/ // Removed use of indexOf because of a bizarre bug in Opera that is thrown in one of the Acid3 tests. I haven't been
// able to replicate it outside of the test. The bug is that indexOf returns -1 when called on an Array that
// contains just the document as a single element and the value searched for is the document.
var n=/*Array.prototype.indexOf ?
            function(arr, val) {
                return arr.indexOf(val) > -1;
            }:*/function(o,e){for(var t=o.length;t--;)if(o[t]===e)return!0;return!1},i=!1;(function(){var e=document.createElement("b");e.innerHTML="1";var t=e.firstChild;e.innerHTML="<br>",i=g(t),S.features.crashyTextNodes=i})();var w;"undefined"==typeof window.getComputedStyle?"undefined"==typeof document.documentElement.currentStyle?v.fail("No means of obtaining computed style properties found"):w=function(n,e){return n.currentStyle[e]}:w=function(n,e){return d(n).getComputedStyle(n,null)[e]},u.prototype={_current:null,hasNext:function(){return!!this._next},next:function s(){var n,a,r=this._current=this._next;if(this._current)if(n=r.firstChild,n)this._next=n;else{for(a=null;r!==this.root&&!(a=r.nextSibling);)r=r.parentNode;this._next=a}return this._current},detach:function(){this._current=this._next=this.root=null}},f.prototype={equals:function(t){return!!t&&this.node===t.node&&this.offset==t.offset},inspect:function(){return"[DomPosition("+e(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}},h.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11,INVALID_NODE_TYPE_ERR:24},h.prototype.toString=function(){return this.message},S.dom={arrayContains:n,isHtmlNamespace:function o(n){var e;return"undefined"==typeof n.namespaceURI||null===(e=n.namespaceURI)||"http://www.w3.org/1999/xhtml"==e},parentElement:function t(n){var e=n.parentNode;return 1==e.nodeType?e:null},getNodeIndex:T,getNodeLength:function e(t){switch(t.nodeType){case 7:case 10:return 0;case 3:case 8:return t.length;default:return t.childNodes.length;}},getCommonAncestor:t,isAncestorOf:o,isOrIsAncestorOf:function t(n,e){return o(n,e,!0)},getClosestAncestorIn:a,isCharacterDataNode:r,isTextOrCommentNode:function n(t){if(!t)return!1;var e=t.nodeType;return 3==e||8==e;// Text or Comment
},insertAfter:l,splitDataNode:function d(o,e,t){var n=o.cloneNode(!1);// Preserve positions
if(n.deleteData(0,e),o.deleteData(e,o.length-e),l(n,o),t)for(var a,i=0;a=t[i++];)// Handle case where position was inside the portion of node after the split point
a.node==o&&a.offset>e?(a.node=n,a.offset-=e):a.node==o.parentNode&&a.offset>T(o)&&++a.offset;return n},getDocument:s,getWindow:d,getIframeWindow:function e(t){if("undefined"!=typeof t.contentWindow)return t.contentWindow;if("undefined"!=typeof t.contentDocument)return t.contentDocument.defaultView;throw v.createError("getIframeWindow: No Window object found for iframe element")},getIframeDocument:m,getBody:y.getBody,isWindow:p,getContentDocument:function r(a,e,t){var n;if(a?y.isHostProperty(a,"nodeType")?n=1==a.nodeType&&"iframe"==a.tagName.toLowerCase()?m(a):s(a):p(a)&&(n=a.document):n=document,!n)throw e.createError(t+"(): Parameter must be a Window object or DOM node");return n},getRootContainer:function a(n){for(var o;o=n.parentNode;)n=o;return n},comparePoints:function y(n,e,o,r){// See http://www.w3.org/TR/DOM-Level-2-Traversal-Range/ranges.html#Level-2-Range-Comparing
var s,l,i,f,h;if(n==o)// Case 1: nodes are the same
return e===r?0:e<r?-1:1;if(s=a(o,n,!0))// Case 2: node C (container B or an ancestor) is a child node of A
return e<=T(s)?-1:1;if(s=a(n,o,!0))// Case 3: node C (container A or an ancestor) is a child node of B
return T(s)<r?-1:1;if(l=t(n,o),!l)throw new Error("comparePoints error: nodes have no common ancestor");// Case 4: containers are siblings or descendants of siblings
if(i=n===l?l:a(n,l,!0),f=o===l?l:a(o,l,!0),i===f)// This shouldn't be possible
throw v.createError("comparePoints got to case 4 and childA and childB are the same!");else for(h=l.firstChild;h;){if(h===i)return-1;if(h===f)return 1;h=h.nextSibling}}/*----------------------------------------------------------------------------------------------------------------*/ // Test for IE's crash (IE 6/7) or exception (IE >= 8) when a reference to garbage-collected text node is queried
,isBrokenNode:g,inspectNode:e,getComputedStyleProperty:w,fragmentFromNodeChildren:function t(o){for(var e,a=s(o).createDocumentFragment();e=o.firstChild;)a.appendChild(e);return a},createIterator:function e(t){return new u(t)},DomPosition:f},S.DOMException=h}),N.createCoreModule("DomRange",["DomUtil"],function(le){/*----------------------------------------------------------------------------------------------------------------*/ // Utility functions
function ie(n,e){return 3!=n.nodeType&&(P(n,e.startContainer)||P(n,e.endContainer))}function de(t){return t.document||M(t.startContainer)}function ce(t){return new L(t.parentNode,k(t))}function me(t){return new L(t.parentNode,k(t)+1)}function n(a,e,t){var n=11==a.nodeType?a.firstChild:a;return D(e)?t==e.length?A.insertAfter(a,e):e.parentNode.insertBefore(a,0==t?e:H(e,t)):t>=e.childNodes.length?e.appendChild(a):e.insertBefore(a,e.childNodes[t]),n}function t(n,e,t){if(C(n),C(e),de(e)!=de(n))throw new I("WRONG_DOCUMENT_ERR");var o=B(n.startContainer,n.startOffset,e.endContainer,e.endOffset),a=B(n.endContainer,n.endOffset,e.startContainer,e.startOffset);return t?0>=o&&0<=a:0>o&&0<a}function s(n){for(var e,l,i,d=de(n.range).createDocumentFragment();l=n.next();){if(e=n.isPartiallySelectedSubtree(),l=l.cloneNode(!e),e&&(i=n.getSubtreeIterator(),l.appendChild(s(i)),i.detach()),10==l.nodeType)// DocumentType
throw new I("HIERARCHY_REQUEST_ERR");d.appendChild(l)}return d}function pe(n,e,t){var i,d;t=t||{stop:!1};for(var m,p;m=n.next();)if(n.isPartiallySelectedSubtree()){if(!1===e(m))return void(t.stop=!0);if(p=n.getSubtreeIterator(),pe(p,e,t),p.detach(),t.stop)return}else for(i=A.createIterator(m);d=i.next();)if(!1===e(d))return void(t.stop=!0)}function o(n){for(var e;n.next();)n.isPartiallySelectedSubtree()?(e=n.getSubtreeIterator(),o(e),e.detach()):n.remove()}function d(n){for(var e,r,s=de(n.range).createDocumentFragment();e=n.next();){if(n.isPartiallySelectedSubtree()?(e=e.cloneNode(!1),r=n.getSubtreeIterator(),e.appendChild(d(r)),r.detach()):n.remove(),10==e.nodeType)// DocumentType
throw new I("HIERARCHY_REQUEST_ERR");s.appendChild(e)}return s}function a(d,e,m){var n,p=!!(e&&e.length);p&&(n=new RegExp("^("+e.join("|")+")$"));var o=[];return pe(new i(d,!1),function(e){if((!p||n.test(e.nodeType))&&(!!!m||m(e))){// Don't include a boundary container if it is a character data node and the range does not contain any
// of its character data. See issue 190.
var t=d.startContainer;if(!(e==t&&D(t)&&d.startOffset==t.length)){var a=d.endContainer;e==a&&D(a)&&0==d.endOffset||o.push(e)}}}),o}function e(n){var e="undefined"==typeof n.getName?"Range":n.getName();return"["+e+"("+A.inspectNode(n.startContainer)+":"+n.startOffset+", "+A.inspectNode(n.endContainer)+":"+n.endOffset+")]"}/*----------------------------------------------------------------------------------------------------------------*/ // RangeIterator code partially borrows from IERange by Tim Ryan (http://github.com/timcameronryan/IERange)
function i(o,e){if(this.range=o,this.clonePartiallySelectedTextNodes=e,!o.collapsed){this.sc=o.startContainer,this.so=o.startOffset,this.ec=o.endContainer,this.eo=o.endOffset;var t=o.commonAncestorContainer;this.sc===this.ec&&D(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc!==t||D(this.sc)?q(this.sc,t,!0):this.sc.childNodes[this.so],this._last=this.ec!==t||D(this.ec)?q(this.ec,t,!0):this.ec.childNodes[this.eo-1])}}function r(t){return function(e,n){for(var o,a=n?e:e.parentNode;a;){if(o=a.nodeType,V(t,o))return a;a=a.parentNode}return null}}function m(n,e){if($(n,e))throw new I("INVALID_NODE_TYPE_ERR")}function p(n,e){if(!V(e,n.nodeType))throw new I("INVALID_NODE_TYPE_ERR")}function g(n,e){if(0>e||e>(D(n)?n.length:n.childNodes.length))throw new I("INDEX_SIZE_ERR")}function u(n,e){if(X(n,!0)!==X(e,!0))throw new I("WRONG_DOCUMENT_ERR")}function f(t){if(Y(t,!0))throw new I("NO_MODIFICATION_ALLOWED_ERR")}function l(n,e){if(!n)throw new I(e)}function h(t){return U&&A.isBrokenNode(t)||!V(F,t.nodeType)&&!X(t,!0)}function y(n,e){return e<=(D(n)?n.length:n.childNodes.length)}function b(t){return!!t.startContainer&&!!t.endContainer&&!h(t.startContainer)&&!h(t.endContainer)&&y(t.startContainer,t.startOffset)&&y(t.endContainer,t.endOffset)}function C(t){if(!b(t))throw new Error("Range error: Range is no longer valid after DOM mutation ("+t.inspect()+")")}/*----------------------------------------------------------------------------------------------------------------*/ // Test the browser's innerHTML support to decide how to implement createContextualFragment
function w(l,e){C(l);var t=l.startContainer,i=l.startOffset,d=l.endContainer,m=l.endOffset,p=t===d;D(d)&&0<m&&m<d.length&&H(d,m,e),D(t)&&0<i&&i<t.length&&(t=H(t,i,e),p?(m-=i,d=t):d==t.parentNode&&m>=k(t)&&m++,i=0),l.setStartAndEnd(t,i,d,m)}function N(n){C(n);var e=n.commonAncestorContainer.parentNode.cloneNode(!1);return e.appendChild(n.cloneContents()),e.innerHTML}/*----------------------------------------------------------------------------------------------------------------*/function x(t){t.START_TO_START=0,t.START_TO_END=1,t.END_TO_END=2,t.END_TO_START=3,t.NODE_BEFORE=0,t.NODE_AFTER=1,t.NODE_BEFORE_AND_AFTER=2,t.NODE_INSIDE=3}function E(t){x(t),x(t.prototype)}function S(a,e){return function(){C(this);var t,p,g=this.startContainer,u=this.startOffset,h=this.commonAncestorContainer,r=new i(this,!0);g!==h&&(t=q(g,h,!0),p=me(t),g=p.node,u=p.offset),pe(r,f),r.reset();// Remove the content
var s=a(r);return r.detach(),e(this,g,u,g,u),s}}function v(e,u){function t(o,e){return function(t){p(t,j),p(W(t),F);var n=(o?ce:me)(t);(e?a:s)(this,n.node,n.offset)}}function a(r,e,t){var n=r.endContainer,s=r.endOffset;(e!==r.startContainer||t!==r.startOffset)&&((W(e)!=W(n)||1==B(e,t,n,s))&&(n=e,s=t),u(r,e,t,n,s))}function s(r,e,t){var n=r.startContainer,s=r.startOffset;(e!==r.endContainer||t!==r.endOffset)&&((W(e)!=W(n)||-1==B(e,t,n,s))&&(n=e,s=t),u(r,n,s,e,t))}// Set up inheritance
var n=function(){};n.prototype=le.rangePrototype,e.prototype=new n,O.extend(e.prototype,{setStart:function(n,e){m(n,!0),g(n,e),a(this,n,e)},setEnd:function(n,e){m(n,!0),g(n,e),s(this,n,e)},/**
                 * Convenience method to set a range's start and end boundaries. Overloaded as follows:
                 * - Two parameters (node, offset) creates a collapsed range at that position
                 * - Three parameters (node, startOffset, endOffset) creates a range contained with node starting at
                 *   startOffset and ending at endOffset
                 * - Four parameters (startNode, startOffset, endNode, endOffset) creates a range starting at startOffset in
                 *   startNode and ending at endOffset in endNode
                 */setStartAndEnd:function(){var r=arguments,e=r[0],t=r[1],n=e,s=t;switch(r.length){case 3:s=r[2];break;case 4:n=r[2],s=r[3];}u(this,e,t,n,s)},setBoundary:function(o,e,t){this["set"+(t?"Start":"End")](o,e)},setStartBefore:t(!0,!0),setStartAfter:t(!1,!0),setEndBefore:t(!0,!1),setEndAfter:t(!1,!1),collapse:function(t){C(this),t?u(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):u(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(t){m(t,!0),u(this,t,0,t,z(t))},selectNode:function(o){m(o,!1),p(o,j);var e=ce(o),t=me(o);u(this,e.node,e.offset,t.node,t.offset)},extractContents:S(d,u),deleteContents:S(o,u),canSurroundContents:function(){C(this),f(this.startContainer),f(this.endContainer);// Check if the contents can be surrounded. Specifically, this means whether the range partially selects
// no non-text nodes.
var t=new i(this,!0),e=t._first&&ie(t._first,this)||t._last&&ie(t._last,this);return t.detach(),!e},splitBoundaries:function(){w(this)},splitBoundariesPreservingPositions:function(t){w(this,t)},normalizeBoundaries:function(){C(this);var m=this.startContainer,p=this.startOffset,g=this.endContainer,f=this.endOffset,r=function(n){var e=n.nextSibling;e&&e.nodeType==n.nodeType&&(g=n,f=n.length,n.appendData(e.data),e.parentNode.removeChild(e))},a=function(e){var t=e.previousSibling;if(t&&t.nodeType==e.nodeType){m=e;var n=e.length;if(p=t.length,e.insertData(0,t.data),t.parentNode.removeChild(t),m==g)f+=p,g=m;else if(g==e.parentNode){var o=k(e);f==o?(g=e,f=n):f>o&&f--}}},s=!0;if(D(g))g.length==f&&r(g);else{if(0<f){var h=g.childNodes[f-1];h&&D(h)&&r(h)}s=!this.collapsed}if(!s)m=g,p=f;else if(D(m))0==p&&a(m);else if(p<m.childNodes.length){var i=m.childNodes[p];i&&D(i)&&a(i)}u(this,m,p,g,f)},collapseToPoint:function(n,e){m(n,!0),g(n,e),this.setStartAndEnd(n,e)}}),E(e)}/*----------------------------------------------------------------------------------------------------------------*/ // Updates commonAncestorContainer and collapsed after boundary change
function T(t){t.collapsed=t.startContainer===t.endContainer&&t.startOffset===t.endOffset,t.commonAncestorContainer=t.collapsed?t.startContainer:A.getCommonAncestor(t.startContainer,t.endContainer)}function R(r,e,t,n,o){r.startContainer=e,r.startOffset=t,r.endContainer=n,r.endOffset=o,r.document=A.getDocument(e),T(r)}function _(t){this.startContainer=t,this.startOffset=0,this.endContainer=t,this.endOffset=0,this.document=t,T(this)}var A=le.dom,O=le.util,L=A.DomPosition,I=le.DOMException,D=A.isCharacterDataNode,k=A.getNodeIndex,P=A.isOrIsAncestorOf,M=A.getDocument,B=A.comparePoints,H=A.splitDataNode,q=A.getClosestAncestorIn,z=A.getNodeLength,V=A.arrayContains,W=A.getRootContainer,U=le.features.crashyTextNodes;i.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){// Move to next node
var t=this._current=this._next;return t&&(this._next=t===this._last?null:t.nextSibling,D(t)&&this.clonePartiallySelectedTextNodes&&(t===this.ec&&(t=t.cloneNode(!0)).deleteData(this.eo,t.length-this.eo),this._current===this.sc&&(t=t.cloneNode(!0)).deleteData(0,this.so))),t},remove:function(){var o,a,r=this._current;D(r)&&(r===this.sc||r===this.ec)?(o=r===this.sc?this.so:0,a=r===this.ec?this.eo:r.length,o!=a&&r.deleteData(o,a-o)):r.parentNode&&r.parentNode.removeChild(r)},// Checks if the current node is partially selected
isPartiallySelectedSubtree:function(){var t=this._current;return ie(t,this.range)},getSubtreeIterator:function(){var n;if(this.isSingleCharacterDataNode)n=this.range.cloneRange(),n.collapse(!1);else{n=new _(de(this.range));var l=this._current,t=l,d=0,m=l,p=z(l);P(l,this.sc)&&(t=this.sc,d=this.so),P(l,this.ec)&&(m=this.ec,p=this.eo),R(n,t,d,m,p)}return new i(n,this.clonePartiallySelectedTextNodes)},detach:function(){this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};/*----------------------------------------------------------------------------------------------------------------*/var j=[1,3,4,5,7,8,10],F=[2,9,11],K=[1,3,4,5,7,8,10,11],G=[1,3,4,5,7,8],X=r([9,11]),Y=r([5,6,10,12]),$=r([6,10,12]),Q=document.createElement("style"),Z=!1;try{Q.innerHTML="<b>x</b>",Z=3==Q.firstChild.nodeType}catch(e){// IE 6 and 7 throw
}le.features.htmlParsingConforms=Z;var J=Z?// Implementation as per HTML parsing spec, trusting in the browser's implementation of innerHTML. See
// discussion and base code for this implementation at issue 67.
// Spec: http://html5.org/specs/dom-parsing.html#extensions-to-the-range-interface
// Thanks to Aleks Williams.
function(a){// "Let node the context object's start's node."
var e=this.startContainer,t=M(e);// "If the context object's start's node is null, raise an INVALID_STATE_ERR
// exception and abort these steps."
if(!e)throw new I("INVALID_STATE_ERR");// "Let element be as follows, depending on node's interface:"
// Document, Document Fragment: null
var n=null;// "Element: node"
// "If this raises an exception, then abort these steps. Otherwise, let new
// children be the nodes returned."
// "Let fragment be a new DocumentFragment."
// "Append all new children to fragment."
// "Return fragment."
return 1==e.nodeType?n=e:D(e)&&(n=A.parentElement(e)),n=null===n||"HTML"==n.nodeName&&A.isHtmlNamespace(M(n).documentElement)&&A.isHtmlNamespace(n)?t.createElement("body"):n.cloneNode(!1),n.innerHTML=a,A.fragmentFromNodeChildren(n)}:// In this case, innerHTML cannot be trusted, so fall back to a simpler, non-conformant implementation that
// previous versions of Rangy used (with the exception of using a body element rather than a div)
function(n){var e=de(this),t=e.createElement("body");return t.innerHTML=n,A.fragmentFromNodeChildren(t)},ee=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"];O.extend(le.rangePrototype,{compareBoundaryPoints:function(i,e){C(this),u(this.startContainer,e.startContainer);var t,d,m,p,g=3==i||i==0?"start":"end",n=1==i||i==0?"start":"end";return t=this[g+"Container"],d=this[g+"Offset"],m=e[n+"Container"],p=e[n+"Offset"],B(t,d,m,p)},insertNode:function(o){if(C(this),p(o,K),f(this.startContainer),P(o,this.startContainer))throw new I("HIERARCHY_REQUEST_ERR");// No check for whether the container of the start of the Range is of a type that does not allow
// children of the type of node: the browser's DOM implementation should do this for us when we attempt
// to add the node
var e=n(o,this.startContainer,this.startOffset);this.setStartBefore(e)},cloneContents:function(){C(this);var n,a;if(this.collapsed)return de(this).createDocumentFragment();if(this.startContainer===this.endContainer&&D(this.startContainer))return n=this.startContainer.cloneNode(!0),n.data=n.data.slice(this.startOffset,this.endOffset),a=de(this).createDocumentFragment(),a.appendChild(n),a;var r=new i(this,!0);return n=s(r),r.detach(),n},canSurroundContents:function(){C(this),f(this.startContainer),f(this.endContainer);// Check if the contents can be surrounded. Specifically, this means whether the range partially selects
// no non-text nodes.
var t=new i(this,!0),e=t._first&&ie(t._first,this)||t._last&&ie(t._last,this);return t.detach(),!e},surroundContents:function(o){if(p(o,G),!this.canSurroundContents())throw new I("INVALID_STATE_ERR");// Extract the contents
var e=this.extractContents();// Clear the children of the node
if(o.hasChildNodes())for(;o.lastChild;)o.removeChild(o.lastChild);// Insert the new node and add the extracted contents
n(o,this.startContainer,this.startOffset),o.appendChild(e),this.selectNode(o)},cloneRange:function(){C(this);for(var n,a=new _(de(this)),e=ee.length;e--;)n=ee[e],a[n]=this[n];return a},toString:function(){C(this);var o=this.startContainer;if(o===this.endContainer&&D(o))return 3==o.nodeType||4==o.nodeType?o.data.slice(this.startOffset,this.endOffset):"";var a=[],e=new i(this,!0);return pe(e,function(t){(3==t.nodeType||4==t.nodeType)&&a.push(t.data)}),e.detach(),a.join("")},// The methods below are all non-standard. The following batch were introduced by Mozilla but have since
// been removed from Mozilla.
compareNode:function(r){C(this);var e=r.parentNode,t=k(r);if(!e)throw new I("NOT_FOUND_ERR");var n=this.comparePoint(e,t),o=this.comparePoint(e,t+1);return 0>n?0<o?2:0:0<o?1:3},comparePoint:function(n,e){return(C(this),l(n,"HIERARCHY_REQUEST_ERR"),u(n,this.startContainer),0>B(n,e,this.startContainer,this.startOffset))?-1:0<B(n,e,this.endContainer,this.endOffset)?1:0},createContextualFragment:J,toHtml:function(){return N(this)},// touchingIsIntersecting determines whether this method considers a node that borders a range intersects
// with it (as in WebKit) or not (as in Gecko pre-1.9, and the default)
intersectsNode:function(n,e){if(C(this),l(n,"NOT_FOUND_ERR"),M(n)!==de(this))return!1;var t=n.parentNode,o=k(n);l(t,"NOT_FOUND_ERR");var a=B(t,o,this.endContainer,this.endOffset),r=B(t,o+1,this.startContainer,this.startOffset);return e?0>=a&&0<=r:0>a&&0<r},isPointInRange:function(n,e){return C(this),l(n,"HIERARCHY_REQUEST_ERR"),u(n,this.startContainer),0<=B(n,e,this.startContainer,this.startOffset)&&0>=B(n,e,this.endContainer,this.endOffset)},// The methods below are non-standard and invented by me.
// Sharing a boundary start-to-end or end-to-start does not count as intersection.
intersectsRange:function(n){return t(this,n,!1)},// Sharing a boundary start-to-end or end-to-start does count as intersection.
intersectsOrTouchesRange:function(n){return t(this,n,!0)},intersection:function(a){if(this.intersectsRange(a)){var e=B(this.startContainer,this.startOffset,a.startContainer,a.startOffset),t=B(this.endContainer,this.endOffset,a.endContainer,a.endOffset),n=this.cloneRange();return-1==e&&n.setStart(a.startContainer,a.startOffset),1==t&&n.setEnd(a.endContainer,a.endOffset),n}return null},union:function(n){if(this.intersectsOrTouchesRange(n)){var e=this.cloneRange();return-1==B(n.startContainer,n.startOffset,this.startContainer,this.startOffset)&&e.setStart(n.startContainer,n.startOffset),1==B(n.endContainer,n.endOffset,this.endContainer,this.endOffset)&&e.setEnd(n.endContainer,n.endOffset),e}throw new I("Ranges do not intersect")},containsNode:function(n,e){return e?this.intersectsNode(n,!1):this.compareNode(n)==3},containsNodeContents:function(t){return 0<=this.comparePoint(t,0)&&0>=this.comparePoint(t,z(t))},containsRange:function(n){var e=this.intersection(n);return null!==e&&n.equals(e)},containsNodeText:function(a){var e=this.cloneRange();e.selectNode(a);var t=e.getNodes([3]);if(0<t.length){e.setStart(t[0],0);var n=t.pop();return e.setEnd(n,n.length),this.containsRange(e)}return this.containsNodeContents(a)},getNodes:function(n,e){return C(this),a(this,n,e)},getDocument:function e(){return de(this)},collapseBefore:function(t){this.setEndBefore(t),this.collapse(!1)},collapseAfter:function(t){this.setStartAfter(t),this.collapse(!0)},getBookmark:function(e){var n=de(this),o=le.createRange(n);e=e||A.getBody(n),o.selectNodeContents(e);var a=this.intersection(o),r=0,i=0;return a&&(o.setEnd(a.startContainer,a.startOffset),r=o.toString().length,i=r+a.toString().length),{start:r,end:i,containerNode:e}},moveToBookmark:function(i){var e=i.containerNode,t=0;this.setStart(e,0),this.collapse(!0);for(var p,g,u,f,h=[e],o=!1,y=!1;!y&&(p=h.pop());)if(3==p.nodeType)g=t+p.length,!o&&i.start>=t&&i.start<=g&&(this.setStart(p,i.start-t),o=!0),o&&i.end>=t&&i.end<=g&&(this.setEnd(p,i.end-t),y=!0),t=g;else for(f=p.childNodes,u=f.length;u--;)h.push(f[u])},getName:function(){return"DomRange"},equals:function(t){return _.rangesEqual(this,t)},isValid:function(){return b(this)},inspect:function(){return e(this)},detach:function(){// In DOM4, detach() is now a no-op.
}}),v(_,R),O.extend(_,{rangeProperties:ee,RangeIterator:i,copyComparisonConstants:E,createPrototypeRange:v,inspect:e,toHtml:N,getRangeDocument:de,rangesEqual:function(n,e){return n.startContainer===e.startContainer&&n.startOffset===e.startOffset&&n.endContainer===e.endContainer&&n.endOffset===e.endOffset}}),le.DomRange=_}),N.createCoreModule("WrappedRange",["DomRange"],function(C,b){var e,t,R=C.dom,n=C.util,_=R.DomPosition,w=C.DomRange,N=R.getBody,o=R.getContentDocument,A=R.isCharacterDataNode;if(C.features.implementsDomRange&&function(){function r(o){for(var e,a=s.length;a--;)e=s[a],o[e]=o.nativeRange[e];// Fix for broken collapsed property in IE 9.
o.collapsed=o.startContainer===o.endContainer&&o.startOffset===o.endOffset}var t,a,s=w.rangeProperties;e=function(t){if(!t)throw b.createError("WrappedRange: Range must be specified");this.nativeRange=t,r(this)},w.createPrototypeRange(e,function(i,e,t,n,o){var a=i.startContainer!==e||i.startOffset!=t,r=i.endContainer!==n||i.endOffset!=o,s=!i.equals(i.nativeRange);(a||r||s)&&(i.setEnd(n,o),i.setStart(e,t))}),t=e.prototype,t.selectNode=function(t){this.nativeRange.selectNode(t),r(this)},t.cloneContents=function(){return this.nativeRange.cloneContents()},t.surroundContents=function(t){this.nativeRange.surroundContents(t),r(this)},t.collapse=function(t){this.nativeRange.collapse(t),r(this)},t.cloneRange=function(){return new e(this.nativeRange.cloneRange())},t.refresh=function(){r(this)},t.toString=function(){return this.nativeRange.toString()};// Create test range and node for feature detection
var l=document.createTextNode("test");N(document).appendChild(l);var d=document.createRange();/*--------------------------------------------------------------------------------------------------------*/ // Test for Firefox 2 bug that prevents moving the start of a Range to a point after its current end and
// correct for it
d.setStart(l,0),d.setEnd(l,0);try{d.setStart(l,1),t.setStart=function(n,e){this.nativeRange.setStart(n,e),r(this)},t.setEnd=function(n,e){this.nativeRange.setEnd(n,e),r(this)},a=function(n){return function(e){this.nativeRange[n](e),r(this)}}}catch(n){t.setStart=function(o,e){try{this.nativeRange.setStart(o,e)}catch(t){this.nativeRange.setEnd(o,e),this.nativeRange.setStart(o,e)}r(this)},t.setEnd=function(o,e){try{this.nativeRange.setEnd(o,e)}catch(t){this.nativeRange.setStart(o,e),this.nativeRange.setEnd(o,e)}r(this)},a=function(a,e){return function(t){try{this.nativeRange[a](t)}catch(n){this.nativeRange[e](t),this.nativeRange[a](t)}r(this)}}}t.setStartBefore=a("setStartBefore","setEndBefore"),t.setStartAfter=a("setStartAfter","setEndAfter"),t.setEndBefore=a("setEndBefore","setStartBefore"),t.setEndAfter=a("setEndAfter","setStartAfter"),t.selectNodeContents=function(t){this.setStartAndEnd(t,0,R.getNodeLength(t))},d.selectNodeContents(l),d.setEnd(l,3);var m=document.createRange();m.selectNodeContents(l),m.setEnd(l,4),m.setStart(l,2),t.compareBoundaryPoints=-1==d.compareBoundaryPoints(d.START_TO_END,m)&&1==d.compareBoundaryPoints(d.END_TO_START,m)?function(n,o){return o=o.nativeRange||o,n==o.START_TO_END?n=o.END_TO_START:n==o.END_TO_START&&(n=o.START_TO_END),this.nativeRange.compareBoundaryPoints(n,o)}:function(n,e){return this.nativeRange.compareBoundaryPoints(n,e.nativeRange||e)};/*--------------------------------------------------------------------------------------------------------*/ // Test for IE 9 deleteContents() and extractContents() bug and correct it. See issue 107.
var u=document.createElement("div");u.innerHTML="123";var f=u.firstChild,i=N(document);i.appendChild(u),d.setStart(f,1),d.setEnd(f,2),d.deleteContents(),"13"==f.data&&(t.deleteContents=function(){this.nativeRange.deleteContents(),r(this)},t.extractContents=function(){var t=this.nativeRange.extractContents();return r(this),t}),i.removeChild(u),i=null,n.isHostMethod(d,"createContextualFragment")&&(t.createContextualFragment=function(t){return this.nativeRange.createContextualFragment(t)}),N(document).removeChild(l),t.getName=function(){return"WrappedRange"},C.WrappedRange=e,C.createNativeRange=function(t){return t=o(t,b,"createNativeRange"),t.createRange()}}(),C.features.implementsTextRange){/*
            This is a workaround for a bug where IE returns the wrong container element from the TextRange's parentElement()
            method. For example, in the following (where pipes denote the selection boundaries):

            <ul id="ul"><li id="a">| a </li><li id="b"> b |</li></ul>

            var range = document.selection.createRange();
            alert(range.parentElement().id); // Should alert "ul" but alerts "b"

            This method returns the common ancestor node of the following:
            - the parentElement() of the textRange
            - the parentElement() of the textRange after calling collapse(true)
            - the parentElement() of the textRange after calling collapse(false)
            */var a=function(n){var e=n.parentElement(),t=n.duplicate();t.collapse(!0);var l=t.parentElement();t=n.duplicate(),t.collapse(!1);var a=t.parentElement(),r=l==a?l:R.getCommonAncestor(l,a);return r==e?r:R.getCommonAncestor(e,r)},r=function(t){return 0==t.compareEndPoints("StartToEnd",t)},s=function(n,e,t,o,a){var r=Math.floor,s=n.duplicate();s.collapse(t);var l=s.parentElement();// Sometimes collapsing a TextRange that's at the start of a text node can move it into the previous node, so
// check for that
// Deal with nodes that cannot "contain rich HTML markup". In practice, this means form inputs, images and
// similar. See http://msdn.microsoft.com/en-us/library/aa703950%28VS.85%29.aspx
if(R.isOrIsAncestorOf(e,l)||(l=e),!l.canHaveHTML){var i=new _(l.parentNode,R.getNodeIndex(l));return{boundaryPosition:i,nodeInfo:{nodeIndex:i.offset,containerElement:i.node}}}var d=R.getDocument(l).createElement("span");// Workaround for HTML5 Shiv's insane violation of document.createElement(). See Rangy issue 104 and HTML5
// Shiv issue 64: https://github.com/aFarkas/html5shiv/issues/64
d.parentNode&&d.parentNode.removeChild(d);for(var p,g,O,L,I,D=t?"StartToStart":"StartToEnd",u=a&&a.containerElement==l?a.nodeIndex:0,k=l.childNodes.length,h=k,P=h;P==k?l.appendChild(d):l.insertBefore(d,l.childNodes[P]),s.moveToElementText(d),p=s.compareEndPoints(D,n),0!=p&&u!=h;){if(-1!=p)h=h==u+1?u:P;else if(h==u+1)// We know the endth child node is after the range boundary, so we must be done.
break;else u=P;P=r((u+h)/2),l.removeChild(d)}// We've now reached or gone past the boundary of the text range we're interested in
// so have identified the node we want
if(I=d.nextSibling,-1==p&&I&&A(I)){s.setEndPoint(t?"EndToStart":"EndToEnd",n);var M;if(/[\r\n]/.test(I.data)){/*
                        For the particular case of a boundary within a text node containing rendered line breaks (within a
                        <pre> element, for example), we need a slightly complicated approach to get the boundary's offset in
                        IE. The facts:
                        
                        - Each line break is represented as \r in the text node's data/nodeValue properties
                        - Each line break is represented as \r\n in the TextRange's 'text' property
                        - The 'text' property of the TextRange does not contain trailing line breaks
                        
                        To get round the problem presented by the final fact above, we can use the fact that TextRange's
                        moveStart() and moveEnd() methods return the actual number of characters moved, which is not
                        necessarily the same as the number of characters it was instructed to move. The simplest approach is
                        to use this to store the characters moved when moving both the start and end of the range to the
                        start of the document body and subtracting the start offset from the end offset (the
                        "move-negative-gazillion" method). However, this is extremely slow when the document is large and
                        the range is near the end of it. Clearly doing the mirror image (i.e. moving the range boundaries to
                        the end of the document) has the same problem.
                        
                        Another approach that works is to use moveStart() to move the start boundary of the range up to the
                        end boundary one character at a time and incrementing a counter with the value returned by the
                        moveStart() call. However, the check for whether the start boundary has reached the end boundary is
                        expensive, so this method is slow (although unlike "move-negative-gazillion" is largely unaffected
                        by the location of the range within the document).
                        
                        The approach used below is a hybrid of the two methods above. It uses the fact that a string
                        containing the TextRange's 'text' property with each \r\n converted to a single \r character cannot
                        be longer than the text of the TextRange, so the start of the range is moved that length initially
                        and then a character at a time to make up for any trailing line breaks not contained in the 'text'
                        property. This has good performance in most situations compared to the previous two methods.
                        */var B=s.duplicate(),v=B.text.replace(/\r\n/g,"\r").length;for(M=B.moveStart("character",v);-1==(p=B.compareEndPoints("StartToEnd",B));)M++,B.moveStart("character",1)}else M=s.text.length;L=new _(I,M)}else// If the boundary immediately follows a character data node and this is the end boundary, we should favour
// a position within that, and likewise for a start boundary preceding a character data node
g=(o||!t)&&d.previousSibling,O=(o||t)&&d.nextSibling,L=O&&A(O)?new _(O,0):g&&A(g)?new _(g,g.data.length):new _(l,R.getNodeIndex(d));// Clean up
return d.parentNode.removeChild(d),{boundaryPosition:L,nodeInfo:{nodeIndex:P,containerElement:l}}},l=function(n,e){var t,s,i,u,f=n.offset,o=R.getDocument(n.node),a=N(o).createTextRange(),r=A(n.node);return r?(t=n.node,s=t.parentNode):(u=n.node.childNodes,t=f<u.length?u[f]:null,s=n.node),i=o.createElement("span"),i.innerHTML="&#feff;",t?s.insertBefore(i,t):s.appendChild(i),a.moveToElementText(i),a.collapse(!e),s.removeChild(i),r&&a[e?"moveStart":"moveEnd"]("character",f),a};t=function(t){this.textRange=t,this.refresh()},t.prototype=new w(document),t.prototype.refresh=function(){var l,i,d,m=a(this.textRange);// TextRange's parentElement() method cannot be trusted. getTextRangeContainerElement() works around that.
r(this.textRange)?i=l=s(this.textRange,m,!0,!0).boundaryPosition:(d=s(this.textRange,m,!0,!1),l=d.boundaryPosition,i=s(this.textRange,m,!1,!1,d.nodeInfo).boundaryPosition),this.setStart(l.node,l.offset),this.setEnd(i.node,i.offset)},t.prototype.getName=function(){return"WrappedTextRange"},w.copyComparisonConstants(t);var i=function(a){if(a.collapsed)return l(new _(a.startContainer,a.startOffset),!0);var e=l(new _(a.startContainer,a.startOffset),!0),t=l(new _(a.endContainer,a.endOffset),!1),n=N(w.getRangeDocument(a)).createTextRange();return n.setEndPoint("StartToStart",e),n.setEndPoint("EndToEnd",t),n};// IE 9 and above have both implementations and Rangy makes both available. The next few lines sets which
// implementation to use by default.
if(t.rangeToTextRange=i,t.prototype.toTextRange=function(){return i(this)},C.WrappedTextRange=t,!C.features.implementsDomRange||C.config.preferTextRange){// Add WrappedTextRange as the Range property of the global object to allow expression like Range.END_TO_END to work
var p=function(){return this}();"undefined"==typeof p.Range&&(p.Range=t),C.createNativeRange=function(t){return t=o(t,b,"createNativeRange"),N(t).createTextRange()},C.WrappedRange=t}}C.createRange=function(e){return e=o(e,b,"createRange"),new C.WrappedRange(C.createNativeRange(e))},C.createRangyRange=function(t){return t=o(t,b,"createRangyRange"),new w(t)},C.createIframeRange=function(e){return b.deprecationNotice("createIframeRange()","createRange(iframeEl)"),C.createRange(e)},C.createIframeRangyRange=function(e){return b.deprecationNotice("createIframeRangyRange()","createRangyRange(iframeEl)"),C.createRangyRange(e)},C.addShimListener(function(e){var o=e.document;"undefined"==typeof o.createRange&&(o.createRange=function(){return C.createRange(o)}),o=e=null})}),N.createCoreModule("WrappedSelection",["DomRange","WrappedRange"],function(i,v){// Utility function to support direction parameters in the API that may be a string ("backward" or "forward") or a
// Boolean (true for backwards).
function D(t){return"string"==typeof t?/^backward(s)?$/i.test(t):!!t}function ie(t,e){if(!t)return window;if(x.isWindow(t))return t;if(t instanceof u)return t.win;var n=x.getContentDocument(t,v,e);return x.getWindow(n)}function o(t){return ie(t,"getDocSelection").document.selection}function e(n){var e=!1;return n.anchorNode&&(e=1==x.comparePoints(n.anchorNode,n.anchorOffset,n.focusNode,n.focusOffset)),e}// Test for the Range/TextRange and Selection features required
// Test for ability to retrieve selection
function de(r,e,t){var n=t?"end":"start",o=t?"start":"end";r.anchorNode=e[n+"Container"],r.anchorOffset=e[n+"Offset"],r.focusNode=e[o+"Container"],r.focusOffset=e[o+"Offset"]}function a(n){var e=n.nativeSelection;n.anchorNode=e.anchorNode,n.anchorOffset=e.anchorOffset,n.focusNode=e.focusNode,n.focusOffset=e.focusOffset}function s(t){t.anchorNode=t.focusNode=null,t.anchorOffset=t.focusOffset=0,t.rangeCount=0,t.isCollapsed=!0,t._ranges.length=0}function l(e){var t;return e instanceof T?(t=i.createNativeRange(e.getDocument()),t.setEnd(e.endContainer,e.endOffset),t.setStart(e.startContainer,e.startOffset)):e instanceof R?t=e.nativeRange:O.implementsDomRange&&e instanceof x.getWindow(e.startContainer).Range&&(t=e),t}function t(o){if(!o.length||1!=o[0].nodeType)return!1;for(var e=1,a=o.length;e<a;++e)if(!x.isAncestorOf(o[0],o[e]))return!1;return!0}function m(o){var e=o.getNodes();if(!t(e))throw v.createError("getSingleElementFromRange: range "+o.inspect()+" did not consist of a single element");return e[0]}// Simple, quick test which only needs to distinguish between a TextRange and a ControlRange
function d(t){return!!t&&"undefined"!=typeof t.text}function p(o,e){// Create a Range from the selected TextRange
var t=new R(e);o._ranges=[t],de(o,t,!1),o.rangeCount=1,o.isCollapsed=t.collapsed}function g(e){if(e._ranges.length=0,"None"==e.docSelection.type)s(e);else{var t=e.docSelection.createRange();if(d(t))p(e,t);else{e.rangeCount=t.length;for(var n,l=L(t.item(0)),o=0;o<e.rangeCount;++o)n=i.createRange(l),n.selectNode(t.item(o)),e._ranges.push(n);e.isCollapsed=1==e.rangeCount&&e._ranges[0].collapsed,de(e,e._ranges[e.rangeCount-1],!1)}}}function n(t,e){for(var n=t.docSelection.createRange(),o=m(e),a=L(n.item(0)),r=I(a).createControlRange(),s=0,i=n.length;s<i;++s)r.add(n.item(s));try{r.add(o)}catch(t){throw v.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}r.select(),g(t)}function u(o,e,t){this.nativeSelection=o,this.docSelection=e,this._ranges=[],this.win=t,this.refresh()}function r(t){t.win=t.anchorNode=t.focusNode=t._ranges=null,t.rangeCount=t.anchorOffset=t.focusOffset=0,t.detached=!0}function f(s,e){for(var t,l,i=pe.length;i--;)if(t=pe[i],l=t.selection,"deleteAll"==e)r(l);else if(t.win==s)return"delete"==e?(pe.splice(i,1),!0):l;return"deleteAll"==e&&(pe.length=0),null}function h(t,e){// Ensure that the selection becomes of type "Control"
for(var n,i=L(e[0].startContainer),o=I(i).createControlRange(),a=0,d=e.length;a<d;++a){n=m(e[a]);try{o.add(n)}catch(t){throw v.createError("setRanges(): Element within one of the specified Ranges could not be added to control selection (does it have layout?)")}}o.select(),g(t)}// Selecting a range
function y(n,e){if(n.win.document!=L(e))throw new _("WRONG_DOCUMENT_ERR")}// No current browser conforms fully to the spec for this method, so Rangy's own method is always used
function b(e){return function(t,n){var o;this.rangeCount?(o=this.getRangeAt(0),o["set"+(e?"Start":"End")](t,n)):(o=i.createRange(this.win.document),o.setStartAndEnd(t,n)),this.setSingleRange(o,this.isBackward())}}function C(l){var e=[],t=new A(l.anchorNode,l.anchorOffset),n=new A(l.focusNode,l.focusOffset),o="function"==typeof l.getName?l.getName():"Selection";if("undefined"!=typeof l.rangeCount)for(var a=0,i=l.rangeCount;a<i;++a)e[a]=T.inspect(l.getRangeAt(a));return"["+o+"(Ranges: "+e.join(", ")+")(anchor: "+t.inspect()+", focus: "+n.inspect()+"]"}i.config.checkSelectionRanges=!0;var w,N,x=i.dom,E=i.util,S=E.isHostMethod,T=i.DomRange,R=i.WrappedRange,_=i.DOMException,A=x.DomPosition,O=i.features,L=x.getDocument,I=x.getBody,k=T.rangesEqual,P=S(window,"getSelection"),M=E.isHostObject(document,"selection");O.implementsWinGetSelection=P,O.implementsDocSelection=M;var B=M&&(!P||i.config.preferTextRange);B?(w=o,i.isSelectionValid=function(o){var e=ie(o,"isSelectionValid").document,t=e.selection;// Check whether the selection TextRange is actually contained within the correct document
return"None"!=t.type||L(t.createRange().parentElement())==e}):P?(w=function(t){return ie(t,"getWinSelection").getSelection()},i.isSelectionValid=function(){return!0}):v.fail("Neither document.selection or window.getSelection() detected."),i.getNativeSelection=w;var H=w(),q=i.createNativeRange(document),W=I(document),U=E.areHostProperties(H,["anchorNode","focusNode","anchorOffset","focusOffset"]);O.selectionHasAnchorAndFocus=U;// Test for existence of native selection extend() method
var j=S(H,"extend");O.selectionHasExtend=j;// Test if rangeCount exists
var F=typeof H.rangeCount=="number";O.selectionHasRangeCount=F;var K=!1,G=!0,X=j?function(e,t){var n=T.getRangeDocument(t),o=i.createRange(n);o.collapseToPoint(t.endContainer,t.endOffset),e.addRange(l(o)),e.extend(t.startContainer,t.startOffset)}:null;E.areHostMethods(H,["addRange","getRangeAt","removeAllRanges"])&&typeof H.rangeCount=="number"&&O.implementsDomRange&&function(){// Previously an iframe was used but this caused problems in some circumstances in IE, so tests are
// performed on the current document's selection. See issue 109.
// Note also that if a selection previously existed, it is wiped by these tests. This should usually be fine
// because initialization usually happens when the document loads, but could be a problem for a script that
// loads and initializes Rangy later. If anyone complains, code could be added to save and restore the
// selection.
var r=window.getSelection();if(r){// Store the current selection
for(var t=r.rangeCount,n=1<t,o=[],a=e(r),s=0;s<t;++s)o[s]=r.getRangeAt(s);// Create some test elements
var h=I(document),d=h.appendChild(document.createElement("div"));d.contentEditable="false";var m=d.appendChild(document.createTextNode("\xA0\xA0\xA0")),p=document.createRange();// Test whether the native selection will allow a collapsed selection within a non-editable element
// Test whether the native selection is capable of supporting multiple ranges.
if(p.setStart(m,1),p.collapse(!0),r.addRange(p),G=1==r.rangeCount,r.removeAllRanges(),!n){// Doing the original feature test here in Chrome 36 (and presumably later versions) prints a
// console error of "Discontiguous selection is not supported." that cannot be suppressed. There's
// nothing we can do about this while retaining the feature test so we have to resort to a browser
// sniff. I'm not happy about it. See
// https://code.google.com/p/chromium/issues/detail?id=399791
var g=window.navigator.appVersion.match(/Chrome\/(.*?) /);if(g&&36<=parseInt(g[1]))K=!1;else{var u=p.cloneRange();p.setStart(m,0),u.setEnd(m,3),u.setStart(m,2),r.addRange(p),r.addRange(u),K=2==r.rangeCount}}// Clean up
for(h.removeChild(d),r.removeAllRanges(),s=0;s<t;++s)0==s&&a?X?X(r,o[s]):(i.warn("Rangy initialization: original selection was backwards but selection has been restored forwards because the browser does not support Selection.extend"),r.addRange(o[s])):r.addRange(o[s])}}(),O.selectionSupportsMultipleRanges=K,O.collapsedNonEditableSelectionsSupported=G;// ControlRanges
var Q,ce=!1;W&&S(W,"createControlRange")&&(Q=W.createControlRange(),E.areHostProperties(Q,["item","add"])&&(ce=!0)),O.implementsControlRange=ce,N=U?function(t){return t.anchorNode===t.focusNode&&t.anchorOffset===t.focusOffset}:function(t){return!!t.rangeCount&&t.getRangeAt(t.rangeCount-1).collapsed};var me;S(H,"getRangeAt")?me=function(n,e){try{return n.getRangeAt(e)}catch(t){return null}}:U&&(me=function(e){var t=L(e.anchorNode),n=i.createRange(t);return n.setStartAndEnd(e.anchorNode,e.anchorOffset,e.focusNode,e.focusOffset),n.collapsed!==this.isCollapsed&&n.setStartAndEnd(e.focusNode,e.focusOffset,e.anchorNode,e.anchorOffset),n}),u.prototype=i.selectionPrototype;var pe=[],te=function(a){// Check if the parameter is a Rangy Selection object
if(a&&a instanceof u)return a.refresh(),a;a=ie(a,"getNativeSelection");var s=f(a),l=w(a),n=M?o(a):null;return s?(s.nativeSelection=l,s.docSelection=n,s.refresh()):(s=new u(l,n,a),pe.push({win:a,selection:s})),s};i.getSelection=te,i.getIframeSelection=function(e){return v.deprecationNotice("getIframeSelection()","getSelection(iframeEl)"),i.getSelection(x.getIframeWindow(e))};var ne=u.prototype;if(!B&&U&&E.areHostMethods(H,["removeAllRanges","addRange"])){ne.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),s(this)};var oe=function(n,e){X(n.nativeSelection,e),n.refresh()};ne.addRange=F?function(e,s){if(ce&&M&&this.docSelection.type=="Control")n(this,e);else if(D(s)&&j)oe(this,e);else{var o;if(K?o=this.rangeCount:(this.removeAllRanges(),o=0),this.nativeSelection.addRange(l(e).cloneRange()),this.rangeCount=this.nativeSelection.rangeCount,this.rangeCount==o+1){// The range was added successfully
// Check whether the range that we added to the selection is reflected in the last range extracted from
// the selection
if(i.config.checkSelectionRanges){var d=me(this.nativeSelection,this.rangeCount-1);d&&!k(d,e)&&(e=new R(d))}this._ranges[this.rangeCount-1]=e,de(this,e,se(this.nativeSelection)),this.isCollapsed=N(this)}else// The range was not added successfully. The simplest thing is to refresh
this.refresh()}}:function(n,e){D(e)&&j?oe(this,n):(this.nativeSelection.addRange(l(n)),this.refresh())},ne.setRanges=function(o){if(ce&&M&&1<o.length)h(this,o);else{this.removeAllRanges();for(var e=0,a=o.length;e<a;++e)this.addRange(o[e])}}}else if(S(H,"empty")&&S(q,"select")&&ce&&B)ne.removeAllRanges=function(){// Added try/catch as fix for issue #21
try{// Check for empty() not working (issue #24)
if(this.docSelection.empty(),"None"!=this.docSelection.type){// Work around failure to empty a control selection by instead selecting a TextRange and then
// calling empty()
var o;if(this.anchorNode)o=L(this.anchorNode);else if(this.docSelection.type=="Control"){var a=this.docSelection.createRange();a.length&&(o=L(a.item(0)))}if(o){var t=I(o).createTextRange();t.select(),this.docSelection.empty()}}}catch(t){}s(this)},ne.addRange=function(e){this.docSelection.type=="Control"?n(this,e):(i.WrappedTextRange.rangeToTextRange(e).select(),this._ranges[0]=e,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,de(this,e,!1))},ne.setRanges=function(n){this.removeAllRanges();var e=n.length;1<e?h(this,n):e&&this.addRange(n[0])};else return v.fail("No means of selecting a Range or TextRange was found"),!1;ne.getRangeAt=function(t){if(0>t||t>=this.rangeCount)throw new _("INDEX_SIZE_ERR");else// Clone the range to preserve selection-range independence. See issue 80.
return this._ranges[t].cloneRange()};var ae;if(B)ae=function(e){var t;i.isSelectionValid(e.win)?t=e.docSelection.createRange():(t=I(e.win.document).createTextRange(),t.collapse(!0)),e.docSelection.type=="Control"?g(e):d(t)?p(e,t):s(e)};else if(S(H,"getRangeAt")&&typeof H.rangeCount=="number")ae=function(e){if(ce&&M&&e.docSelection.type=="Control")g(e);else if(e._ranges.length=e.rangeCount=e.nativeSelection.rangeCount,e.rangeCount){for(var t=0,a=e.rangeCount;t<a;++t)e._ranges[t]=new i.WrappedRange(e.nativeSelection.getRangeAt(t));de(e,e._ranges[e.rangeCount-1],se(e.nativeSelection)),e.isCollapsed=N(e)}else s(e)};else if(U&&"boolean"==typeof H.isCollapsed&&"boolean"==typeof q.collapsed&&O.implementsDomRange)ae=function(o){var e,r=o.nativeSelection;r.anchorNode?(e=me(r,0),o._ranges=[e],o.rangeCount=1,a(o),o.isCollapsed=N(o)):s(o)};else return v.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;ne.refresh=function(r){var e=r?this._ranges.slice(0):null,t=this.anchorNode,n=this.anchorOffset;if(ae(this),r){// Check the range count first
var o=e.length;if(o!=this._ranges.length)return!0;// Now check the direction. Checking the anchor position is the same is enough since we're checking all the
// ranges after this
if(this.anchorNode!=t||this.anchorOffset!=n)return!0;// Finally, compare each range in turn
for(;o--;)if(!k(e[o],this._ranges[o]))return!0;return!1}};// Removal of a single range
var ge=function(r,e){var t=r.getAllRanges();r.removeAllRanges();for(var n=0,l=t.length;n<l;++n)k(e,t[n])||r.addRange(t[n]);r.rangeCount||s(r)};ne.removeRange=ce&&M?function(i){if(this.docSelection.type=="Control"){for(var e,p=this.docSelection.createRange(),t=m(i),n=L(p.item(0)),o=I(n).createControlRange(),a=!1,u=0,f=p.length;u<f;++u)e=p.item(u),e!==t||a?o.add(p.item(u)):a=!0;o.select(),g(this)}else ge(this,i)}:function(t){ge(this,t)};// Detecting if a selection is backward
var se;!B&&U&&O.implementsDomRange?(se=e,ne.isBackward=function(){return se(this)}):se=ne.isBackward=function(){return!1},ne.isBackwards=ne.isBackward,ne.toString=function(){for(var o=[],e=0,a=this.rangeCount;e<a;++e)o[e]=""+this._ranges[e];return o.join("")},ne.collapse=function(e,t){y(this,e);var n=i.createRange(e);n.collapseToPoint(e,t),this.setSingleRange(n),this.isCollapsed=!0},ne.collapseToStart=function(){if(this.rangeCount){var t=this._ranges[0];this.collapse(t.startContainer,t.startOffset)}else throw new _("INVALID_STATE_ERR")},ne.collapseToEnd=function(){if(this.rangeCount){var t=this._ranges[this.rangeCount-1];this.collapse(t.endContainer,t.endOffset)}else throw new _("INVALID_STATE_ERR")},ne.selectAllChildren=function(e){y(this,e);var t=i.createRange(e);t.selectNodeContents(e),this.setSingleRange(t)},ne.deleteFromDocument=function(){// Sepcial behaviour required for IE's control selections
if(ce&&M&&this.docSelection.type=="Control"){for(var r,s=this.docSelection.createRange();s.length;)r=s.item(0),s.remove(r),r.parentNode.removeChild(r);this.refresh()}else if(this.rangeCount){var e=this.getAllRanges();if(e.length){this.removeAllRanges();for(var n=0,l=e.length;n<l;++n)e[n].deleteContents();// The spec says nothing about what the selection should contain after calling deleteContents on each
// range. Firefox moves the selection to where the final selected range was, so we emulate that
this.addRange(e[l-1])}}},ne.eachRange=function(a,e){for(var t=0,r=this._ranges.length;t<r;++t)if(a(this.getRangeAt(t)))return e},ne.getAllRanges=function(){var n=[];return this.eachRange(function(e){n.push(e)}),n},ne.setSingleRange=function(n,e){this.removeAllRanges(),this.addRange(n,e)},ne.callMethodOnEachRange=function(a,e){var t=[];return this.eachRange(function(n){t.push(n[a].apply(n,e))}),t},ne.setStart=b(!0),ne.setEnd=b(!1),i.rangePrototype.select=function(t){te(this.getDocument()).setSingleRange(this,t)},ne.changeEachRange=function(o){var e=[],t=this.isBackward();this.eachRange(function(t){o(t),e.push(t)}),this.removeAllRanges(),t&&1==e.length?this.addRange(e[0],"backward"):this.setRanges(e)},ne.containsNode=function(o,e){return this.eachRange(function(t){return t.containsNode(o,e)},!0)||!1},ne.getBookmark=function(t){return{backward:this.isBackward(),rangeBookmarks:this.callMethodOnEachRange("getBookmark",[t])}},ne.moveToBookmark=function(e){for(var t,s,l=[],n=0;t=e.rangeBookmarks[n++];)s=i.createRange(this.win),s.moveToBookmark(t),l.push(s);e.backward?this.setSingleRange(l[0],"backward"):this.setRanges(l)},ne.toHtml=function(){var n=[];return this.eachRange(function(e){n.push(T.toHtml(e))}),n.join("")},O.implementsTextRange&&(ne.getNativeTextRange=function(){var e;if(e=this.docSelection){var t=e.createRange();if(d(t))return t;throw v.createError("getNativeTextRange: selection is a control selection")}else{if(0<this.rangeCount)return i.WrappedTextRange.rangeToTextRange(this.getRangeAt(0));throw v.createError("getNativeTextRange: selection contains no range")}}),ne.getName=function(){return"WrappedSelection"},ne.inspect=function(){return C(this)},ne.detach=function(){f(this.win,"delete"),r(this)},u.detachAll=function(){f(null,"deleteAll")},u.inspect=C,u.isDirectionBackward=D,i.Selection=u,i.selectionPrototype=ne,i.addShimListener(function(t){"undefined"==typeof t.getSelection&&(t.getSelection=function(){return te(t)}),t=null})}),N)},this),function(n,e){"function"==typeof define&&define.amd?define(["rangy"],n):n(e.rangy)}(function(t){t.createModule("SaveRestore",["WrappedRange"],function(g,u){function f(n,e){return(e||document).getElementById(n)}function e(s,e){var t,l="selectionBoundary_"+ +new Date+"_"+(""+Math.random()).slice(2),n=d.getDocument(s.startContainer),o=s.cloneRange();return o.collapse(e),t=n.createElement("span"),t.id=l,t.style.lineHeight="0",t.style.display="none",t.className="rangySelectionBoundary",t.appendChild(n.createTextNode("\uFEFF")),o.insertNode(t),t}function t(t,e,n,o){var a=f(n,t);a?(e[o?"setStartBefore":"setEndBefore"](a),a.parentNode.removeChild(a)):u.warn("Marker element has been removed. Cannot restore selection.")}function n(n,e){return e.compareBoundaryPoints(n.START_TO_START,n)}function r(o,t){var n,i,d=g.DomRange.getRangeDocument(o),a=o.toString();return o.collapsed?(i=e(o,!1),{document:d,markerId:i.id,collapsed:!0}):(i=e(o,!1),n=e(o,!0),{document:d,startMarkerId:n.id,endMarkerId:i.id,collapsed:!1,backward:t,toString:function(){return"original text: '"+a+"', new text: '"+o.toString()+"'"}})}function a(e,n){var o=e.document;"undefined"==typeof n&&(n=!0);var a=g.createRange(o);if(e.collapsed){var s=f(e.markerId,o);if(s){s.style.display="inline";var l=s.previousSibling;// Workaround for issue 17
l&&3==l.nodeType?(s.parentNode.removeChild(s),a.collapseToPoint(l,l.length)):(a.collapseBefore(s),s.parentNode.removeChild(s))}else u.warn("Marker element has been removed. Cannot restore selection.")}else t(o,a,e.startMarkerId,!0),t(o,a,e.endMarkerId,!1);return n&&a.normalizeBoundaries(),a}function l(e,s){var o,i,u=[];// Order the ranges by position within the DOM, latest first, cloning the array to leave the original untouched
e=e.slice(0),e.sort(n);for(var a=0,h=e.length;a<h;++a)u[a]=r(e[a],s);// Now that all the markers are in place and DOM manipulation over, adjust each range's boundaries to lie
// between its markers
for(a=h-1;0<=a;--a)o=e[a],i=g.DomRange.getRangeDocument(o),o.collapsed?o.collapseAfter(f(u[a].markerId,i)):(o.setEndBefore(f(u[a].endMarkerId,i)),o.setStartAfter(f(u[a].startMarkerId,i)));return u}function i(r){for(var e=[],t=r.length,n=t-1;0<=n;n--)e[n]=a(r[n],!0);return e}function s(n,e){var t=f(e,n);t&&t.parentNode.removeChild(t)}var d=g.dom;g.util.extend(g,{saveRange:r,restoreRange:a,saveRanges:l,restoreRanges:i,saveSelection:function r(e){if(!g.isSelectionValid(e))return u.warn("Cannot save selection. This usually happens when the selection is collapsed and the selection document has lost focus."),null;var t=g.getSelection(e),n=t.getAllRanges(),o=1==n.length&&t.isBackward(),a=l(n,o);return o?t.setSingleRange(n[0],"backward"):t.setRanges(n),{win:e,rangeInfos:a,restored:!1}},restoreSelection:function s(e,t){if(!e.restored){var n=e.rangeInfos,o=g.getSelection(e.win),a=i(n),r=n.length;1==r&&t&&g.features.selectionHasExtend&&n[0].backward?(o.removeAllRanges(),o.addRange(a[0],!0)):o.setRanges(a),e.restored=!0}},removeMarkerElement:s,removeMarkers:function o(r){for(var e,l=r.rangeInfos,t=0,i=l.length;t<i;++t)e=l[t],e.collapsed?s(r.doc,e.markerId):(s(r.doc,e.startMarkerId),s(r.doc,e.endMarkerId))}})})},this);/*
	Base.js, version 1.1a
	Copyright 2006-2010, Dean Edwards
	License: http://www.opensource.org/licenses/mit-license.php
*/var Base=function(){// dummy
};Base.extend=function(s,e){// subclass
var t=Base.prototype.extend;// build the prototype
Base._prototyping=!0;var n=new this;t.call(n,s),n.base=function(){// call this method from any other method to invoke that method's ancestor
},delete Base._prototyping;// create the wrapper for the constructor function
//var constructor = proto.constructor.valueOf(); //-dean
var o=n.constructor,a=n.constructor=function(){if(!Base._prototyping)if(this._constructing||this.constructor==a)this._constructing=!0,o.apply(this,arguments),delete this._constructing;else if(null!=arguments[0])// casting
return(arguments[0].extend||t).call(arguments[0],n)};return a.ancestor=this,a.extend=this.extend,a.forEach=this.forEach,a.implement=this.implement,a.prototype=n,a.toString=this.toString,a.valueOf=function(t){//return (type == "object") ? klass : constructor; //-dean
return"object"==t?a:o.valueOf()},t.call(a,e),"function"==typeof a.init&&a.init(),a},Base.prototype={extend:function u(i,m){if(1<arguments.length){// extending with a name/value pair
var p=this[i];if(p&&"function"==typeof m&&(// overriding a method?
// the valueOf() comparison is to avoid circular references
!p.valueOf||p.valueOf()!=m.valueOf())&&/\bbase\b/.test(m)){// get the underlying method
var n=m.valueOf();// override
// point to the underlying method
m=function(){var o=this.base||Base.prototype.base;this.base=p;var e=n.apply(this,arguments);return this.base=o,e},m.valueOf=function(t){return"object"==t?m:n},m.toString=Base.toString}this[i]=m}else if(i){// extending with an object literal
var e=Base.prototype.extend;// if this object has a customised extend method then use it
Base._prototyping||"function"==typeof this||(e=this.extend||e);for(var o={toSource:null},r=["constructor","toString","valueOf"],s=Base._prototyping?0:1// do the "toString" and other methods manually
;g=r[s++];)i[g]!=o[g]&&e.call(this,g,i[g]);// copy each of the source object's properties to this object
for(var g in i)o[g]||e.call(this,g,i[g])}return this}},Base=Base.extend({constructor:function(){this.extend(arguments[0])}},{ancestor:Object,version:"1.1",forEach:function(a,e,t){for(var n in a)void 0===this.prototype[n]&&e.call(t,a[n],n,a)},implement:function(){for(var t=0;t<arguments.length;t++)"function"==typeof arguments[t]?// if it's a function, call it
arguments[t](this.prototype):// add the interface using the extend method
this.prototype.extend(arguments[t]);return this},toString:function(){return this.valueOf()+""}}),wysihtml5.browser=function(){function d(t){return+(/ipad|iphone|ipod/.test(t)&&t.match(/ os (\d+).+? like mac os x/)||[void 0,0])[1]}function e(t){return+(t.match(/android (\d+)/)||[void 0,0])[1]}function m(a,e){var t,r=-1;return"Microsoft Internet Explorer"==navigator.appName?t=/MSIE ([0-9]{1,}[.0-9]{0,})/:"Netscape"==navigator.appName&&(t=/Trident\/.*rv:([0-9]{1,}[.0-9]{0,})/),t&&null!=t.exec(navigator.userAgent)&&(r=parseFloat(RegExp.$1)),-1!==r&&(!a||(e?"<"===e?a<r:">"===e?a>r:"<="===e?a<=r:">="===e?a>=r:void 0:a===r))}var n=navigator.userAgent,p=document.createElement("div"),// Browser sniffing is unfortunately needed since some behaviors are impossible to feature detect
o=-1!==n.indexOf("Gecko")&&-1===n.indexOf("KHTML"),t=-1!==n.indexOf("AppleWebKit/"),a=-1!==n.indexOf("Chrome/"),r=-1!==n.indexOf("Opera/");return{// Static variable needed, publicly accessible, to be able override it in unit tests
USER_AGENT:n,/**
     * Exclude browsers that are not capable of displaying and handling
     * contentEditable as desired:
     *    - iPhone, iPad (tested iOS 4.2.2) and Android (tested 2.2) refuse to make contentEditables focusable
     *    - IE < 8 create invalid markup and crash randomly from time to time
     *
     * @return {Boolean}
     */supported:function(){var t=this.USER_AGENT.toLowerCase(),// Essential for making html elements editable
n="contentEditable"in p,// Following methods are needed in order to interact with the contentEditable area
o=document.execCommand&&document.queryCommandSupported&&document.queryCommandState,// document selector apis are only supported by IE 8+, Safari 4+, Chrome and Firefox 3.5+
a=document.querySelector&&document.querySelectorAll,// contentEditable is unusable in mobile browsers (tested iOS 4.2.2, Android 2.2, Opera Mobile, WebOS 3.05)
r=this.isIos()&&5>d(t)||this.isAndroid()&&4>e(t)||-1!==t.indexOf("opera mobi")||-1!==t.indexOf("hpwos/");return n&&o&&a&&!r},isTouchDevice:function(){return this.supportsEvent("touchmove")},isIos:function(){return /ipad|iphone|ipod/i.test(this.USER_AGENT)},isAndroid:function(){return-1!==this.USER_AGENT.indexOf("Android")},/**
     * Whether the browser supports sandboxed iframes
     * Currently only IE 6+ offers such feature <iframe security="restricted">
     *
     * http://msdn.microsoft.com/en-us/library/ms534622(v=vs.85).aspx
     * http://blogs.msdn.com/b/ie/archive/2008/01/18/using-frames-more-securely.aspx
     *
     * HTML5 sandboxed iframes are still buggy and their DOM is not reachable from the outside (except when using postMessage)
     */supportsSandboxedIframes:function(){return m()},/**
     * IE6+7 throw a mixed content warning when the src of an iframe
     * is empty/unset or about:blank
     * window.querySelector is implemented as of IE8
     */throwsMixedContentWarningWhenIframeSrcIsEmpty:function(){return!("querySelector"in document)},/**
     * Whether the caret is correctly displayed in contentEditable elements
     * Firefox sometimes shows a huge caret in the beginning after focusing
     */displaysCaretInEmptyContentEditableCorrectly:function(){return m()},/**
     * Opera and IE are the only browsers who offer the css value
     * in the original unit, thx to the currentStyle object
     * All other browsers provide the computed style in px via window.getComputedStyle
     */hasCurrentStyleProperty:function(){return"currentStyle"in p},/**
     * Firefox on OSX navigates through history when hitting CMD + Arrow right/left
     */hasHistoryIssue:function(){return o&&"Mac"===navigator.platform.substr(0,3)},/**
     * Whether the browser inserts a <br> when pressing enter in a contentEditable element
     */insertsLineBreaksOnReturn:function(){return o},supportsPlaceholderAttributeOn:function(t){return"placeholder"in t},supportsEvent:function(t){return"on"+t in p||function(){return p.setAttribute("on"+t,"return;"),"function"==typeof p["on"+t]}()},/**
     * Opera doesn't correctly fire focus/blur events when clicking in- and outside of iframe
     */supportsEventsInIframeCorrectly:function(){return!r},/**
     * Everything below IE9 doesn't know how to treat HTML5 tags
     *
     * @param {Object} context The document object on which to check HTML5 support
     *
     * @example
     *    wysihtml5.browser.supportsHTML5Tags(document);
     */supportsHTML5Tags:function(n){var e=n.createElement("div");return e.innerHTML="<article>foo</article>","<article>foo</article>"===e.innerHTML.toLowerCase()},/**
     * Checks whether a document supports a certain queryCommand
     * In particular, Opera needs a reference to a document that has a contentEditable in it's dom tree
     * in oder to report correct results
     *
     * @param {Object} doc Document object on which to check for a query command
     * @param {String} command The query command to check for
     * @return {Boolean}
     *
     * @example
     *    wysihtml5.browser.supportsCommand(document, "bold");
     */supportsCommand:function(){// Following commands are supported but contain bugs in some browsers
var r={// formatBlock fails with some tags (eg. <blockquote>)
formatBlock:m(10,"<="),// When inserting unordered or ordered lists in Firefox, Chrome or Safari, the current selection or line gets
// converted into a list (<ul><li>...</li></ul>, <ol><li>...</li></ol>)
// IE and Opera act a bit different here as they convert the entire content of the current block element into a list
insertUnorderedList:m(),insertOrderedList:m()},n={insertHTML:o};// Firefox throws errors for queryCommandSupported, so we have to build up our own object of supported commands
return function(e,t){var o=r[t];if(!o){// Firefox throws errors when invoking queryCommandSupported or queryCommandEnabled
try{return e.queryCommandSupported(t)}catch(t){}try{return e.queryCommandEnabled(t)}catch(o){return!!n[t]}}return!1}}(),/**
     * IE: URLs starting with:
     *    www., http://, https://, ftp://, gopher://, mailto:, new:, snews:, telnet:, wasis:, file://,
     *    nntp://, newsrc:, ldap://, ldaps://, outlook:, mic:// and url:
     * will automatically be auto-linked when either the user inserts them via copy&paste or presses the
     * space bar when the caret is directly after such an url.
     * This behavior cannot easily be avoided in IE < 9 since the logic is hardcoded in the mshtml.dll
     * (related blog post on msdn
     * http://blogs.msdn.com/b/ieinternals/archive/2009/09/17/prevent-automatic-hyperlinking-in-contenteditable-html.aspx).
     */doesAutoLinkingInContentEditable:function(){return m()},/**
     * As stated above, IE auto links urls typed into contentEditable elements
     * Since IE9 it's possible to prevent this behavior
     */canDisableAutoLinking:function(){return this.supportsCommand(document,"AutoUrlDetect")},/**
     * IE leaves an empty paragraph in the contentEditable element after clearing it
     * Chrome/Safari sometimes an empty <div>
     */clearsContentEditableCorrectly:function(){return o||r||t},/**
     * IE gives wrong results for getAttribute
     */supportsGetAttributeCorrectly:function(){var t=document.createElement("td");return"1"!=t.getAttribute("rowspan")},/**
     * When clicking on images in IE, Opera and Firefox, they are selected, which makes it easy to interact with them.
     * Chrome and Safari both don't support this
     */canSelectImagesInContentEditable:function(){return o||m()||r},/**
     * All browsers except Safari and Chrome automatically scroll the range/caret position into view
     */autoScrollsToCaret:function(){return!t},/**
     * Check whether the browser automatically closes tags that don't need to be opened
     */autoClosesUnclosedTags:function(){var o,a,r=p.cloneNode(!1);return r.innerHTML="<p><div></div>",a=r.innerHTML.toLowerCase(),o="<p></p><div></div>"===a||"<p><div></div></p>"===a,this.autoClosesUnclosedTags=function(){return o},o},/**
     * Whether the browser supports the native document.getElementsByClassName which returns live NodeLists
     */supportsNativeGetElementsByClassName:function(){return-1!==(document.getElementsByClassName+"").indexOf("[native code]")},/**
     * As of now (19.04.2011) only supported by Firefox 4 and Chrome
     * See https://developer.mozilla.org/en/DOM/Selection/modify
     */supportsSelectionModify:function(){return"getSelection"in window&&"modify"in window.getSelection()},/**
     * Opera needs a white space after a <br> in order to position the caret correctly
     */needsSpaceAfterLineBreak:function(){return r},/**
     * Whether the browser supports the speech api on the given element
     * See http://mikepultz.com/2011/03/accessing-google-speech-api-chrome-11/
     *
     * @example
     *    var input = document.createElement("input");
     *    if (wysihtml5.browser.supportsSpeechApiOn(input)) {
     *      // ...
     *    }
     */supportsSpeechApiOn:function(o){var e=n.match(/Chrome\/(\d+)/)||[void 0,0];return 11<=e[1]&&("onwebkitspeechchange"in o||"speech"in o)},/**
     * IE9 crashes when setting a getter via Object.defineProperty on XMLHttpRequest or XDomainRequest
     * See https://connect.microsoft.com/ie/feedback/details/650112
     * or try the POC http://tifftiff.de/ie9_crash/
     */crashesWhenDefineProperty:function(t){return m(9)&&("XMLHttpRequest"===t||"XDomainRequest"===t)},/**
     * IE is the only browser who fires the "focus" event not immediately when .focus() is called on an element
     */doesAsyncFocus:function(){return m()},/**
     * In IE it's impssible for the user and for the selection library to set the caret after an <img> when it's the lastChild in the document
     */hasProblemsSettingCaretAfterImg:function(){return m()},hasUndoInContextMenu:function(){return o||a||r},/**
     * Opera sometimes doesn't insert the node at the right position when range.insertNode(someNode)
     * is used (regardless if rangy or native)
     * This especially happens when the caret is positioned right after a <br> because then
     * insertNode() will insert the node right before the <br>
     */hasInsertNodeIssue:function(){return r},/**
     * IE 8+9 don't fire the focus event of the <body> when the iframe gets focused (even though the caret gets set into the <body>)
     */hasIframeFocusIssue:function(){return m()},/**
     * Chrome + Safari create invalid nested markup after paste
     *
     *  <p>
     *    foo
     *    <p>bar</p> <!-- BOO! -->
     *  </p>
     */createsNestedInvalidMarkupAfterPaste:function(){return t},supportsMutationEvents:function(){return"MutationEvent"in window},/**
      IE (at least up to 11) does not support clipboardData on event.
      It is on window but cannot return text/html
      Should actually check for clipboardData on paste event, but cannot in firefox
    */supportsModenPaste:function(){return!("clipboardData"in window)}}}(),wysihtml5.lang.array=function(s){return{/**
     * Check whether a given object exists in an array
     *
     * @example
     *    wysihtml5.lang.array([1, 2]).contains(1);
     *    // => true
     *
     * Can be used to match array with array. If intersection is found true is returned
     */contains:function(e){if(Array.isArray(e)){for(var t=e.length;t--;)if(-1!==wysihtml5.lang.array(s).indexOf(e[t]))return!0;return!1}return-1!==wysihtml5.lang.array(s).indexOf(e)},/**
     * Check whether a given object exists in an array and return index
     * If no elelemt found returns -1
     *
     * @example
     *    wysihtml5.lang.array([1, 2]).indexOf(2);
     *    // => 1
     */indexOf:function(e){if(s.indexOf)return s.indexOf(e);for(var t=0,a=s.length;t<a;t++)if(s[t]===e)return t;return-1},/**
     * Substract one array from another
     *
     * @example
     *    wysihtml5.lang.array([1, 2, 3, 4]).without([3, 4]);
     *    // => [1, 2]
     */without:function(e){e=wysihtml5.lang.array(e);for(var r=[],n=0,l=s.length;n<l;n++)e.contains(s[n])||r.push(s[n]);return r},/**
     * Return a clean native array
     *
     * Following will convert a Live NodeList to a proper Array
     * @example
     *    var childNodes = wysihtml5.lang.array(document.body.childNodes).get();
     */get:function(){for(var e=0,a=s.length,n=[];e<a;e++)n.push(s[e]);return n},/**
     * Creates a new array with the results of calling a provided function on every element in this array.
     * optionally this can be provided as second argument
     *
     * @example
     *    var childNodes = wysihtml5.lang.array([1,2,3,4]).map(function (value, index, array) {
            return value * 2;
     *    });
     *    // => [2,4,6,8]
     */map:function(e,t){if(Array.prototype.map)return s.map(e,t);for(var n=s.length>>>0,o=Array(n),a=0;a<n;a++)o[a]=e.call(t,s[a],a,s);return o},/* ReturnS new array without duplicate entries
     *
     * @example
     *    var uniq = wysihtml5.lang.array([1,2,3,2,1,4]).unique();
     *    // => [1,2,3,4]
     */unique:function(){for(var e=[],t=s.length,n=0;n<t;)wysihtml5.lang.array(e).contains(s[n])||e.push(s[n]),n++;return e}}},wysihtml5.lang.Dispatcher=Base.extend(/** @scope wysihtml5.lang.Dialog.prototype */{on:function(n,e){return this.events=this.events||{},this.events[n]=this.events[n]||[],this.events[n].push(e),this},off:function(r,e){this.events=this.events||{};var t,s,l=0;if(r){for(t=this.events[r]||[],s=[];l<t.length;l++)t[l]!==e&&e&&s.push(t[l]);this.events[r]=s}else// Clean up all events
this.events={};return this},fire:function(a,e){this.events=this.events||{};for(var t=this.events[a]||[],n=0;n<t.length;n++)t[n].call(this,e);return this},// deprecated, use .on()
observe:function(){return this.on.apply(this,arguments)},// deprecated, use .off()
stopObserving:function(){return this.off.apply(this,arguments)}}),wysihtml5.lang.object=function(a){return{/**
     * @example
     *    wysihtml5.lang.object({ foo: 1, bar: 1 }).merge({ bar: 2, baz: 3 }).get();
     *    // => { foo: 1, bar: 2, baz: 3 }
     */merge:function(e){for(var t in e)a[t]=e[t];return this},get:function(){return a},/**
     * @example
     *    wysihtml5.lang.object({ foo: 1 }).clone();
     *    // => { foo: 1 }
     *
     *    v0.4.14 adds options for deep clone : wysihtml5.lang.object({ foo: 1 }).clone(true);
     */clone:function(e){var t,r={};if(null===a||!wysihtml5.lang.object(a).isPlainObject())return a;for(t in a)a.hasOwnProperty(t)&&(r[t]=e?wysihtml5.lang.object(a[t]).clone(e):a[t]);return r},/**
     * @example
     *    wysihtml5.lang.object([]).isArray();
     *    // => true
     */isArray:function(){return"[object Array]"===Object.prototype.toString.call(a)},/**
     * @example
     *    wysihtml5.lang.object(function() {}).isFunction();
     *    // => true
     */isFunction:function(){return"[object Function]"===Object.prototype.toString.call(a)},isPlainObject:function(){return"[object Object]"===Object.prototype.toString.call(a)}}},function(){var r=/^\s+/,e=/\s+$/,s=/[&<>\t"]/g,t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","	":"&nbsp; "};wysihtml5.lang.string=function(n){return n+="",{/**
       * @example
       *    wysihtml5.lang.string("   foo   ").trim();
       *    // => "foo"
       */trim:function(){return n.replace(r,"").replace(e,"")},/**
       * @example
       *    wysihtml5.lang.string("Hello #{name}").interpolate({ name: "Christopher" });
       *    // => "Hello Christopher"
       */interpolate:function(o){for(var e in o)n=this.replace("#{"+e+"}").by(o[e]);return n},/**
       * @example
       *    wysihtml5.lang.string("Hello Tom").replace("Tom").with("Hans");
       *    // => "Hello Hans"
       */replace:function(o){return{by:function(e){return n.split(o).join(e)}}},/**
       * @example
       *    wysihtml5.lang.string("hello<br>").escapeHTML();
       *    // => "hello&lt;br&gt;"
       */escapeHTML:function(o,e){var a=n.replace(s,function(n){return t[n]});return o&&(a=a.replace(/(?:\r\n|\r|\n)/g,"<br />")),e&&(a=a.replace(/  /gi,"&nbsp; ")),a}}}}(),function(p){/**
   * This is basically a rebuild of
   * the rails auto_link_urls text helper
   */function e(t){return t.replace(s,function(s,e){var d=(e.match(l)||[])[1]||"",m=i[d];e=e.replace(l,""),e.split(m).length>e.split(d).length&&(e+=d,d="");var o=e,p=e;return 100<e.length&&(p=p.substr(0,100)+"..."),"www."===o.substr(0,4)&&(o="http://"+o),"<a href=\""+o+"\">"+p+"</a>"+d})}/**
   * Creates or (if already cached) returns a temp element
   * for the given document object
   */function t(n){var e=n._wysihtml5_tempElement;return e||(e=n._wysihtml5_tempElement=n.createElement("div")),e}/**
   * Replaces the original text nodes with the newly auto-linked dom tree
   */function g(n){var o=n.parentNode,a=p.lang.string(n.data).escapeHTML(),r=t(o.ownerDocument);// We need to insert an empty/temporary <span /> to fix IE quirks
// Elsewise IE would strip white space in the beginning
for(r.innerHTML="<span></span>"+e(a),r.removeChild(r.firstChild);r.firstChild;)// inserts tempElement.firstChild before textNode
o.insertBefore(r.firstChild,n);o.removeChild(n)}function n(e,a){for(var n;e.parentNode;){if(e=e.parentNode,n=e.nodeName,e.className&&p.lang.array(e.className.split(" ")).contains(a))return!0;if(r.contains(n))return!0;if("body"===n)return!1}return!1}function o(e,t){if(!r.contains(e.nodeName)&&!(e.className&&p.lang.array(e.className.split(" ")).contains(t))){if(e.nodeType===p.TEXT_NODE&&e.data.match(s))return void g(e);for(var n=p.lang.array(e.childNodes).get(),a=n.length,l=0;l<a;l++)o(n[l],t);return e}}var/**
       * Don't auto-link urls that are contained in the following elements:
       */r=p.lang.array(["CODE","PRE","A","SCRIPT","HEAD","TITLE","STYLE"]),/**
       * revision 1:
       *    /(\S+\.{1}[^\s\,\.\!]+)/g
       *
       * revision 2:
       *    /(\b(((https?|ftp):\/\/)|(www\.))[-A-Z0-9+&@#\/%?=~_|!:,.;\[\]]*[-A-Z0-9+&@#\/%=~_|])/gim
       *
       * put this in the beginning if you don't wan't to match within a word
       *    (^|[\>\(\{\[\s\>])
       */s=/((https?:\/\/|www\.)[^\s<]{3,})/gi,l=/([^\w\/\-](,?))$/i,i={")":"(","]":"[","}":"{"};// Reveal url reg exp to the outside
p.dom.autoLink=function(a,r){return n(a,r)?a:(a===a.ownerDocument.documentElement&&(a=a.ownerDocument.body),o(a,r))},p.dom.autoLink.URL_REG_EXP=s}(wysihtml5),function(n){var a=n.dom;a.addClass=function(t,e){var n=t.classList;return n?n.add(e):void(a.hasClass(t,e)||(t.className+=" "+e))},a.removeClass=function(o,e){var t=o.classList;return t?t.remove(e):void(o.className=o.className.replace(new RegExp("(^|\\s+)"+e+"(\\s+|$)")," "))},a.hasClass=function(a,e){var t=a.classList;if(t)return t.contains(e);var n=a.className;return 0<n.length&&(n==e||new RegExp("(^|\\s)"+e+"(\\s|$)").test(n))}}(wysihtml5),wysihtml5.dom.contains=function(){var t=document.documentElement;return t.contains?function(n,e){return e.nodeType!==wysihtml5.ELEMENT_NODE&&(e=e.parentNode),n!==e&&n.contains(e)}:t.compareDocumentPosition?function(n,e){// https://developer.mozilla.org/en/DOM/Node.compareDocumentPosition
return!!(16&n.compareDocumentPosition(e))}:void 0}(),wysihtml5.dom.convertToList=function(){function i(o,e){var t=o.createElement("li");return e.appendChild(t),t}function e(n,e){return n.createElement(e)}return function(t,n,o){if("UL"===t.nodeName||"OL"===t.nodeName||"MENU"===t.nodeName)// Already a list
return t;var a,w,N,x,E,S,v,T,R,_=t.ownerDocument,r=e(_,n),s=t.querySelectorAll("br"),l=s.length;// First find <br> at the end of inline elements and move them behind them
for(R=0;R<l;R++)for(x=s[R];(E=x.parentNode)&&E!==t&&E.lastChild===x;){if("block"===wysihtml5.dom.getStyle("display").from(E)){E.removeChild(x);break}wysihtml5.dom.insert(x).after(x.parentNode)}for(a=wysihtml5.lang.array(t.childNodes).get(),w=a.length,R=0;R<w;R++){// consider uneditable as an inline element
if(T=T||i(_,r),N=a[R],S="block"===wysihtml5.dom.getStyle("display").from(N),v="BR"===N.nodeName,S&&(!o||!wysihtml5.dom.hasClass(N,o))){T=T.firstChild?i(_,r):T,T.appendChild(N),T=null;continue}if(v){T=T.firstChild?null:T;continue}T.appendChild(N)}return 0===a.length&&i(_,r),t.parentNode.replaceChild(r,t),r}}(),wysihtml5.dom.copyAttributes=function(s){return{from:function(e){return{to:function(t){for(var n,l=0,i=s.length;l<i;l++)n=s[l],"undefined"!=typeof e[n]&&""!==e[n]&&(t[n]=e[n]);return{andTo:arguments.callee}}}}}},function(i){/**
   * Mozilla, WebKit and Opera recalculate the computed width when box-sizing: boder-box; is set
   * So if an element has "width: 200px; -moz-box-sizing: border-box; border: 1px;" then
   * its computed css width will be 198px
   *
   * See https://bugzilla.mozilla.org/show_bug.cgi?id=520992
   */var e=["-webkit-box-sizing","-moz-box-sizing","-ms-box-sizing","box-sizing"],t=function(e){return!!n(e)&&parseInt(i.getStyle("width").from(e),10)<e.offsetWidth},n=function(t){for(var n=0,r=e.length;n<r;n++)if("border-box"===i.getStyle(e[n]).from(t))return e[n]};i.copyStyles=function(n){return{from:function(o){t(o)&&(n=wysihtml5.lang.array(n).without(e));for(var a,m="",p=n.length,s=0;s<p;s++)a=n[s],m+=a+":"+i.getStyle(a).from(o)+";";return{to:function(e){return i.setStyles(m).on(e),{andTo:arguments.callee}}}}}}}(wysihtml5.dom),function(l){l.dom.delegate=function(e,t,n,s){return l.dom.observe(e,n,function(n){for(var o=n.target,a=l.lang.array(e.querySelectorAll(t));o&&o!==e;){if(a.contains(o)){s.call(o,n);break}o=o.parentNode}})}}(wysihtml5),function(l){l.dom.domNode=function(e){var t=[l.ELEMENT_NODE,l.TEXT_NODE],n=function(e){return e.nodeType===l.TEXT_NODE&&/^\s*$/g.test(e.data)};return{// var node = wysihtml5.dom.domNode(element).prev({nodeTypes: [1,3], ignoreBlankTexts: true});
prev:function(o){var a=e.previousSibling,r=o&&o.nodeTypes?o.nodeTypes:t;return a?!l.lang.array(r).contains(a.nodeType)||// nodeTypes check.
o&&o.ignoreBlankTexts&&n(a)// Blank text nodes bypassed if set
?l.dom.domNode(a).prev(o):a:null},// var node = wysihtml5.dom.domNode(element).next({nodeTypes: [1,3], ignoreBlankTexts: true});
next:function(o){var a=e.nextSibling,r=o&&o.nodeTypes?o.nodeTypes:t;return a?!l.lang.array(r).contains(a.nodeType)||// nodeTypes check.
o&&o.ignoreBlankTexts&&n(a)// blank text nodes bypassed if set
?l.dom.domNode(a).next(o):a:null}}}}(wysihtml5),wysihtml5.dom.getAsDom=function(){var r=function(e,o){var t=o.createElement("div");t.style.display="none",o.body.appendChild(t);// IE throws an exception when trying to insert <frameset></frameset> via innerHTML
try{t.innerHTML=e}catch(e){}return o.body.removeChild(t),t},e=function(n){if(!n._wysihtml5_supportsHTML5Tags){for(var e=0,r=a.length;e<r;e++)n.createElement(a[e]);n._wysihtml5_supportsHTML5Tags=!0}},a=["abbr","article","aside","audio","bdi","canvas","command","datalist","details","figcaption","figure","footer","header","hgroup","keygen","mark","meter","nav","output","progress","rp","rt","ruby","svg","section","source","summary","time","track","video","wbr"];/**
   * Make sure IE supports HTML5 tags, which is accomplished by simply creating one instance of each element
   */return function(t,n){n=n||document;var s;return"object"==typeof t&&t.nodeType?(s=n.createElement("div"),s.appendChild(t)):wysihtml5.browser.supportsHTML5Tags(n)?(s=n.createElement("div"),s.innerHTML=t):(e(n),s=r(t,n)),s}}(),wysihtml5.dom.getParentElement=function(){function s(n,e){return!(e&&e.length)||("string"==typeof e?n===e:wysihtml5.lang.array(e).contains(n))}function e(t){return t.nodeType===wysihtml5.ELEMENT_NODE}function t(a,e,t){var n=(a.className||"").match(t)||[];return e?n[n.length-1]===e:!!n.length}function n(a,e,t){var n=(a.getAttribute("style")||"").match(t)||[];return e?n[n.length-1]===e:!!n.length}return function(o,m,r,p){var l=m.cssStyle||m.styleRegExp,i=m.className||m.classRegExp;// Go max 50 nodes upwards from current node
for(r=r||50;r--&&o&&"BODY"!==o.nodeName&&(!p||o!==p);){if(e(o)&&s(o.nodeName,m.nodeName)&&(!l||n(o,m.cssStyle,m.styleRegExp))&&(!i||t(o,m.className,m.classRegExp)))return o;o=o.parentNode}return null}}(),wysihtml5.dom.getStyle=function(){function u(n){return n.replace(t,function(t){return t.charAt(1).toUpperCase()})}var e={float:"styleFloat"in document.createElement("div").style?"styleFloat":"cssFloat"},t=/\-[a-z]/g;return function(t){return{from:function(n){if(n.nodeType===wysihtml5.ELEMENT_NODE){var o=n.ownerDocument,a=e[t]||u(t),r=n.style,s=n.currentStyle,l=r[a];if(l)return l;// currentStyle is no standard and only supported by Opera and IE but it has one important advantage over the standard-compliant
// window.getComputedStyle, since it returns css property values in their original unit:
// If you set an elements width to "50%", window.getComputedStyle will give you it's current width in px while currentStyle
// gives you the original "50%".
// Opera supports both, currentStyle and window.getComputedStyle, that's why checking for currentStyle should have higher prio
if(s)try{return s[a]}catch(e){//ie will occasionally fail for unknown reasons. swallowing exception
}var i,f,h=o.defaultView||o.parentWindow,d=("height"===t||"width"===t)&&"TEXTAREA"===n.nodeName;if(h.getComputedStyle)return d&&(i=r.overflow,r.overflow="hidden"),f=h.getComputedStyle(n,null).getPropertyValue(t),d&&(r.overflow=i||""),f}}}}}(),wysihtml5.dom.getTextNodes=function(o,a){var t=[];for(o=o.firstChild;o;o=o.nextSibling)3==o.nodeType?a&&/^\s*$/.test(o.innerText||o.textContent)||t.push(o):t=t.concat(wysihtml5.dom.getTextNodes(o,a));return t},wysihtml5.dom.hasElementWithTagName=function(){function s(n){return n._wysihtml5_identifier||(n._wysihtml5_identifier=t++)}var e={},t=1;return function(t,n){var o=s(t)+":"+n,a=e[o];return a||(a=e[o]=t.getElementsByTagName(n)),0<a.length}}(),function(l){function e(t){return t._wysihtml5_identifier||(t._wysihtml5_identifier=n++)}var t={},n=1;l.dom.hasElementWithClassName=function(n,o){// getElementsByClassName is not supported by IE<9
// but is sometimes mocked via library code (which then doesn't return live node lists)
if(!l.browser.supportsNativeGetElementsByClassName())return!!n.querySelector("."+o);var a=e(n)+":"+o,r=t[a];return r||(r=t[a]=n.getElementsByClassName(o)),0<r.length}}(wysihtml5),wysihtml5.dom.insert=function(n){return{after:function(e){e.parentNode.insertBefore(n,e.nextSibling)},before:function(e){e.parentNode.insertBefore(n,e)},into:function(e){e.appendChild(n)}}},wysihtml5.dom.insertCSS=function(r){return r=r.join("\n"),{into:function(e){var t=e.createElement("style");t.type="text/css",t.styleSheet?t.styleSheet.cssText=r:t.appendChild(e.createTextNode(r));var n=e.querySelector("head link");if(n)return void n.parentNode.insertBefore(t,n);var o=e.querySelector("head");o&&o.appendChild(t)}}},function(s){s.dom.lineBreaks=function(e){function r(t){return"BR"===t.nodeName}/**
     * Checks whether the elment causes a visual line break
     * (<br> or block elements)
     */function t(e){return!!r(e)||"block"===s.dom.getStyle("display").from(e)}return{/* wysihtml5.dom.lineBreaks(element).add();
       *
       * Adds line breaks before and after the given node if the previous and next siblings
       * aren't already causing a visual line break (block element or <br>)
       */add:function(){var o=e.ownerDocument,n=s.dom.domNode(e).next({ignoreBlankTexts:!0}),a=s.dom.domNode(e).prev({ignoreBlankTexts:!0});n&&!t(n)&&s.dom.insert(o.createElement("br")).after(e),a&&!t(a)&&s.dom.insert(o.createElement("br")).before(e)},/* wysihtml5.dom.lineBreaks(element).remove();
       *
       * Removes line breaks before and after the given node
       */remove:function(){var t=s.dom.domNode(e).next({ignoreBlankTexts:!0}),n=s.dom.domNode(e).prev({ignoreBlankTexts:!0});t&&r(t)&&t.parentNode.removeChild(t),n&&r(n)&&n.parentNode.removeChild(n)}}}}(wysihtml5),wysihtml5.dom.observe=function(l,e,i){e="string"==typeof e?[e]:e;for(var n,d,m=0,p=e.length;m<p;m++)d=e[m],l.addEventListener?l.addEventListener(d,i,!1):(n=function(e){"target"in e||(e.target=e.srcElement),e.preventDefault=e.preventDefault||function(){this.returnValue=!1},e.stopPropagation=e.stopPropagation||function(){this.cancelBubble=!0},i.call(l,e)},l.attachEvent("on"+d,n));return{stop:function(){for(var t,r=0,d=e.length;r<d;r++)t=e[r],l.removeEventListener?l.removeEventListener(t,i,!1):l.detachEvent("on"+t,n)}}},wysihtml5.dom.parse=function(i,e){/**
   * Iterates over all childs of the element, recreates them, appends them into a document fragment
   * which later replaces the entire body content
   */function S(n,e,t,o){var a,i,u,h=n.nodeType,r=n.childNodes,s=r.length,l=_[h],d=0;// Passes directly elemets with uneditable class
if(o&&1===h&&wysihtml5.dom.hasClass(n,o))return n;// Remove or unwrap node in case of return value null or false
if(i=l&&l(n,t),!i){if(!1===i){for(a=n.ownerDocument.createDocumentFragment(),d=s;d--;)r[d]&&(u=S(r[d],e,t,o),u&&(r[d]===u&&d--,a.insertBefore(u,a.firstChild)));return"block"===wysihtml5.dom.getStyle("display").from(n)&&a.appendChild(n.ownerDocument.createElement("br")),!wysihtml5.lang.array(["div","pre","p","table","td","th","ul","ol","li","dd","dl","footer","header","section","h1","h2","h3","h4","h5","h6"]).contains(n.nodeName.toLowerCase())||n.parentNode.lastChild===n||n.nextSibling&&3===n.nextSibling.nodeType&&/^\s/.test(n.nextSibling.nodeValue)||a.appendChild(n.ownerDocument.createTextNode(" ")),a.normalize&&a.normalize(),a}// Remove
return null}// Converts all childnodes
for(d=0;d<s;d++)r[d]&&(u=S(r[d],e,t,o),u&&(r[d]===u&&d--,i.appendChild(u)));// Cleanup senseless <span> elements
if(e&&"span"===i.nodeName.toLowerCase()&&(!i.childNodes.length||/^\s*$/gi.test(i.innerHTML)&&(t||"_wysihtml5-temp-placeholder"!==n.className&&"rangySelectionBoundary"!==n.className)||!i.attributes.length)){for(a=i.ownerDocument.createDocumentFragment();i.firstChild;)a.appendChild(i.firstChild);return a.normalize&&a.normalize(),a}return i.normalize&&i.normalize(),i}function n(s,e){var t,l,i;for(t in e)if(e.hasOwnProperty(t)){wysihtml5.lang.object(e[t]).isFunction()?l=e[t]:"string"==typeof e[t]&&y[e[t]]&&(l=y[e[t]]),i=s.querySelectorAll(t);for(var d=i.length;d--;)l(i[d])}}function t(m,p){var t,g,u,h=f.tags,n=m.nodeName.toLowerCase(),y=m.scopeName;/**
     * We already parsed that element
     * ignore it! (yes, this sometimes happens in IE8 when the html is invalid)
     */if(m._wysihtml5)return null;if(m._wysihtml5=1,"wysihtml5-temp"===m.className)return null;/**
     * IE is the only browser who doesn't include the namespace in the
     * nodeName, that's why we have to prepend it by ourselves
     * scopeName is a proprietary IE feature
     * read more here http://msdn.microsoft.com/en-us/library/ms534388(v=vs.85).aspx
     */if(y&&"HTML"!=y&&(n=y+":"+n),"outerHTML"in m&&!wysihtml5.browser.autoClosesUnclosedTags()&&"P"===m.nodeName&&"</p>"!==m.outerHTML.slice(-4).toLowerCase()&&(n="div"),n in h){if(t=h[n],!t||t.remove)return null;if(t.unwrap)return!1;t="string"==typeof t?{rename_tag:t}:t}else if(m.firstChild)t={rename_tag:"span"};else// Remove empty unknown elements
return null;// tests if type condition is met or node should be removed/unwrapped/renamed
if(t.one_of_type&&!v(m,f,t.one_of_type,p))if(t.remove_action){if("unwrap"===t.remove_action)return!1;if("rename"===t.remove_action)u=t.remove_action_rename_to||"span";else return null}else return null;return g=m.ownerDocument.createElement(u||t.rename_tag||n),l(m,g,t,p),r(m,g,t),m=null,g.normalize&&g.normalize(),g}function v(s,e,t,n){var l,i;// do not interfere with placeholder span or pasting caret position is not maintained
if("SPAN"===s.nodeName&&!n&&("_wysihtml5-temp-placeholder"===s.className||"rangySelectionBoundary"===s.className))return!0;for(i in t)if(t.hasOwnProperty(i)&&e.type_definitions&&e.type_definitions[i]&&(l=e.type_definitions[i],o(s,l)))return!0;return!1}function o(s,e){var t,i,f,y,b,C=s.getAttribute("class"),w=s.getAttribute("style");// test for methods
if(e.methods)for(var N in e.methods)if(e.methods.hasOwnProperty(N)&&h[N]&&h[N](s))return!0;// test for classes, if one found return true
if(C&&e.classes){C=C.replace(/^\s+/g,"").replace(/\s+$/g,"").split(a),t=C.length;for(var u=0;u<t;u++)if(e.classes[C[u]])return!0}// test for styles, if one found return true
if(w&&e.styles)for(i in w=w.split(";"),e.styles)if(e.styles.hasOwnProperty(i))for(var x=w.length;x--;)if(b=w[x].split(":"),b[0].replace(/\s/g,"").toLowerCase()===i&&(!0===e.styles[i]||1===e.styles[i]||wysihtml5.lang.array(e.styles[i]).contains(b[1].replace(/\s/g,"").toLowerCase())))return!0;// test for attributes in general against regex match
if(e.attrs)for(f in e.attrs)if(e.attrs.hasOwnProperty(f)&&(y=wysihtml5.dom.getAttribute(s,f),"string"==typeof y&&-1<y.search(e.attrs[f])))return!0;return!1}function r(r,e,t){var n,s;if(t&&t.keep_styles)for(n in t.keep_styles)if(t.keep_styles.hasOwnProperty(n)){// value can be regex and if so should match or style skipped
if(s="float"===n?r.style.styleFloat||r.style.cssFloat:r.style[n],t.keep_styles[n]instanceof RegExp&&!t.keep_styles[n].test(s))continue;"float"===n?e.style[r.style.styleFloat?"styleFloat":"cssFloat"]=s:r.style[n]&&(e.style[n]=s)}}function T(a,e){var t=[];for(var n in e)e.hasOwnProperty(n)&&0===n.indexOf(a)&&t.push(n);return t}function d(s,e,t,n){var o,l=m[t];return!!(l&&(e||"alt"===s&&"IMG"==n)&&(o=l(e),"string"==typeof o))&&o}function R(i,e){var t,m,h,y=wysihtml5.lang.object(f.attributes||{}).clone(),// global values for check/convert values of attributes
n=wysihtml5.lang.object(y).merge(wysihtml5.lang.object(e||{}).clone()).get(),o={},a=wysihtml5.dom.getAttributes(i);for(t in n)if(/\*$/.test(t)){h=T(t.slice(0,-1),a);for(var r=0,b=h.length;r<b;r++)m=d(h[r],a[h[r]],n[t],i.nodeName),!1!==m&&(o[h[r]]=m)}else m=d(t,a[t],n[t],i.nodeName),!1!==m&&(o[t]=m);return o}// TODO: refactor. Too long to read
function l(i,e,t,n){var o,y,w,N,_,A={},// fresh new set of attributes to set on newNode
O=t.set_class,// classes to set
r=t.add_class,// add classes based on existing attributes
s=t.add_style,// add styles based on existing attributes
l=t.set_attributes,// attributes to set on the current node
d=f.classes,m=0,L=[],I=[],h=[],b=[];if(l&&(A=wysihtml5.lang.object(l).clone()),A=wysihtml5.lang.object(A).merge(R(i,t.check_attributes)).get(),O&&L.push(O),r)for(N in r)(_=g[r[N]],!!_)&&(w=_(wysihtml5.dom.getAttribute(i,N)),"string"==typeof w&&L.push(w));if(s)for(N in s)(_=p[s[N]],!!_)&&(newStyle=_(wysihtml5.dom.getAttribute(i,N)),"string"==typeof newStyle&&I.push(newStyle));if(!("string"==typeof d&&"any"===d&&i.getAttribute("class"))){for(n||(d["_wysihtml5-temp-placeholder"]=1,d._rangySelectionBoundary=1,d["wysiwyg-tmp-selected-cell"]=1),b=i.getAttribute("class"),b&&(L=L.concat(b.split(a))),o=L.length;m<o;m++)y=L[m],d[y]&&h.push(y);h.length&&(A["class"]=wysihtml5.lang.array(h).unique().join(" "))}else if(f.classes_blacklist){for(b=i.getAttribute("class"),b&&(L=L.concat(b.split(a))),o=L.length;m<o;m++)y=L[m],f.classes_blacklist[y]||h.push(y);h.length&&(A["class"]=wysihtml5.lang.array(h).unique().join(" "))}else A["class"]=i.getAttribute("class");// remove table selection class if present
// set attributes on newNode
for(N in A["class"]&&n&&(A["class"]=A["class"].replace("wysiwyg-tmp-selected-cell",""),/^\s*$/g.test(A["class"])&&delete A["class"]),I.length&&(A.style=wysihtml5.lang.array(I).unique().join(" ")),A)// Setting attributes can cause a js error in IE under certain circumstances
// eg. on a <img> under https when it's new attribute value is non-https
// TODO: Investigate this further and check for smarter handling
try{e.setAttribute(N,A[N])}catch(e){}// IE8 sometimes loses the width/height attributes when those are set before the "src"
// so we make sure to set them again
A.src&&("undefined"!=typeof A.width&&e.setAttribute("width",A.width),"undefined"!=typeof A.height&&e.setAttribute("height",A.height))}/* TODO: Currently escaped module pattern as otherwise folloowing default swill be shared among multiple editors.
   * Refactor whole code as this method while workind is kind of awkward too */ /**
   * It's not possible to use a XMLParser/DOMParser as HTML5 is not always well-formed XML
   * new DOMParser().parseFromString('<img src="foo.gif">') will cause a parseError since the
   * node isn't closed
   *
   * Therefore we've to use the browser's ordinary HTML parser invoked by setting innerHTML.
   */var _={1:t,3:function n(o){var e=o.nextSibling;if(e&&e.nodeType===wysihtml5.TEXT_NODE)// Concatenate text nodes
e.data=o.data.replace(s,"")+e.data.replace(s,"");else{// \uFEFF = wysihtml5.INVISIBLE_SPACE (used as a hack in certain rich text editing situations)
var t=o.data.replace(s,"");return o.ownerDocument.createTextNode(t)}},8:function e(t){if(f.comments)return t.ownerDocument.createComment(t.nodeValue)}// ------------ attribute checks ------------ \\
},a=/\s+/,u={tags:{},classes:{}},f={},s=/\uFEFF/g,m={url:function(){var n=/^https?:\/\//i;return function(e){return e&&e.match(n)?e.replace(n,function(t){return t.toLowerCase()}):null}}(),src:function(){var n=/^(\/|https?:\/\/)/i;return function(e){return e&&e.match(n)?e.replace(n,function(t){return t.toLowerCase()}):null}}(),href:function(){var n=/^(#|\/|https?:\/\/|mailto:)/i;return function(e){return e&&e.match(n)?e.replace(n,function(t){return t.toLowerCase()}):null}}(),alt:function(){var n=/[^ a-z0-9_\-]/gi;return function(e){return e?e.replace(n,""):""}}(),numbers:function(){var n=/\D/g;return function(e){return e=(e||"").replace(n,""),e||null}}(),any:function(){return function(t){return t}}()},p={align_text:function(){var n={left:"text-align: left;",right:"text-align: right;",center:"text-align: center;"};return function(e){return n[(e+"").toLowerCase()]}}()},g={align_img:function(){var n={left:"wysiwyg-float-left",right:"wysiwyg-float-right"};return function(e){return n[(e+"").toLowerCase()]}}(),align_text:function(){var n={left:"wysiwyg-text-align-left",right:"wysiwyg-text-align-right",center:"wysiwyg-text-align-center",justify:"wysiwyg-text-align-justify"};return function(e){return n[(e+"").toLowerCase()]}}(),clear_br:function(){var n={left:"wysiwyg-clear-left",right:"wysiwyg-clear-right",both:"wysiwyg-clear-both",all:"wysiwyg-clear-both"};return function(e){return n[(e+"").toLowerCase()]}}(),size_font:function(){var n={1:"wysiwyg-font-size-xx-small",2:"wysiwyg-font-size-small",3:"wysiwyg-font-size-medium",4:"wysiwyg-font-size-large",5:"wysiwyg-font-size-x-large",6:"wysiwyg-font-size-xx-large",7:"wysiwyg-font-size-xx-large","-":"wysiwyg-font-size-smaller","+":"wysiwyg-font-size-larger"};return function(e){return n[(e+"").charAt(0)]}}()},h={has_visible_contet:function(){var a,r=["img","video","picture","br","script","noscript","style","table","iframe","object","embed","audio","svg","input","button","select","textarea","canvas"];return function(e){if(a=(e.innerText||e.textContent).replace(/\s/g,""),a&&0<a.length)return!0;// matches list of visible dimensioned elements
for(var t=r.length;t--;)if(e.querySelector(r[t]))return!0;// try to measure dimesions in last resort. (can find only of elements in dom)
return!!(e.offsetWidth&&0<e.offsetWidth&&e.offsetHeight&&0<e.offsetHeight)}}()},y={unwrap:function(t){wysihtml5.dom.unwrap(t)},remove:function(t){t.parentNode.removeChild(t)}};return function(o,e){wysihtml5.lang.object(f).merge(u).merge(e.rules).get();var t,h,y,b=e.context||o.ownerDocument||document,a=b.createDocumentFragment(),r="string"==typeof o,s=!1;for(!0===e.clearInternals&&(s=!0),t=r?wysihtml5.dom.getAsDom(o,b):o,f.selectors&&n(t,f.selectors);t.firstChild;)y=t.firstChild,h=S(y,e.cleanUp,s,e.uneditableClass),h&&a.appendChild(h),y!==h&&t.removeChild(y);if(e.unjoinNbsps)// replace joined non-breakable spaces with unjoined
for(var C=wysihtml5.dom.getTextNodes(a),p=C.length;p--;)C[p].nodeValue=C[p].nodeValue.replace(/([\S\u00A0])\u00A0/gi,"$1 ");// Clear element contents
return t.innerHTML="",t.appendChild(a),r?wysihtml5.quirks.getCorrectInnerHTML(t):t}(i,e)},wysihtml5.dom.removeEmptyTextNodes=function(r){for(var e,s=wysihtml5.lang.array(r.childNodes).get(),t=s.length,n=0;n<t;n++)e=s[n],e.nodeType===wysihtml5.TEXT_NODE&&""===e.data&&e.parentNode.removeChild(e)},wysihtml5.dom.renameElement=function(a,e){for(var t,r=a.ownerDocument.createElement(e);t=a.firstChild;)r.appendChild(t);return wysihtml5.dom.copyAttributes(["align","className"]).from(a).to(r),a.parentNode.replaceChild(r,a),r},wysihtml5.dom.replaceWithChildNodes=function(n){if(n.parentNode){if(!n.firstChild)return void n.parentNode.removeChild(n);for(var o=n.ownerDocument.createDocumentFragment();n.firstChild;)o.appendChild(n.firstChild);n.parentNode.replaceChild(o,n),n=o=null}},function(a){function r(e){return"block"===a.getStyle("display").from(e)}function t(t){return"BR"===t.nodeName}function n(n){var e=n.ownerDocument.createElement("br");n.appendChild(e)}a.resolveList=function(o,e){if(o.nodeName.match(/^(MENU|UL|OL)$/)){var a,f,h,y,b,C,w=o.ownerDocument,N=w.createDocumentFragment(),s=wysihtml5.dom.domNode(o).prev({ignoreBlankTexts:!0});if(e)for(!s||r(s)||t(s)||n(N);C=o.firstElementChild||o.firstChild;){for(f=C.lastChild;a=C.firstChild;)// This needs to be done before appending it to the fragment, as it otherwise will lose style information
h=a===f,y=h&&!r(a)&&!t(a),N.appendChild(a),y&&n(N);C.parentNode.removeChild(C)}else for(;C=o.firstElementChild||o.firstChild;){if(C.querySelector&&C.querySelector("div, p, ul, ol, menu, blockquote, h1, h2, h3, h4, h5, h6"))for(;a=C.firstChild;)N.appendChild(a);else{for(b=w.createElement("p");a=C.firstChild;)b.appendChild(a);N.appendChild(b)}C.parentNode.removeChild(C)}o.parentNode.replaceChild(N,o)}}}(wysihtml5.dom),function(i){var/**
       * Default configuration
       */f=document,/**
       * Properties to unset/protect on the window object
       */e=["parent","top","opener","frameElement","frames","localStorage","globalStorage","sessionStorage","indexedDB"],/**
       * Properties on the window object which are set to an empty function
       */t=["open","close","openDialog","showModalDialog","alert","confirm","prompt","openDatabase","postMessage","XMLHttpRequest","XDomainRequest"],/**
       * Properties to unset/protect on the document object
       */n=["referrer","write","open","close"];i.dom.Sandbox=Base.extend(/** @scope wysihtml5.dom.Sandbox.prototype */{constructor:function(e,t){this.callback=e||i.EMPTY_FUNCTION,this.config=i.lang.object({}).merge(t).get(),this.editableArea=this._createIframe()},insertInto:function(t){"string"==typeof t&&(t=f.getElementById(t)),t.appendChild(this.editableArea)},getIframe:function(){return this.editableArea},getWindow:function(){this._readyError()},getDocument:function(){this._readyError()},destroy:function(){var t=this.getIframe();t.parentNode.removeChild(t)},_readyError:function(){throw new Error("wysihtml5.Sandbox: Sandbox iframe isn't loaded yet")},/**
     * Creates the sandbox iframe
     *
     * Some important notes:
     *  - We can't use HTML5 sandbox for now:
     *    setting it causes that the iframe's dom can't be accessed from the outside
     *    Therefore we need to set the "allow-same-origin" flag which enables accessing the iframe's dom
     *    But then there's another problem, DOM events (focus, blur, change, keypress, ...) aren't fired.
     *    In order to make this happen we need to set the "allow-scripts" flag.
     *    A combination of allow-scripts and allow-same-origin is almost the same as setting no sandbox attribute at all.
     *  - Chrome & Safari, doesn't seem to support sandboxing correctly when the iframe's html is inlined (no physical document)
     *  - IE needs to have the security="restricted" attribute set before the iframe is
     *    inserted into the dom tree
     *  - Believe it or not but in IE "security" in document.createElement("iframe") is false, even
     *    though it supports it
     *  - When an iframe has security="restricted", in IE eval() & execScript() don't work anymore
     *  - IE doesn't fire the onload event when the content is inlined in the src attribute, therefore we rely
     *    on the onreadystatechange event
     */_createIframe:function(){var e=this,t=f.createElement("iframe");return t.className="wysihtml5-sandbox",i.dom.setAttributes({security:"restricted",allowtransparency:"true",frameborder:0,width:0,height:0,marginwidth:0,marginheight:0}).on(t),i.browser.throwsMixedContentWarningWhenIframeSrcIsEmpty()&&(t.src="javascript:'<html></html>'"),t.onload=function(){t.onreadystatechange=t.onload=null,e._onLoadIframe(t)},t.onreadystatechange=function(){/loaded|complete/.test(t.readyState)&&(t.onreadystatechange=t.onload=null,e._onLoadIframe(t))},t},/**
     * Callback for when the iframe has finished loading
     */_onLoadIframe:function(o){// don't resume when the iframe got unloaded (eg. by removing it from the dom)
if(i.dom.contains(f.documentElement,o)){var a=this,r=o.contentWindow,s=o.contentWindow.document,l=f.characterSet||f.charset||"utf-8",d=this._getHtml({charset:l,stylesheets:this.config.stylesheets});// Create the basic dom tree including proper DOCTYPE and charset
if(s.open("text/html","replace"),s.write(d),s.close(),this.getWindow=function(){return o.contentWindow},this.getDocument=function(){return o.contentWindow.document},r.onerror=function(o,e,t){throw new Error("wysihtml5.Sandbox: "+o,e,t)},!i.browser.supportsSandboxedIframes()){// Unset a bunch of sensitive variables
// Please note: This isn't hack safe!
// It more or less just takes care of basic attacks and prevents accidental theft of sensitive information
// IE is secure though, which is the most important thing, since IE is the only browser, who
// takes over scripts & styles into contentEditable elements when copied from external websites
// or applications (Microsoft Word, ...)
var m,p;for(m=0,p=e.length;m<p;m++)this._unset(r,e[m]);for(m=0,p=t.length;m<p;m++)this._unset(r,t[m],i.EMPTY_FUNCTION);for(m=0,p=n.length;m<p;m++)this._unset(s,n[m]);// This doesn't work in Safari 5
// See http://stackoverflow.com/questions/992461/is-it-possible-to-override-document-cookie-in-webkit
this._unset(s,"cookie","",!0)}this.loaded=!0,setTimeout(function(){a.callback(a)},0)}},_getHtml:function(e){var t,s=e.stylesheets,l="",d=0;if(s="string"==typeof s?[s]:s,s)for(t=s.length;d<t;d++)l+="<link rel=\"stylesheet\" href=\""+s[d]+"\">";return e.stylesheets=l,i.lang.string("<!DOCTYPE html><html><head><meta charset=\"#{charset}\">#{stylesheets}</head><body></body></html>").interpolate(e)},/**
     * Method to unset/override existing variables
     * @example
     *    // Make cookie unreadable and unwritable
     *    this._unset(document, "cookie", "", true);
     */_unset:function(e,t,n,o){try{e[t]=n}catch(e){}try{e.__defineGetter__(t,function(){return n})}catch(e){}if(o)try{e.__defineSetter__(t,function(){})}catch(e){}if(!i.browser.crashesWhenDefineProperty(t))try{var a={get:function(){return n}};o&&(a.set=function(){}),Object.defineProperty(e,t,a)}catch(e){}}})}(wysihtml5),function(a){var n=document;a.dom.ContentEditableArea=Base.extend({getContentEditable:function(){return this.element},getWindow:function(){return this.element.ownerDocument.defaultView},getDocument:function(){return this.element.ownerDocument},constructor:function(e,t,n){this.callback=e||a.EMPTY_FUNCTION,this.config=a.lang.object({}).merge(t).get(),this.element=n?this._bindElement(n):this._createElement()},// creates a new contenteditable and initiates it
_createElement:function(){var t=n.createElement("div");return t.className="wysihtml5-sandbox",this._loadElement(t),t},// initiates an allready existent contenteditable
_bindElement:function(t){return t.className=t.className&&""!=t.className?t.className+" wysihtml5-sandbox":"wysihtml5-sandbox",this._loadElement(t,!0),t},_loadElement:function(a,e){var t=this;if(!e){var n=this._getHtml();a.innerHTML=n}// Catch js errors and pass them to the parent's onerror event
// addEventListener("error") doesn't work properly in some browsers
// TODO: apparently this doesn't work in IE9!
// TODO: figure out and bind the errors logic for contenteditble mode
/*iframeWindow.onerror = function(errorMessage, fileName, lineNumber) {
          throw new Error("wysihtml5.Sandbox: " + errorMessage, fileName, lineNumber);
        }
        */ // Trigger the callback
this.getWindow=function(){return a.ownerDocument.defaultView},this.getDocument=function(){return a.ownerDocument},this.loaded=!0,setTimeout(function(){t.callback(t)},0)},_getHtml:function(){return""}})}(wysihtml5),function(){var a={className:"class"};wysihtml5.dom.setAttributes=function(e){return{on:function(t){for(var n in e)t.setAttribute(a[n]||n,e[n])}}}}(),wysihtml5.dom.setStyles=function(a){return{on:function(e){var t=e.style;if("string"==typeof a)return void(t.cssText+=";"+a);for(var n in a)"float"==n?(t.cssFloat=a[n],t.styleFloat=a[n]):t[n]=a[n]}}},function(a){a.simulatePlaceholder=function(e,s,t){var n=function(){var e=0<s.element.offsetWidth&&0<s.element.offsetHeight;s.hasPlaceholderSet()&&(s.clear(),s.element.focus(),e&&setTimeout(function(){var t=s.selection.getSelection();t.focusNode&&t.anchorNode||s.selection.selectNode(s.element.firstChild||s.element)},0)),s.placeholderSet=!1,a.removeClass(s.element,"placeholder")},o=function(){s.isEmpty()&&(s.placeholderSet=!0,s.setValue(t),a.addClass(s.element,"placeholder"))};e.on("set_placeholder",o).on("unset_placeholder",n).on("focus:composer",n).on("paste:composer",n).on("blur:composer",o),o()}}(wysihtml5.dom),function(n){var e=document.documentElement;"textContent"in e?(n.setTextContent=function(n,e){n.textContent=e},n.getTextContent=function(t){return t.textContent}):"innerText"in e?(n.setTextContent=function(n,e){n.innerText=e},n.getTextContent=function(t){return t.innerText}):(n.setTextContent=function(n,e){n.nodeValue=e},n.getTextContent=function(t){return t.nodeValue})}(wysihtml5.dom),wysihtml5.dom.getAttribute=function(s,e){var l=!wysihtml5.browser.supportsGetAttributeCorrectly();e=e.toLowerCase();var n=s.nodeName;if("IMG"==n&&"src"==e&&!0===wysihtml5.dom.isLoadedImage(s))// Get 'src' attribute value via object property since this will always contain the
// full absolute url (http://...)
// this fixes a very annoying bug in firefox (ver 3.6 & 4) and IE 8 where images copied from the same host
// will have relative paths, which the sanitizer strips out (see attributeCheckMethods.url)
return s.src;if(l&&"outerHTML"in s){// Don't trust getAttribute/hasAttribute in IE 6-8, instead check the element's outerHTML
var o=s.outerHTML.toLowerCase(),// TODO: This might not work for attributes without value: <input disabled>
a=-1!=o.indexOf(" "+e+"=");return a?s.getAttribute(e):null}return s.getAttribute(e)},wysihtml5.dom.getAttributes=function(r){var e,s=!wysihtml5.browser.supportsGetAttributeCorrectly(),t=r.nodeName,n=[];for(e in r.attributes)(r.attributes.hasOwnProperty&&r.attributes.hasOwnProperty(e)||!r.attributes.hasOwnProperty&&Object.prototype.hasOwnProperty.call(r.attributes,e))&&r.attributes[e].specified&&("IMG"==t&&"src"==r.attributes[e].name.toLowerCase()&&!0===wysihtml5.dom.isLoadedImage(r)?n.src=r.src:wysihtml5.lang.array(["rowspan","colspan"]).contains(r.attributes[e].name.toLowerCase())&&s?1!==r.attributes[e].value&&(n[r.attributes[e].name]=r.attributes[e].value):n[r.attributes[e].name]=r.attributes[e].value);return n},wysihtml5.dom.isLoadedImage=function(e){try{return e.complete&&!e.mozMatchesSelector(":-moz-broken")}catch(t){if(e.complete&&"complete"===e.readyState)return!0}},function(d){function e(e,t){for(var n,i=[],o=0,d=e.length;o<d;o++)if(n=e[o].querySelectorAll(t),n)for(var r=n.length;r--;i.unshift(n[r]));return i}function r(t){t.parentNode.removeChild(t)}function h(n,e){n.parentNode.insertBefore(e,n.nextSibling)}function o(o,e){for(var t=o.nextSibling;1!=t.nodeType;)if(t=t.nextSibling,!e||e==t.tagName.toLowerCase())return t;return null}var y=d.dom,g=function(t){this.el=t,this.isColspan=!1,this.isRowspan=!1,this.firstCol=!0,this.lastCol=!0,this.firstRow=!0,this.lastRow=!0,this.isReal=!0,this.spanCollection=[],this.modified=!1},a=function(n,e){n?(this.cell=n,this.table=y.getParentElement(n,{nodeName:["TABLE"]})):e&&(this.table=e,this.cell=this.table.querySelectorAll("th, td")[0])};a.prototype={addSpannedCellToMap:function(l,e,t,n,o,a){for(var r=[],s=t+(a?parseInt(a,10)-1:0),i=n+(o?parseInt(o,10)-1:0),d=t;d<=s;d++){"undefined"==typeof e[d]&&(e[d]=[]);for(var u=n;u<=i;u++)e[d][u]=new g(l),e[d][u].isColspan=o&&1<parseInt(o,10),e[d][u].isRowspan=a&&1<parseInt(a,10),e[d][u].firstCol=u==n,e[d][u].lastCol=u==i,e[d][u].firstRow=d==t,e[d][u].lastRow=d==s,e[d][u].isReal=u==n&&d==t,e[d][u].spanCollection=r,r.push(e[d][u])}},setCellAsModified:function(o){if(o.modified=!0,0<o.spanCollection.length)for(var e=0,a=o.spanCollection.length;e<a;e++)o.spanCollection[e].modified=!0},setTableMap:function(){var s,l,u,f,h,b,C,w,N=[],e=this.getTableRows();for(s=0;s<e.length;s++)for(l=e[s],u=this.getRowCells(l),b=0,"undefined"==typeof N[s]&&(N[s]=[]),f=0;f<u.length;f++){// If cell allready set means it is set by col or rowspan,
// so increase cols index until free col is found
for(h=u[f];"undefined"!=typeof N[s][b];)b++;C=y.getAttribute(h,"colspan"),w=y.getAttribute(h,"rowspan"),C||w?(this.addSpannedCellToMap(h,N,s,b,C,w),b+=C?parseInt(C,10):1):(N[s][b]=new g(h),b++)}return this.map=N,N},getRowCells:function(t){var n=this.table.querySelectorAll("table"),o=n?e(n,"th, td"):[],a=t.querySelectorAll("th, td"),r=0<o.length?d.lang.array(a).without(o):a;return r},getTableRows:function(){var t=this.table.querySelectorAll("table"),n=t?e(t,"tr"):[],o=this.table.querySelectorAll("tr"),a=0<n.length?d.lang.array(o).without(n):o;return a},getMapIndex:function(r){for(var e=this.map.length,t=this.map&&this.map[0]?this.map[0].length:0,n=0;n<e;n++)for(var s=0;s<t;s++)if(this.map[n][s].el===r)return{row:n,col:s};return!1},getElementAtIndex:function(t){return this.setTableMap(),this.map[t.row]&&this.map[t.row][t.col]&&this.map[t.row][t.col].el?this.map[t.row][t.col].el:null},getMapElsTo:function(i){var e=[];// switch indexes if start is bigger than end
if(this.setTableMap(),this.idx_start=this.getMapIndex(this.cell),this.idx_end=this.getMapIndex(i),this.idx_start.row>this.idx_end.row||this.idx_start.row==this.idx_end.row&&this.idx_start.col>this.idx_end.col){var t=this.idx_start;this.idx_start=this.idx_end,this.idx_end=t}if(this.idx_start.col>this.idx_end.col){var n=this.idx_start.col;this.idx_start.col=this.idx_end.col,this.idx_end.col=n}if(null!=this.idx_start&&null!=this.idx_end)for(var o=this.idx_start.row,d=this.idx_end.row;o<=d;o++)for(var r=this.idx_start.col,m=this.idx_end.col;r<=m;r++)e.push(this.map[o][r].el);return e},orderSelectionEnds:function(o){// switch indexes if start is bigger than end
if(this.setTableMap(),this.idx_start=this.getMapIndex(this.cell),this.idx_end=this.getMapIndex(o),this.idx_start.row>this.idx_end.row||this.idx_start.row==this.idx_end.row&&this.idx_start.col>this.idx_end.col){var e=this.idx_start;this.idx_start=this.idx_end,this.idx_end=e}if(this.idx_start.col>this.idx_end.col){var t=this.idx_start.col;this.idx_start.col=this.idx_end.col,this.idx_end.col=t}return{start:this.map[this.idx_start.row][this.idx_start.col].el,end:this.map[this.idx_end.row][this.idx_end.col].el}},createCells:function(i,e,t){for(var n,d=this.table.ownerDocument,o=d.createDocumentFragment(),a=0;a<e;a++){if(n=d.createElement(i),t)for(var m in t)t.hasOwnProperty(m)&&n.setAttribute(m,t[m]);// add non breaking space
n.appendChild(document.createTextNode("\xA0")),o.appendChild(n)}return o},// Returns next real cell (not part of spanned cell unless first) on row if selected index is not real. I no real cells -1 will be returned
correctColIndexForUnreals:function(r,e){for(var t=this.map[e],n=-1,s=0;s<r;s++)t[s].isReal&&n++;return n},getLastNewCellOnRow:function(l,e){for(var t,i,d=this.getRowCells(l),n=0,m=d.length;n<m;n++)if(t=d[n],i=this.getMapIndex(t),!1===i||"undefined"!=typeof e&&i.row!=e)return t;return null},removeEmptyTable:function(){var t=this.table.querySelectorAll("td, th");return!(t&&0!=t.length)&&(r(this.table),!0)},// Splits merged cell on row to unique cells
splitRowToCells:function(o){if(o.isColspan){var e=parseInt(y.getAttribute(o.el,"colspan")||1,10),t=o.el.tagName.toLowerCase();if(1<e){var n=this.createCells(t,e-1);h(o.el,n)}o.el.removeAttribute("colspan")}},getRealRowEl:function(r,e){var s=null,i=null;e=e||this.idx;for(var d=0,m=this.map[e.row].length;d<m;d++)if(i=this.map[e.row][d],i.isReal&&(s=y.getParentElement(i.el,{nodeName:["TR"]}),s))return s;return null===s&&r&&(s=y.getParentElement(this.map[e.row][e.col].el,{nodeName:["TR"]})||null),s},injectRowAt:function(o,e,t,n,a){var s=this.getRealRowEl(!1,{row:o,col:e}),l=this.createCells(n,t);if(s){var r=this.correctColIndexForUnreals(e,o);0<=r?h(this.getRowCells(s)[r],l):s.insertBefore(l,s.firstChild)}else{var i=this.table.ownerDocument.createElement("tr");i.appendChild(l),h(y.getParentElement(a.el,{nodeName:["TR"]}),i)}},canMerge:function(l){// switch indexes if start is bigger than end
if(this.to=l,this.setTableMap(),this.idx_start=this.getMapIndex(this.cell),this.idx_end=this.getMapIndex(this.to),this.idx_start.row>this.idx_end.row||this.idx_start.row==this.idx_end.row&&this.idx_start.col>this.idx_end.col){var e=this.idx_start;this.idx_start=this.idx_end,this.idx_end=e}if(this.idx_start.col>this.idx_end.col){var t=this.idx_start.col;this.idx_start.col=this.idx_end.col,this.idx_end.col=t}for(var n=this.idx_start.row,i=this.idx_end.row;n<=i;n++)for(var a=this.idx_start.col,d=this.idx_end.col;a<=d;a++)if(this.map[n][a].isColspan||this.map[n][a].isRowspan)return!1;return!0},decreaseCellSpan:function(o,e){var t=parseInt(y.getAttribute(o.el,e),10)-1;1<=t?o.el.setAttribute(e,t):(o.el.removeAttribute(e),"colspan"==e&&(o.isColspan=!1),"rowspan"==e&&(o.isRowspan=!1),o.firstCol=!0,o.lastCol=!0,o.firstRow=!0,o.lastRow=!0,o.isReal=!0)},removeSurplusLines:function(){var n,s,m,p,g,u,f;if(this.setTableMap(),this.map){for(m=0,p=this.map.length;m<p;m++){for(n=this.map[m],f=!0,g=0,u=n.length;g<u;g++)if(s=n[g],!(y.getAttribute(s.el,"rowspan")&&1<parseInt(y.getAttribute(s.el,"rowspan"),10)&&!0!==s.firstRow)){f=!1;break}if(f)for(g=0;g<u;g++)this.decreaseCellSpan(n[g],"rowspan")}// remove rows without cells
var h=this.getTableRows();for(m=0,p=h.length;m<p;m++)n=h[m],0==n.childNodes.length&&/^\s*$/.test(n.textContent||n.innerText)&&r(n)}},fillMissingCells:function(){var o=0,l=0,i=null;if(this.setTableMap(),this.map){o=this.map.length;for(var d=0;d<o;d++)this.map[d].length>l&&(l=this.map[d].length);for(var m=0;m<o;m++)for(var p=0;p<l;p++)this.map[m]&&!this.map[m][p]&&0<p&&(this.map[m][p]=new g(this.createCells("td",1)),i=this.map[m][p-1],i&&i.el&&i.el.parent&&h(this.map[m][p-1].el,this.map[m][p].el))}},rectify:function(){return!this.removeEmptyTable()&&(this.removeSurplusLines(),this.fillMissingCells(),!0)},unmerge:function(){if(this.rectify()&&(this.setTableMap(),this.idx=this.getMapIndex(this.cell),this.idx)){var r=this.map[this.idx.row][this.idx.col],e=y.getAttribute(r.el,"colspan")?parseInt(y.getAttribute(r.el,"colspan"),10):1,t=r.el.tagName.toLowerCase();if(r.isRowspan){var n=parseInt(y.getAttribute(r.el,"rowspan"),10);if(1<n)for(var o=1;o<=n-1;o++)this.injectRowAt(this.idx.row+o,this.idx.col,e,t,r);r.el.removeAttribute("rowspan")}this.splitRowToCells(r)}},// merges cells from start cell (defined in creating obj) to "to" cell
merge:function(n){if(this.rectify())if(this.canMerge(n)){for(var e=this.idx_end.row-this.idx_start.row+1,t=this.idx_end.col-this.idx_start.col+1,o=this.idx_start.row,i=this.idx_end.row;o<=i;o++)for(var d=this.idx_start.col,m=this.idx_end.col;d<=m;d++)o==this.idx_start.row&&d==this.idx_start.col?(1<e&&this.map[o][d].el.setAttribute("rowspan",e),1<t&&this.map[o][d].el.setAttribute("colspan",t)):(/^\s*<br\/?>\s*$/.test(this.map[o][d].el.innerHTML.toLowerCase())||(this.map[this.idx_start.row][this.idx_start.col].el.innerHTML+=" "+this.map[o][d].el.innerHTML),r(this.map[o][d].el));this.rectify()}else window.console&&console.log("Do not know how to merge allready merged cells.")},// Decreases rowspan of a cell if it is done on first cell of rowspan row (real cell)
// Cell is moved to next row (if it is real)
collapseCellToNextRow:function(o){var e=this.getMapIndex(o.el),t=e.row+1,n={row:t,col:e.col};if(t<this.map.length){var a=this.getRealRowEl(!1,n);if(null!==a){var r=this.correctColIndexForUnreals(n.col,n.row);if(0<=r)h(this.getRowCells(a)[r],o.el);else{var s=this.getLastNewCellOnRow(a,t);null===s?a.insertBefore(o.el,a.firstChild):h(s,o.el)}2<parseInt(y.getAttribute(o.el,"rowspan"),10)?o.el.setAttribute("rowspan",parseInt(y.getAttribute(o.el,"rowspan"),10)-1):o.el.removeAttribute("rowspan")}}},// Removes a cell when removing a row
// If is rowspan cell then decreases the rowspan
// and moves cell to next row if needed (is first cell of rowspan)
removeRowCell:function(t){t.isReal?t.isRowspan?this.collapseCellToNextRow(t):r(t.el):2<parseInt(y.getAttribute(t.el,"rowspan"),10)?t.el.setAttribute("rowspan",parseInt(y.getAttribute(t.el,"rowspan"),10)-1):t.el.removeAttribute("rowspan")},getRowElementsByCell:function(){var a=[];if(this.setTableMap(),this.idx=this.getMapIndex(this.cell),!1!==this.idx)for(var e=this.map[this.idx.row],t=0,r=e.length;t<r;t++)e[t].isReal&&a.push(e[t].el);return a},getColumnElementsByCell:function(){var o=[];if(this.setTableMap(),this.idx=this.getMapIndex(this.cell),!1!==this.idx)for(var e=0,a=this.map.length;e<a;e++)this.map[e][this.idx.col]&&this.map[e][this.idx.col].isReal&&o.push(this.map[e][this.idx.col].el);return o},// Removes the row of selected cell
removeRow:function(){var n=y.getParentElement(this.cell,{nodeName:["TR"]});if(n){if(this.setTableMap(),this.idx=this.getMapIndex(this.cell),!1!==this.idx)for(var e=this.map[this.idx.row],t=0,s=e.length;t<s;t++)e[t].modified||(this.setCellAsModified(e[t]),this.removeRowCell(e[t]));r(n)}},removeColCell:function(t){t.isColspan?2<parseInt(y.getAttribute(t.el,"colspan"),10)?t.el.setAttribute("colspan",parseInt(y.getAttribute(t.el,"colspan"),10)-1):t.el.removeAttribute("colspan"):t.isReal&&r(t.el)},removeColumn:function(){if(this.setTableMap(),this.idx=this.getMapIndex(this.cell),!1!==this.idx)for(var n=0,o=this.map.length;n<o;n++)this.map[n][this.idx.col].modified||(this.setCellAsModified(this.map[n][this.idx.col]),this.removeColCell(this.map[n][this.idx.col]))},// removes row or column by selected cell element
remove:function(t){this.rectify()&&("row"===t?this.removeRow():"column"===t?this.removeColumn():void 0,this.rectify())},addRow:function(o){var e=this.table.ownerDocument;if(this.setTableMap(),this.idx=this.getMapIndex(this.cell),"below"==o&&y.getAttribute(this.cell,"rowspan")&&(this.idx.row=this.idx.row+parseInt(y.getAttribute(this.cell,"rowspan"),10)-1),!1!==this.idx){for(var t=this.map[this.idx.row],n=e.createElement("tr"),a=0,s=t.length;a<s;a++)t[a].modified||(this.setCellAsModified(t[a]),this.addRowCell(t[a],n,o));switch(o){case"below":h(this.getRealRowEl(!0),n);break;case"above":var l=y.getParentElement(this.map[this.idx.row][this.idx.col].el,{nodeName:["TR"]});l&&l.parentNode.insertBefore(n,l);}}},addRowCell:function(a,e,t){var n=a.isColspan?{colspan:y.getAttribute(a.el,"colspan")}:null;a.isReal?"above"!=t&&a.isRowspan?a.el.setAttribute("rowspan",parseInt(y.getAttribute(a.el,"rowspan"),10)+1):e.appendChild(this.createCells("td",1,n)):"above"!=t&&a.isRowspan&&a.lastRow?e.appendChild(this.createCells("td",1,n)):c.isRowspan&&a.el.attr("rowspan",parseInt(y.getAttribute(a.el,"rowspan"),10)+1)},add:function(t){this.rectify()&&(("below"==t||"above"==t)&&this.addRow(t),("before"==t||"after"==t)&&this.addColumn(t))},addColCell:function(o,e,t){var n,s=o.el.tagName.toLowerCase();// defines add cell vs expand cell conditions
// true means add
"before"===t?n=!o.isColspan||o.firstCol:"after"===t?n=!o.isColspan||o.lastCol||o.isColspan&&c.el==this.cell:void 0,n?(// adds a cell before or after current cell element
"before"===t?o.el.parentNode.insertBefore(this.createCells(s,1),o.el):"after"===t?h(o.el,this.createCells(s,1)):void 0,o.isRowspan&&this.handleCellAddWithRowspan(o,e+1,t)):// expands cell
o.el.setAttribute("colspan",parseInt(y.getAttribute(o.el,"colspan"),10)+1)},addColumn:function(r){var e,s;if(this.setTableMap(),this.idx=this.getMapIndex(this.cell),"after"==r&&y.getAttribute(this.cell,"colspan")&&(this.idx.col=this.idx.col+parseInt(y.getAttribute(this.cell,"colspan"),10)-1),!1!==this.idx)for(var l=0,i=this.map.length;l<i;l++)e=this.map[l],e[this.idx.col]&&(s=e[this.idx.col],!s.modified&&(this.setCellAsModified(s),this.addColCell(s,l,r)))},handleCellAddWithRowspan:function(a,e,t){for(var n,s,i,b=parseInt(y.getAttribute(this.cell,"rowspan"),10)-1,r=y.getParentElement(a.el,{nodeName:["TR"]}),C=a.el.tagName.toLowerCase(),d=this.table.ownerDocument,m=0;m<b;m++)n=this.correctColIndexForUnreals(this.idx.col,e+m),r=o(r,"tr"),r?0<n?"before"===t?(s=this.getRowCells(r),0<n&&this.map[e+m][this.idx.col].el!=s[n]&&n==s.length-1?h(s[n],this.createCells(C,1)):s[n].parentNode.insertBefore(this.createCells(C,1),s[n])):"after"===t?h(this.getRowCells(r)[n],this.createCells(C,1)):void 0:r.insertBefore(this.createCells(C,1),r.firstChild):(i=d.createElement("tr"),i.appendChild(this.createCells(C,1)),this.table.appendChild(i))}},y.table={getCellsBetween:function(o,e){var t=new a(o);return t.getMapElsTo(e)},addCells:function(o,e){var t=new a(o);t.add(e)},removeCells:function(o,e){var t=new a(o);t.remove(e)},mergeCellsBetween:function(o,e){var t=new a(o);t.merge(e)},unmergeCell:function(n){var e=new a(n);e.unmerge()},orderSelectionEnds:function(o,e){var t=new a(o);return t.orderSelectionEnds(e)},indexOf:function(n){var e=new a(n);return e.setTableMap(),e.getMapIndex(n)},findCell:function(o,e){var t=new a(null,o);return t.getElementAtIndex(e)},findRowByCell:function(n){var e=new a(n);return e.getRowElementsByCell()},findColumnByCell:function(n){var e=new a(n);return e.getColumnElementsByCell()},canMerge:function(o,e){var t=new a(o);return t.canMerge(e)}}}(wysihtml5),wysihtml5.dom.query=function(e,i){var n,d=[];e.nodeType&&(e=[e]);for(var o=0,m=e.length;o<m;o++)if(n=e[o].querySelectorAll(i),n)for(var s=n.length;s--;d.unshift(n[s]));return d},wysihtml5.dom.compareDocumentPosition=function(){var t=document.documentElement;return t.compareDocumentPosition?function(n,e){return n.compareDocumentPosition(e)}:function(p,e){// implementation borrowed from https://github.com/tmpvar/jsdom/blob/681a8524b663281a0f58348c6129c8c184efc62c/lib/jsdom/level3/core.js // MIT license
var t,g;if(t=9===p.nodeType?// Node.DOCUMENT_NODE
p:p.ownerDocument,g=9===e.nodeType?// Node.DOCUMENT_NODE
e:e.ownerDocument,p===e)return 0;if(p===e.ownerDocument)return 20;//Node.DOCUMENT_POSITION_FOLLOWING + Node.DOCUMENT_POSITION_CONTAINED_BY;
if(p.ownerDocument===e)return 10;//Node.DOCUMENT_POSITION_PRECEDING + Node.DOCUMENT_POSITION_CONTAINS;
if(t!==g)return 1;// Node.DOCUMENT_POSITION_DISCONNECTED;
// Text nodes for attributes does not have a _parentNode. So we need to find them as attribute child.
if(2===p.nodeType/*Node.ATTRIBUTE_NODE*/&&p.childNodes&&-1!==wysihtml5.lang.array(p.childNodes).indexOf(e))return 20;//Node.DOCUMENT_POSITION_FOLLOWING + Node.DOCUMENT_POSITION_CONTAINED_BY;
if(2===e.nodeType/*Node.ATTRIBUTE_NODE*/&&e.childNodes&&-1!==wysihtml5.lang.array(e.childNodes).indexOf(p))return 10;//Node.DOCUMENT_POSITION_PRECEDING + Node.DOCUMENT_POSITION_CONTAINS;
for(var u=p,f=[],r=null;u;){if(u==e)return 10;//Node.DOCUMENT_POSITION_PRECEDING + Node.DOCUMENT_POSITION_CONTAINS;
f.push(u),u=u.parentNode}for(u=e,r=null;u;){if(u==p)return 20;//Node.DOCUMENT_POSITION_FOLLOWING + Node.DOCUMENT_POSITION_CONTAINED_BY;
var h=wysihtml5.lang.array(f).indexOf(u);if(-1!==h){var l=f[h],i=wysihtml5.lang.array(l.childNodes).indexOf(f[h-1]),d=wysihtml5.lang.array(l.childNodes).indexOf(r);//smallest_common_ancestor.childNodes.toArray().indexOf( previous );
return i>d?2:4}r=u,u=u.parentNode}return 1;//Node.DOCUMENT_POSITION_DISCONNECTED;
}}(),wysihtml5.dom.unwrap=function(t){if(t.parentNode){for(;t.lastChild;)wysihtml5.dom.insert(t.lastChild).after(t);t.parentNode.removeChild(t)}},wysihtml5.dom.getPastedHtml=function(n){var e;return n.clipboardData&&(wysihtml5.lang.array(n.clipboardData.types).contains("text/html")?e=n.clipboardData.getData("text/html"):wysihtml5.lang.array(n.clipboardData.types).contains("text/plain")&&(e=wysihtml5.lang.string(n.clipboardData.getData("text/plain")).escapeHTML(!0,!0))),e},wysihtml5.dom.getPastedHtmlWithDiv=function(r,e){var t=r.selection.getBookmark(),n=r.element.ownerDocument,o=n.createElement("DIV");n.body.appendChild(o),o.style.width="1px",o.style.height="1px",o.style.overflow="hidden",o.setAttribute("contenteditable","true"),o.focus(),setTimeout(function(){r.selection.setBookmark(t),e(o.innerHTML),o.parentNode.removeChild(o)},0)},wysihtml5.quirks.cleanPastedHTML=function(){var s=function(e){var o=wysihtml5.lang.string(e).trim(),t=o.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");return new RegExp("^((?!^"+t+"$).)*$","i")},l=function(e,t){var n,l,i=wysihtml5.lang.object(e).clone(!0);for(n in i.tags)if(i.tags.hasOwnProperty(n)&&i.tags[n].keep_styles)for(l in i.tags[n].keep_styles)i.tags[n].keep_styles.hasOwnProperty(l)&&t[l]&&(i.tags[n].keep_styles[l]=s(t[l]));return i},t=function(r,e){var t;if(!r)return null;for(var s=0,l=r.length;s<l;s++)if(r[s].condition||(t=r[s].set),r[s].condition&&r[s].condition.test(e))return r[s].set;return t};return function(n,e){var o,i={color:wysihtml5.dom.getStyle("color").from(e.referenceNode),fontSize:wysihtml5.dom.getStyle("font-size").from(e.referenceNode)},a=l(t(e.rules,n)||{},i);return o=wysihtml5.dom.parse(n,{rules:a,cleanUp:!0,// <span> elements, empty or without attributes, should be removed/replaced with their content
context:e.referenceNode.ownerDocument,uneditableClass:e.uneditableClass,clearInternals:!0,// don't paste temprorary selection and other markings
unjoinNbsps:!0}),o}}(),wysihtml5.quirks.ensureProperClearing=function(){var n=function(){var n=this;setTimeout(function(){var e=n.innerHTML.toLowerCase();("<p>&nbsp;</p>"==e||"<p>&nbsp;</p><p>&nbsp;</p>"==e)&&(n.innerHTML="")},0)};return function(e){wysihtml5.dom.observe(e.element,["cut","keydown"],n)}}(),function(t){t.quirks.getCorrectInnerHTML=function(e){var i=e.innerHTML;if(-1===i.indexOf("%7E"))return i;var d,m,p,g,u=e.querySelectorAll("[href*='~'], [src*='~']");for(g=0,p=u.length;g<p;g++)d=u[g].href||u[g].src,m=t.lang.string(d).replace("~").by("%7E"),i=t.lang.string(i).replace(m).by(d);return i}}(wysihtml5),function(o){o.quirks.redraw=function(e){o.dom.addClass(e,"wysihtml5-quirks-redraw"),o.dom.removeClass(e,"wysihtml5-quirks-redraw");// Following hack is needed for firefox to make sure that image resize handles are properly removed
try{var t=e.ownerDocument;t.execCommand("italic",!1,null),t.execCommand("italic",!1,null)}catch(e){}}}(wysihtml5),wysihtml5.quirks.tableCellsSelection=function(i,u){function f(o){d.start=o,d.end=o,d.cells=[o],d.table=l.getParentElement(d.start,{nodeName:["TABLE"]}),d.table&&(t(),l.addClass(o,"wysiwyg-tmp-selected-cell"),s=l.observe(i,"mousemove",e),m=l.observe(i,"mouseup",a),u.fire("tableselectstart").fire("tableselectstart:composer"))}// remove all selection classes
function t(){if(i){var e=i.querySelectorAll(".wysiwyg-tmp-selected-cell");if(0<e.length)for(var t=0;t<e.length;t++)l.removeClass(e[t],"wysiwyg-tmp-selected-cell")}}function o(n){for(var e=0;e<n.length;e++)l.addClass(n[e],"wysiwyg-tmp-selected-cell")}function e(a){var e,i=null,m=l.getParentElement(a.target,{nodeName:["TD","TH"]});m&&d.table&&d.start&&(i=l.getParentElement(m,{nodeName:["TABLE"]}),i&&i===d.table&&(t(),e=d.end,d.end=m,d.cells=l.table.getCellsBetween(d.start,m),1<d.cells.length&&u.composer.selection.deselect(),o(d.cells),d.end!==e&&u.fire("tableselectchange").fire("tableselectchange:composer")))}function a(){s.stop(),m.stop(),u.fire("tableselect").fire("tableselect:composer"),setTimeout(function(){r()},0)}function r(){var o=l.observe(i.ownerDocument,"click",function(n){o.stop(),l.getParentElement(n.target,{nodeName:["TABLE"]})!=d.table&&(t(),d.table=null,d.start=null,d.end=null,u.fire("tableunselect").fire("tableunselect:composer"))})}var l=wysihtml5.dom,d={table:null,start:null,end:null,cells:null,select:function n(t,e){d.start=t,d.end=e,d.table=l.getParentElement(d.start,{nodeName:["TABLE"]}),selectedCells=l.table.getCellsBetween(d.start,d.end),o(selectedCells),r(),u.fire("tableselect").fire("tableselect:composer")}},s=null,m=null;return function(){return l.observe(i,"mousedown",function(n){var e=wysihtml5.dom.getParentElement(n.target,{nodeName:["TD","TH"]});e&&f(e)}),d}()},function(s){var e=/^rgba\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*([\d\.]+)\s*\)/i,t=/^rgb\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)/i,n=/^#([0-9a-f][0-9a-f])([0-9a-f][0-9a-f])([0-9a-f][0-9a-f])/i,o=/^#([0-9a-f])([0-9a-f])([0-9a-f])/i,a=function(t){return new RegExp("(^|\\s|;)"+t+"\\s*:\\s*[^;$]+","gi")};s.quirks.styleParser={parseColor:function(r,i){var l,h,y=a(i),d=r.match(y),m=10;if(d){for(var b=d.length;b--;)d[b]=s.lang.string(d[b].split(":")[1]).trim();if(l=d[d.length-1],e.test(l))h=l.match(e);else if(t.test(l))h=l.match(t);else if(n.test(l))h=l.match(n),m=16;else if(o.test(l))return h=l.match(o),h.shift(),h.push(1),s.lang.array(h).map(function(n,e){return 3>e?16*parseInt(n,16)+parseInt(n,16):parseFloat(n)});if(h)return h.shift(),h[3]||h.push(1),s.lang.array(h).map(function(n,e){return 3>e?parseInt(n,m):parseFloat(n)})}return!1},unparseColor:function(n,e){if(e){if("hex"==e)return n[0].toString(16).toUpperCase()+n[1].toString(16).toUpperCase()+n[2].toString(16).toUpperCase();if("hash"==e)return"#"+n[0].toString(16).toUpperCase()+n[1].toString(16).toUpperCase()+n[2].toString(16).toUpperCase();if("rgb"==e)return"rgb("+n[0]+","+n[1]+","+n[2]+")";if("rgba"==e)return"rgba("+n[0]+","+n[1]+","+n[2]+","+n[3]+")";if("csv"==e)return n[0]+","+n[1]+","+n[2]+","+n[3]}return n[3]&&1!==n[3]?"rgba("+n[0]+","+n[1]+","+n[2]+","+n[3]+")":"rgb("+n[0]+","+n[1]+","+n[2]+")"},parseFontSize:function(e){var t=e.match(a("font-size"));return!!t&&s.lang.string(t[t.length-1].split(":")[1]).trim()}}}(wysihtml5),function(w){function e(n){var o=0;if(n.parentNode)do o+=n.offsetTop||0,n=n.offsetParent;while(n);return o}// Provides the depth of ``descendant`` relative to ``ancestor``
function r(o,e){for(var a=0;e!==o;)if(a++,e=e.parentNode,!e)throw new Error("not a descendant of ancestor!");return a}// Should fix the obtained ranges that cannot surrond contents normally to apply changes upon
// Being considerate to firefox that sets range start start out of span and end inside on doubleclick initiated selection
function t(n){if(!n.canSurroundContents())for(var e=n.commonAncestorContainer,t=r(e,n.startContainer),s=r(e,n.endContainer);!n.canSurroundContents();)// In the following branches, we cannot just decrement the depth variables because the setStartBefore/setEndAfter may move the start or end of the range more than one level relative to ``common``. So we need to recompute the depth.
t>s?(n.setStartBefore(n.startContainer),t=r(e,n.startContainer)):(n.setEndAfter(n.endContainer),s=r(e,n.endContainer))}var f=w.dom;w.Selection=Base.extend(/** @scope wysihtml5.Selection.prototype */{constructor:function(o,e,t){// Make sure that our external range library is initialized
window.rangy.init(),this.editor=o,this.composer=o.composer,this.doc=this.composer.doc,this.contain=e,this.unselectableClass=t||!1},/**
     * Get the current selection as a bookmark to be able to later restore it
     *
     * @return {Object} An object that represents the current selection
     */getBookmark:function(){var n=this.getRange();return n&&t(n),n&&n.cloneRange()},/**
     * Restore a selection retrieved via wysihtml5.Selection.prototype.getBookmark
     *
     * @param {Object} bookmark An object that represents the current selection
     */setBookmark:function(t){t&&this.setSelection(t)},/**
     * Set the caret in front of the given node
     *
     * @param {Object} node The element or text node where to position the caret in front of
     * @example
     *    selection.setBefore(myElement);
     */setBefore:function(n){var e=rangy.createRange(this.doc);return e.setStartBefore(n),e.setEndBefore(n),this.setSelection(e)},/**
     * Set the caret after the given node
     *
     * @param {Object} node The element or text node where to position the caret in front of
     * @example
     *    selection.setBefore(myElement);
     */setAfter:function(n){var e=rangy.createRange(this.doc);return e.setStartAfter(n),e.setEndAfter(n),this.setSelection(e)},/**
     * Ability to select/mark nodes
     *
     * @param {Element} node The node/element to select
     * @example
     *    selection.selectNode(document.getElementById("my-image"));
     */selectNode:function(e,t){var n=rangy.createRange(this.doc),o=e.nodeType===w.ELEMENT_NODE,a="canHaveHTML"in e?e.canHaveHTML:"IMG"!==e.nodeName,r=o?e.innerHTML:e.data,s=""===r||r===w.INVISIBLE_SPACE,l=f.getStyle("display").from(e);if(s&&o&&a&&!t)// Make sure that caret is visible in node by inserting a zero width no breaking space
try{e.innerHTML=w.INVISIBLE_SPACE}catch(e){}a?n.selectNodeContents(e):n.selectNode(e),a&&s&&o?n.collapse("block"===l||"list-item"===l):a&&s&&(n.setStartAfter(e),n.setEndAfter(e)),this.setSelection(n)},/**
     * Get the node which contains the selection
     *
     * @param {Boolean} [controlRange] (only IE) Whether it should return the selected ControlRange element when the selection type is a "ControlRange"
     * @return {Object} The node that contains the caret
     * @example
     *    var nodeThatContainsCaret = selection.getSelectedNode();
     */getSelectedNode:function(o){var e,a;return o&&this.doc.selection&&"Control"===this.doc.selection.type&&(a=this.doc.selection.createRange(),a&&a.length)?a.item(0):(e=this.getSelection(this.doc),e.focusNode===e.anchorNode?e.focusNode:(a=this.getRange(this.doc),a?a.commonAncestorContainer:this.doc.body))},fixSelBorders:function(){var n=this.getRange();t(n),this.setSelection(n)},getSelectedOwnNodes:function(){for(var a=this.getOwnRanges(),e=[],t=0,r=a.length;t<r;t++)e.push(a[t].commonAncestorContainer||this.doc.body);return e},findNodesInSelection:function(e){for(var t,l=this.getOwnRanges(),n=[],i=0,d=l.length;i<d;i++)t=l[i].getNodes([1],function(t){return w.lang.array(e).contains(t.nodeName)}),n=n.concat(t);return n},containsUneditable:function(){for(var a=this.getOwnUneditables(),e=this.getSelection(),t=0,r=a.length;t<r;t++)if(e.containsNode(a[t]))return!0;return!1},deleteContents:function(){for(var n=this.getOwnRanges(),e=n.length;e--;)n[e].deleteContents();this.setSelection(n[0])},getPreviousNode:function(e,s){if(!e){var n=this.getSelection();e=n.anchorNode}if(e===this.contain)return!1;var o,l=e.previousSibling;return l!==this.contain&&(l&&3!==l.nodeType&&1!==l.nodeType?l=this.getPreviousNode(l,s):l&&3===l.nodeType&&/^\s*$/.test(l.textContent)?l=this.getPreviousNode(l,s):s&&l&&1===l.nodeType&&!w.lang.array(["BR","HR","IMG"]).contains(l.nodeName)&&/^[\s]*$/.test(l.innerHTML)?l=this.getPreviousNode(l,s):!l&&e!==this.contain&&(o=e.parentNode,o!==this.contain&&(l=this.getPreviousNode(o,s))),l!==this.contain&&l)},getSelectionParentsByTag:function(){for(var e,s=this.getSelectedOwnNodes(),t=[],n=0,l=s.length;n<l;n++)e=s[n].nodeName&&"LI"===s[n].nodeName?s[n]:w.dom.getParentElement(s[n],{nodeName:["LI"]},!1,this.contain),e&&t.push(e);return t.length?t:null},getRangeToNodeEnd:function(){if(this.isCollapsed()){var a=this.getRange(),e=a.startContainer,t=a.startOffset,n=rangy.createRange(this.doc);return n.selectNodeContents(e),n.setStart(e,t),n}},caretIsLastInSelection:function(){var a=rangy.createRange(this.doc),e=this.getSelection(),t=this.getRangeToNodeEnd().cloneContents(),n=t.textContent;return /^\s*$/.test(n)},caretIsFirstInSelection:function(){var e=rangy.createRange(this.doc),t=this.getSelection(),n=this.getRange(),o=n.startContainer;return o.nodeType===w.TEXT_NODE?this.isCollapsed()&&o.nodeType===w.TEXT_NODE&&/^\s*$/.test(o.data.substr(0,n.startOffset)):(e.selectNodeContents(this.getRange().commonAncestorContainer),e.collapse(!0),this.isCollapsed()&&(e.startContainer===t.anchorNode||e.endContainer===t.anchorNode)&&e.startOffset===t.anchorOffset)},caretIsInTheBeginnig:function(e){var t=this.getSelection(),n=t.anchorNode,o=t.anchorOffset;return e?0===o&&(n.nodeName&&n.nodeName===e.toUpperCase()||w.dom.getParentElement(n.parentNode,{nodeName:e},1)):0===o&&!this.getPreviousNode(n,!0)},caretIsBeforeUneditable:function(){var l=this.getSelection(),e=l.anchorNode,t=l.anchorOffset;if(0===t){var n=this.getPreviousNode(e,!0);if(n)for(var o=this.getOwnUneditables(),a=0,i=o.length;a<i;a++)if(n===o[a])return o[a]}return!1},// TODO: Figure out a method from following 2 that would work universally
executeAndRestoreRangy:function(o){var e=this.doc.defaultView||this.doc.parentWindow,t=rangy.saveSelection(e);if(!t)o();else try{o()}catch(e){setTimeout(function(){throw e},0)}rangy.restoreSelection(t)},// TODO: has problems in chrome 12. investigate block level and uneditable area inbetween
executeAndRestore:function(e,t){var n,a,i,N,x,E,S,v,T=this.doc.body,o=t&&T.scrollTop,r=t&&T.scrollLeft,s="<span class=\"_wysihtml5-temp-placeholder\">"+w.INVISIBLE_SPACE+"</span>",l=this.getRange(!0);// Nothing selected, execute and say goodbye
if(!l)return void e(T,T);l.collapsed||(S=l.cloneRange(),E=S.createContextualFragment(s),S.collapse(!1),S.insertNode(E),S.detach()),x=l.createContextualFragment(s),l.insertNode(x),E&&(n=this.contain.querySelectorAll("._wysihtml5-temp-placeholder"),l.setStartBefore(n[0]),l.setEndAfter(n[n.length-1])),this.setSelection(l);// Make sure that a potential error doesn't cause our placeholder element to be left as a placeholder
try{e(l.startContainer,l.endContainer)}catch(e){setTimeout(function(){throw e},0)}if(n=this.contain.querySelectorAll("._wysihtml5-temp-placeholder"),n&&n.length){v=rangy.createRange(this.doc),i=n[0].nextSibling,1<n.length&&(N=n[n.length-1].previousSibling),N&&i?(v.setStartBefore(i),v.setEndAfter(N)):(a=this.doc.createTextNode(w.INVISIBLE_SPACE),f.insert(a).after(n[0]),v.setStartBefore(a),v.setEndAfter(a)),this.setSelection(v);for(var d=n.length;d--;)n[d].parentNode.removeChild(n[d])}else// fallback for when all hell breaks loose
this.contain.focus();t&&(T.scrollTop=o,T.scrollLeft=r);// Remove it again, just to make sure that the placeholder is definitely out of the dom tree
try{n.parentNode.removeChild(n)}catch(t){}},set:function(o,e){var t=rangy.createRange(this.doc);t.setStart(o,e||0),this.setSelection(t)},/**
     * Insert html at the caret position and move the cursor after the inserted html
     *
     * @param {String} html HTML string to insert
     * @example
     *    selection.insertHTML("<p>foobar</p>");
     */insertHTML:function(r){var e,s=rangy.createRange(this.doc),t=this.doc.createElement("DIV"),n=this.doc.createDocumentFragment();for(t.innerHTML=r,e=t.lastChild;t.firstChild;)n.appendChild(t.firstChild);this.insertNode(n),e&&this.setAfter(e)},/**
     * Insert a node at the caret position and move the cursor behind it
     *
     * @param {Object} node HTML string to insert
     * @example
     *    selection.insertNode(document.createTextNode("foobar"));
     */insertNode:function(n){var e=this.getRange();e&&e.insertNode(n)},/**
     * Wraps current selection with the given node
     *
     * @param {Object} node The node to surround the selected elements with
     */surround:function(r){var e,s=this.getOwnRanges(),t=[];if(0==s.length)return t;for(var l=s.length;l--;){e=this.doc.createElement(r.nodeName),t.push(e),r.className&&(e.className=r.className),r.cssStyle&&e.setAttribute("style",r.cssStyle);try{// This only works when the range boundaries are not overlapping other elements
s[l].surroundContents(e),this.selectNode(e)}catch(t){// fallback
e.appendChild(s[l].extractContents()),s[l].insertNode(e)}}return t},deblockAndSurround:function(e){var t,l,i,d=this.doc.createElement("div"),m=rangy.createRange(this.doc);if(d.className=e.className,this.composer.commands.exec("formatBlock",e.nodeName,e.className),t=this.contain.querySelectorAll("."+e.className),t[0]){for(t[0].parentNode.insertBefore(d,t[0]),m.setStartBefore(t[0]),m.setEndAfter(t[t.length-1]),l=m.extractContents();l.firstChild;)if(i=l.firstChild,1==i.nodeType&&w.dom.hasClass(i,e.className)){for(;i.firstChild;)d.appendChild(i.firstChild);"BR"!==i.nodeName&&d.appendChild(this.doc.createElement("br")),l.removeChild(i)}else d.appendChild(i);}else d=null;return d},/**
     * Scroll the current caret position into the view
     * FIXME: This is a bit hacky, there might be a smarter way of doing this
     *
     * @example
     *    selection.scrollIntoView();
     */scrollIntoView:function(){var t,s=this.doc,// px
n=s.documentElement.scrollHeight>s.documentElement.offsetHeight,o=s._wysihtml5ScrollIntoViewElement=s._wysihtml5ScrollIntoViewElement||function(){var e=s.createElement("span");// The element needs content in order to be able to calculate it's position properly
return e.innerHTML=w.INVISIBLE_SPACE,e}();n&&(this.insertNode(o),t=e(o),o.parentNode.removeChild(o),t>=s.body.scrollTop+s.documentElement.offsetHeight-5&&(s.body.scrollTop=t))},/**
     * Select line where the caret is in
     */selectLine:function(){w.browser.supportsSelectionModify()?this._selectLine_W3C():this.doc.selection&&this._selectLine_MSIE()},/**
     * See https://developer.mozilla.org/en/DOM/Selection/modify
     */_selectLine_W3C:function(){var n=this.doc.defaultView,e=n.getSelection();e.modify("move","left","lineboundary"),e.modify("extend","right","lineboundary")},_selectLine_MSIE:function(){var i,d,m,p,g,u=this.doc.selection.createRange(),e=u.boundingTop,f=this.doc.body.scrollWidth;if(u.moveToPoint){for(0===e&&(m=this.doc.createElement("span"),this.insertNode(m),e=m.offsetTop,m.parentNode.removeChild(m)),e+=1,p=-10;p<f;p+=2)try{u.moveToPoint(p,e);break}catch(t){}// Investigate the following in order to handle multi line selections
// rangeBottom = rangeTop + (rangeHeight ? (rangeHeight - 1) : 0);
for(i=e,d=this.doc.selection.createRange(),g=f;0<=g;g--)try{d.moveToPoint(g,i);break}catch(t){}u.setEndPoint("EndToEnd",d),u.select()}},getText:function(){var t=this.getSelection();return t?t.toString():""},getNodes:function(o,e){var t=this.getRange();return t?t.getNodes([o],e):[]},fixRangeOverflow:function(o){if(this.contain&&this.contain.firstChild&&o){var e=o.compareNode(this.contain);if(2!==e)1===e&&o.setStartBefore(this.contain.firstChild),0===e&&o.setEndAfter(this.contain.lastChild),3===e&&(o.setStartBefore(this.contain.firstChild),o.setEndAfter(this.contain.lastChild));else if(this._detectInlineRangeProblems(o)){var t=o.endContainer.previousElementSibling;t&&o.setEnd(t,this._endOffsetForNode(t))}}},_endOffsetForNode:function(n){var e=document.createRange();return e.selectNodeContents(n),e.endOffset},_detectInlineRangeProblems:function(n){var e=f.compareDocumentPosition(n.startContainer,n.endContainer);return 0==n.endOffset&&4&e;//Node.DOCUMENT_POSITION_FOLLOWING
},getRange:function(o){var e=this.getSelection(),t=e&&e.rangeCount&&e.getRangeAt(0);return!0!==o&&this.fixRangeOverflow(t),t},getOwnUneditables:function(){var e=f.query(this.contain,"."+this.unselectableClass),t=f.query(e,"."+this.unselectableClass);return w.lang.array(e).without(t)},// Returns an array of ranges that belong only to this editable
// Needed as uneditable block in contenteditabel can split range into pieces
// If manipulating content reverse loop is usually needed as manipulation can shift subsequent ranges
getOwnRanges:function(){var i,m=[],p=this.getRange();if(p&&m.push(p),this.unselectableClass&&this.contain&&p){var t,g=this.getOwnUneditables();if(0<g.length)for(var o=0,u=g.length;o<u;o++){i=[];for(var s=0,f=m.length;s<f;s++){if(m[s])switch(m[s].compareNode(g[o])){case 2:// all selection inside uneditable. remove
break;case 3:t=m[s].cloneRange(),t.setEndBefore(g[o]),i.push(t),t=m[s].cloneRange(),t.setStartAfter(g[o]),i.push(t);break;default:i.push(m[s]);}m=i}}}return m},getSelection:function(){return rangy.getSelection(this.doc.defaultView||this.doc.parentWindow)},setSelection:function(o){var e=this.doc.defaultView||this.doc.parentWindow,t=rangy.getSelection(e);return t.setSingleRange(o)},createRange:function(){return rangy.createRange(this.doc)},isCollapsed:function(){return this.getSelection().isCollapsed},getHtml:function(){return this.getSelection().toHtml()},isEndToEndInNode:function(e){var t=this.getRange(),n=t.commonAncestorContainer,s=t.startContainer,l=t.endContainer;if(n.nodeType===w.TEXT_NODE&&(n=n.parentNode),s.nodeType===w.TEXT_NODE&&!/^\s*$/.test(s.data.substr(t.startOffset)))return!1;if(l.nodeType===w.TEXT_NODE&&!/^\s*$/.test(l.data.substr(t.endOffset)))return!1;for(;s&&s!==n;){if(s.nodeType!==w.TEXT_NODE&&!w.dom.contains(n,s))return!1;if(w.dom.domNode(s).prev({ignoreBlankTexts:!0}))return!1;s=s.parentNode}for(;l&&l!==n;){if(l.nodeType!==w.TEXT_NODE&&!w.dom.contains(n,l))return!1;if(w.dom.domNode(l).next({ignoreBlankTexts:!0}))return!1;l=l.parentNode}return!!w.lang.array(e).contains(n.nodeName)&&n},deselect:function(){var t=this.getSelection();t&&t.removeAllRanges()}})}(wysihtml5),function(N,x){function e(a,e,t){if(!a.className)return!1;var n=a.className.match(t)||[];return n[n.length-1]===e}function t(n,e){return!!(n.getAttribute&&n.getAttribute("style"))&&(n.getAttribute("style").match(e),!!n.getAttribute("style").match(e))}function E(o,e,t){o.getAttribute("style")?(r(o,t),o.getAttribute("style")&&!/^\s*$/.test(o.getAttribute("style"))?o.setAttribute("style",e+";"+o.getAttribute("style")):o.setAttribute("style",e)):o.setAttribute("style",e)}function a(o,e,t){o.className?(S(o,t),o.className+=" "+e):o.className=e}function S(n,e){n.className&&(n.className=n.className.replace(e,""))}function r(r,e){var t,s=[];if(r.getAttribute("style")){t=r.getAttribute("style").split(";");for(var n=t.length;n--;)t[n].match(e)||/^\s*$/.test(t[n])||s.push(t[n]);s.length?r.setAttribute("style",s.join(";")):r.removeAttribute("style")}}function s(i,e){var t=[],n=e.split(";"),o=i.getAttribute("style");if(o){o=o.replace(/\s/gi,"").toLowerCase(),t.push(new RegExp("(^|\\s|;)"+e.replace(/\s/gi,"").replace(/([\(\)])/gi,"\\$1").toLowerCase().replace(";",";?").replace(/rgb\\\((\d+),(\d+),(\d+)\\\)/gi,"\\s?rgb\\($1,\\s?$2,\\s?$3\\)"),"gi"));for(var d=n.length;0<d--;)/^\s*$/.test(n[d])||t.push(new RegExp("(^|\\s|;)"+n[d].replace(/\s/gi,"").replace(/([\(\)])/gi,"\\$1").toLowerCase().replace(";",";?").replace(/rgb\\\((\d+),(\d+),(\d+)\\\)/gi,"\\s?rgb\\($1,\\s?$2,\\s?$3\\)"),"gi"));for(var m=0,p=t.length;m<p;m++)if(o.match(t[m]))return t[m]}return!1}function l(e,t,n,o){return n?s(e,n):o?N.dom.hasClass(e,o):x.dom.arrayContains(t,e.tagName.toLowerCase())}function o(r,e,t,n){for(var o=r.length;o--;)if(!l(r[o],e,t,n))return!1;return!!r.length}function d(a,e,t){var n=s(a,e);return n?(r(a,n),"remove"):(E(a,e,t),"change")}function i(n,e){return n.className.replace(f," ")==e.className.replace(f," ")}function m(n){for(var e=n.parentNode;n.firstChild;)e.insertBefore(n.firstChild,n);e.removeChild(n)}function p(l,e){if(l.attributes.length!=e.attributes.length)return!1;for(var t,i,d,m=0,p=l.attributes.length;m<p;++m)if(t=l.attributes[m],d=t.name,"class"!=d){if(i=e.attributes.getNamedItem(d),t.specified!=i.specified)return!1;if(t.specified&&t.nodeValue!==i.nodeValue)return!1}return!0}function n(t,e){return x.dom.isCharacterDataNode(t)?0==e?!!t.previousSibling:e!=t.length||!!t.nextSibling:0<e&&e<t.childNodes.length}function g(t,e,l,i){var a;if(x.dom.isCharacterDataNode(e)&&(0==l?(l=x.dom.getNodeIndex(e),e=e.parentNode):l==e.length?(l=x.dom.getNodeIndex(e)+1,e=e.parentNode):a=x.dom.splitDataNode(e,l)),!a&&(!i||e!==i)){a=e.cloneNode(!1),a.id&&a.removeAttribute("id");for(var d;d=e.childNodes[l];)a.appendChild(d);x.dom.insertAfter(a,e)}return e==t?a:g(t,a.parentNode,x.dom.getNodeIndex(a),i)}function y(e){this.isElementMerge=e.nodeType==N.ELEMENT_NODE,this.firstTextNode=this.isElementMerge?e.lastChild:e,this.textNodes=[this.firstTextNode]}function u(l,e,t,n,o,a,r){this.tagNames=l||["span"],this.cssClass=e||void 0,this.similarClassRegExp=t,this.cssStyle=o||"",this.similarStyleRegExp=a,this.normalize=n,this.applyToAnyTagName=!1,this.container=r}var f=/\s+/g;y.prototype={doMerge:function(){for(var s,l,i,d=[],e=0,m=this.textNodes.length;e<m;++e)s=this.textNodes[e],l=s.parentNode,d[e]=s.data,e&&(l.removeChild(s),!l.hasChildNodes()&&l.parentNode.removeChild(l));return this.firstTextNode.data=i=d.join(""),i},getLength:function(){for(var n=this.textNodes.length,o=0;n--;)o+=this.textNodes[n].length;return o},toString:function(){for(var o=[],e=0,a=this.textNodes.length;e<a;++e)o[e]="'"+this.textNodes[e].data+"'";return"[Merge("+o.join(",")+")]"}},u.prototype={getAncestorWithClass:function(t){for(var n;t;){if(n=this.cssClass?e(t,this.cssClass,this.similarClassRegExp):""===this.cssStyle,t.nodeType==N.ELEMENT_NODE&&"false"!=t.getAttribute("contenteditable")&&x.dom.arrayContains(this.tagNames,t.tagName.toLowerCase())&&n)return t;t=t.parentNode}return!1},// returns parents of node with given style attribute
getAncestorWithStyle:function(e){for(var o;e;){if(o=!!this.cssStyle&&t(e,this.similarStyleRegExp),e.nodeType==N.ELEMENT_NODE&&"false"!=e.getAttribute("contenteditable")&&x.dom.arrayContains(this.tagNames,e.tagName.toLowerCase())&&o)return e;e=e.parentNode}return!1},getMatchingAncestor:function(o){var e=this.getAncestorWithClass(o),a=!1;return e?this.cssStyle&&(a="class"):(e=this.getAncestorWithStyle(o),e&&(a="style")),{element:e,type:a}},// Normalizes nodes after applying a CSS class to a Range.
postApply:function(i,e){for(var t,b,C,w=i[0],n=i[i.length-1],o=[],a=w,N=n,x=0,E=n.length,S=0,v=i.length;S<v;++S)b=i[S],C=null,b&&b.parentNode&&(C=this.getAdjacentMergeableTextNode(b.parentNode,!1)),C?(!t&&(t=new y(C),o.push(t)),t.textNodes.push(b),b===w&&(a=t.firstTextNode,x=a.length),b===n&&(N=t.firstTextNode,E=t.getLength())):t=null;// Test whether the first node after the range needs merging
if(n&&n.parentNode){var T=this.getAdjacentMergeableTextNode(n.parentNode,!0);T&&(!t&&(t=new y(n),o.push(t)),t.textNodes.push(T))}// Do the merges
if(o.length){for(S=0,v=o.length;S<v;++S)o[S].doMerge();// Set the range boundaries
e.setStart(a,x),e.setEnd(N,E)}},getAdjacentMergeableTextNode:function(e,t){var n,l=e.nodeType==N.TEXT_NODE,o=l?e.parentNode:e,a=t?"nextSibling":"previousSibling";if(l){if(n=e[a],n&&n.nodeType==N.TEXT_NODE)return n;}else if(n=o[a],n&&this.areElementsMergeable(e,n))return n[t?"firstChild":"lastChild"];return null},areElementsMergeable:function(t,e){return x.dom.arrayContains(this.tagNames,(t.tagName||"").toLowerCase())&&x.dom.arrayContains(this.tagNames,(e.tagName||"").toLowerCase())&&i(t,e)&&p(t,e)},createContainer:function(n){var e=n.createElement(this.tagNames[0]);return this.cssClass&&(e.className=this.cssClass),this.cssStyle&&e.setAttribute("style",this.cssStyle),e},applyToTextNode:function(t){var e=t.parentNode;if(1==e.childNodes.length&&x.dom.arrayContains(this.tagNames,e.tagName.toLowerCase()))this.cssClass&&a(e,this.cssClass,this.similarClassRegExp),this.cssStyle&&E(e,this.cssStyle,this.similarStyleRegExp);else{var n=this.createContainer(x.dom.getDocument(t));t.parentNode.insertBefore(n,t),n.appendChild(t)}},isRemovable:function(e){return x.dom.arrayContains(this.tagNames,e.tagName.toLowerCase())&&""===N.lang.string(e.className).trim()&&(!e.getAttribute("style")||""===N.lang.string(e.getAttribute("style")).trim())},undoToTextNode:function(s,e,t,p){var o=!t,a=t||p,u=!1;if(!e.containsNode(a)){// Split out the portion of the ancestor from which we can remove the CSS class
var f=e.cloneRange();f.selectNode(a),f.isPointInRange(e.endContainer,e.endOffset)&&n(e.endContainer,e.endOffset)&&(g(a,e.endContainer,e.endOffset,this.container),e.setEndAfter(a)),f.isPointInRange(e.startContainer,e.startOffset)&&n(e.startContainer,e.startOffset)&&(a=g(a,e.startContainer,e.startOffset,this.container))}!o&&this.similarClassRegExp&&S(a,this.similarClassRegExp),o&&this.similarStyleRegExp&&(u="change"===d(a,this.cssStyle,this.similarStyleRegExp)),this.isRemovable(a)&&!u&&m(a)},applyToRange:function(e){for(var t,i=e.length;i--;){if(t=e[i].getNodes([N.TEXT_NODE]),!t.length)try{var d=this.createContainer(e[i].endContainer.ownerDocument);return e[i].surroundContents(d),void this.selectNode(e[i],d)}catch(e){}if(e[i].splitBoundaries(),t=e[i].getNodes([N.TEXT_NODE]),t.length){for(var a,m=0,p=t.length;m<p;++m)a=t[m],this.getMatchingAncestor(a).element||this.applyToTextNode(a);e[i].setStart(t[0],0),a=t[t.length-1],e[i].setEnd(a,a.length),this.normalize&&this.postApply(t,e[i])}}},undoToRange:function(e){for(var t,i,p,g=e.length;g--;){if(t=e[g].getNodes([N.TEXT_NODE]),t.length)e[g].splitBoundaries(),t=e[g].getNodes([N.TEXT_NODE]);else{var u=e[g].endContainer.ownerDocument,s=u.createTextNode(N.INVISIBLE_SPACE);e[g].insertNode(s),e[g].selectNode(s),t=[s]}for(var l=0,f=t.length;l<f;++l)e[g].isValid()&&(i=t[l],p=this.getMatchingAncestor(i),"style"===p.type?this.undoToTextNode(i,e[g],!1,p.element):p.element&&this.undoToTextNode(i,e[g],p.element));1==f?this.selectNode(e[g],t[0]):(e[g].setStart(t[0],0),i=t[t.length-1],e[g].setEnd(i,i.length),this.normalize&&this.postApply(t,e[g]))}},selectNode:function(e,t){var n=t.nodeType===N.ELEMENT_NODE,o=!("canHaveHTML"in t)||t.canHaveHTML,a=n?t.innerHTML:t.data,r=""===a||a===N.INVISIBLE_SPACE;if(r&&n&&o)// Make sure that caret is visible in node by inserting a zero width no breaking space
try{t.innerHTML=N.INVISIBLE_SPACE}catch(e){}e.selectNodeContents(t),r&&n?e.collapse(!1):r&&(e.setStartAfter(t),e.setEndAfter(t))},getTextSelectedByRange:function(r,e){var t=e.cloneRange();t.selectNodeContents(r);var n=t.intersection(e),o=n?n.toString():"";return t.detach(),o},isAppliedToRange:function(e){for(var t,i,p=[],n="full",g=e.length;g--;){if(i=e[g].getNodes([N.TEXT_NODE]),!i.length)return t=this.getMatchingAncestor(e[g].startContainer).element,!!t&&{elements:[t],coverage:n};for(var u,f=0,h=i.length;f<h;++f)u=this.getTextSelectedByRange(i[f],e[g]),t=this.getMatchingAncestor(i[f]).element,t&&""!=u?(p.push(t),1===N.dom.getTextNodes(t,!0).length?n="full":"full"==n&&(n="inline")):!t&&(n="partial")}return!!p.length&&{elements:p,coverage:n}},toggleRange:function(a){var e,r=this.isAppliedToRange(a);r?"full"===r.coverage?this.undoToRange(a):"inline"===r.coverage?(e=o(r.elements,this.tagNames,this.cssStyle,this.cssClass),this.undoToRange(a),!e&&this.applyToRange(a)):(!o(r.elements,this.tagNames,this.cssStyle,this.cssClass)&&this.undoToRange(a),this.applyToRange(a)):this.applyToRange(a)}},N.selection.HTMLApplier=u}(wysihtml5,rangy),wysihtml5.Commands=Base.extend(/** @scope wysihtml5.Commands.prototype */{constructor:function(t){this.editor=t,this.composer=t.composer,this.doc=this.composer.doc},/**
   * Check whether the browser supports the given command
   *
   * @param {String} command The command string which to check (eg. "bold", "italic", "insertUnorderedList")
   * @example
   *    commands.supports("createLink");
   */support:function(t){return wysihtml5.browser.supportsCommand(this.doc,t)},/**
   * Check whether the browser supports the given command
   *
   * @param {String} command The command string which to execute (eg. "bold", "italic", "insertUnorderedList")
   * @param {String} [value] The command value parameter, needed for some commands ("createLink", "insertImage", ...), optional for commands that don't require one ("bold", "underline", ...)
   * @example
   *    commands.exec("insertImage", "http://a1.twimg.com/profile_images/113868655/schrei_twitter_reasonably_small.jpg");
   */exec:function(s,e){var t=wysihtml5.commands[s],n=wysihtml5.lang.array(arguments).get(),o=t&&t.exec,a=null;if(this.editor.fire("beforecommand:composer"),o)n.unshift(this.composer),a=o.apply(t,n);else try{a=this.doc.execCommand(s,!1,e)}catch(e){}return this.editor.fire("aftercommand:composer"),a},/**
   * Check whether the current command is active
   * If the caret is within a bold text, then calling this with command "bold" should return true
   *
   * @param {String} command The command string which to check (eg. "bold", "italic", "insertUnorderedList")
   * @param {String} [commandValue] The command value parameter (eg. for "insertImage" the image src)
   * @return {Boolean} Whether the command is active
   * @example
   *    var isCurrentSelectionBold = commands.state("bold");
   */state:function(a){var e=wysihtml5.commands[a],t=wysihtml5.lang.array(arguments).get(),n=e&&e.state;if(n)return t.unshift(this.composer),n.apply(e,t);try{// try/catch for buggy firefox
return this.doc.queryCommandState(a)}catch(e){return!1}},/* Get command state parsed value if command has stateValue parsing function */stateValue:function(a){var e=wysihtml5.commands[a],t=wysihtml5.lang.array(arguments).get(),n=e&&e.stateValue;return!!n&&(t.unshift(this.composer),n.apply(e,t))}}),wysihtml5.commands.bold={exec:function(n,e){wysihtml5.commands.formatInline.execWithToggle(n,e,"b")},state:function(n,e){// element.ownerDocument.queryCommandState("bold") results:
// firefox: only <b>
// chrome:  <b>, <strong>, <h1>, <h2>, ...
// ie:      <b>, <strong>
// opera:   <b>, <strong>
return wysihtml5.commands.formatInline.state(n,e,"b")}},function(i){function s(o,t){var n,w,N,x,E,S,v,T,R,_=o.doc,r="_wysihtml5-temp-"+ +new Date,s=/non-matching-class/g,l=0;for(i.commands.formatInline.exec(o,e,"A",r,s,e,e,!0,!0),w=_.querySelectorAll("A."+r),n=w.length;l<n;l++)for(R in N=w[l],N.removeAttribute("class"),t)// Do not set attribute "text" as it is meant for setting string value if created link has no textual data
"text"!==R&&N.setAttribute(R,t[R]);S=N,1===n&&(v=a.getTextContent(N),x=!!N.querySelector("*"),E=""===v||v===i.INVISIBLE_SPACE,!x&&E&&(a.setTextContent(N,t.text||N.href),T=_.createTextNode(" "),o.selection.setAfter(N),a.insert(T).after(N),S=T)),o.selection.setAfter(S)}// Changes attributes of links
function t(a,e,t){for(var n,i=e.length;i--;){n=e[i].attributes;for(var d=n.length;d--;)e[i].removeAttribute(n.item(d).name);// Set new attributes
for(var m in t)t.hasOwnProperty(m)&&e[i].setAttribute(m,t[m])}}var e,a=i.dom;i.commands.createLink={/**
     * TODO: Use HTMLApplier or formatInline here
     *
     * Turns selection into a link
     * If selection is already a link, it just changes the attributes
     *
     * @example
     *    // either ...
     *    wysihtml5.commands.createLink.exec(composer, "createLink", "http://www.google.de");
     *    // ... or ...
     *    wysihtml5.commands.createLink.exec(composer, "createLink", { href: "http://www.google.de", target: "_blank" });
     */exec:function(n,e,o){var l=this.state(n,e);l?n.selection.executeAndRestore(function(){t(n,l,o)}):(o="object"==typeof o?o:{href:o},s(n,o))},state:function(e,t){return i.commands.formatInline.state(e,t,"A")}}}(wysihtml5),function(o){function a(n,i){for(var t,d,m,p=i.length,o=0;o<p;o++)t=i[o],d=e.getParentElement(t,{nodeName:"code"}),m=e.getTextContent(t),m.match(e.autoLink.URL_REG_EXP)&&!d?d=e.renameElement(t,"code"):e.replaceWithChildNodes(t)}var e=o.dom;o.commands.removeLink={/*
     * If selection is a link, it removes the link and wraps it with a <code> element
     * The <code> element is needed to avoid auto linking
     *
     * @example
     *    wysihtml5.commands.createLink.exec(composer, "removeLink");
     */exec:function(t,e){var n=this.state(t,e);n&&t.selection.executeAndRestore(function(){a(t,n)})},state:function(e,t){return o.commands.formatInline.state(e,t,"A")}}}(wysihtml5),function(r){var e=/wysiwyg-font-size-[0-9a-z\-]+/g;r.commands.fontSize={exec:function(t,n,o){r.commands.formatInline.execWithToggle(t,n,"span","wysiwyg-font-size-"+o,e)},state:function(t,n,o){return r.commands.formatInline.state(t,n,"span","wysiwyg-font-size-"+o,e)}}}(wysihtml5),function(r){var e=/(\s|^)font-size\s*:\s*[^;\s]+;?/gi;r.commands.fontSizeStyle={exec:function(t,n,o){o="object"==typeof o?o.size:o,/^\s*$/.test(o)||r.commands.formatInline.execWithToggle(t,n,"span",!1,!1,"font-size:"+o,e)},state:function(t,n){return r.commands.formatInline.state(t,n,"span",!1,!1,"font-size",e)},stateValue:function(e,t){var n,s=this.state(e,t);return s&&r.lang.object(s).isArray()&&(s=s[0]),!!(s&&(n=s.getAttribute("style"),n))&&r.quirks.styleParser.parseFontSize(n)}}}(wysihtml5),function(r){var e=/wysiwyg-color-[0-9a-z]+/g;r.commands.foreColor={exec:function(t,n,o){r.commands.formatInline.execWithToggle(t,n,"span","wysiwyg-color-"+o,e)},state:function(t,n,o){return r.commands.formatInline.state(t,n,"span","wysiwyg-color-"+o,e)}}}(wysihtml5),function(l){var e=/(\s|^)color\s*:\s*[^;\s]+;?/gi;l.commands.foreColorStyle={exec:function(t,n,o){var a,i=l.quirks.styleParser.parseColor("object"==typeof o?"color:"+o.color:"color:"+o,"color");i&&(a="color: rgb("+i[0]+","+i[1]+","+i[2]+");",1!==i[3]&&(a+="color: rgba("+i[0]+","+i[1]+","+i[2]+","+i[3]+");"),l.commands.formatInline.execWithToggle(t,n,"span",!1,!1,a,e))},state:function(t,n){return l.commands.formatInline.state(t,n,"span",!1,!1,"color",e)},stateValue:function(e,t,n){var o,s=this.state(e,t);return s&&l.lang.object(s).isArray()&&(s=s[0]),!!(s&&(o=s.getAttribute("style"),o&&o))&&(val=l.quirks.styleParser.parseColor(o,"color"),l.quirks.styleParser.unparseColor(val,n))}}}(wysihtml5),function(l){var e=/(\s|^)background-color\s*:\s*[^;\s]+;?/gi;l.commands.bgColorStyle={exec:function(t,n,o){var a,i=l.quirks.styleParser.parseColor("object"==typeof o?"background-color:"+o.color:"background-color:"+o,"background-color");i&&(a="background-color: rgb("+i[0]+","+i[1]+","+i[2]+");",1!==i[3]&&(a+="background-color: rgba("+i[0]+","+i[1]+","+i[2]+","+i[3]+");"),l.commands.formatInline.execWithToggle(t,n,"span",!1,!1,a,e))},state:function(t,n){return l.commands.formatInline.state(t,n,"span",!1,!1,"background-color",e)},stateValue:function(e,t,n){var o,i=this.state(e,t),d=!1;return i&&l.lang.object(i).isArray()&&(i=i[0]),!!(i&&(o=i.getAttribute("style"),o))&&(d=l.quirks.styleParser.parseColor(o,"background-color"),l.quirks.styleParser.unparseColor(d,n))}}}(wysihtml5),function(b){/**
   * Remove similiar classes (based on classRegExp)
   * and add the desired class name
   */function n(a,t,n){a.className?(e(a,n),a.className=b.lang.string(a.className+" "+t).trim()):a.className=t}function t(e,t,n){a(e,n),e.getAttribute("style")?e.setAttribute("style",b.lang.string(e.getAttribute("style")+" "+t).trim()):e.setAttribute("style",t)}function e(e,t){var n=t.test(e.className);return e.className=e.className.replace(t,""),""==b.lang.string(e.className).trim()&&e.removeAttribute("class"),n}function a(e,t){var n=t.test(e.getAttribute("style"));return e.setAttribute("style",(e.getAttribute("style")||"").replace(t,"")),""==b.lang.string(e.getAttribute("style")||"").trim()&&e.removeAttribute("style"),n}function u(n){var e=n.lastChild;e&&o(e)&&e.parentNode.removeChild(e)}function o(t){return"BR"===t.nodeName}/**
   * Execute native query command
   * and if necessary modify the inserted node's className
   */function r(e,t){e.selection.isCollapsed()&&e.selection.selectLine();for(var n=e.selection.surround(t),o=0,s=n.length;o<s;o++)b.dom.lineBreaks(n[o]).remove(),u(n[o]);// rethink restoring selection
// composer.selection.selectNode(element, wysihtml5.browser.displaysCaretInEmptyContentEditableCorrectly());
}function s(e){return!!b.lang.string(e.className).trim()}function l(e){return!!b.lang.string(e.getAttribute("style")||"").trim()}var i=b.dom,// Following elements are grouped
// when the caret is within a H1 and the H4 is invoked, the H1 should turn into H4
// instead of creating a H4 within a H1 which would result in semantically invalid html
d=["H1","H2","H3","H4","H5","H6","P","PRE","DIV"];b.commands.formatBlock={exec:function(o,m,p,g,f,h,y){var C,A,O,L,I,D=o.doc,w=this.state(o,m,p,g,f,h,y),N=o.config.useLineBreaks,x=N?"DIV":"P";return p="string"==typeof p?p.toUpperCase():p,w.length?void o.selection.executeAndRestoreRangy(function(){for(var r=w.length;r--;){if(f&&(A=e(w[r],f)),y&&(L=a(w[r],y)),(L||A)&&null===p&&w[r].nodeName!=x)// dont rename or remove element when just setting block formating class or style
return;var d=s(w[r]),n=l(w[r]);d||n||!N&&"P"!==p?i.renameElement(w[r],"P"===p?"DIV":x):(b.dom.lineBreaks(w[r]).add(),i.replaceWithChildNodes(w[r]))}}):void((null===p||b.lang.array(d).contains(p))&&(C=o.selection.findNodesInSelection(d).concat(o.selection.getSelectedOwnNodes()),o.selection.executeAndRestoreRangy(function(){for(var a=C.length;a--;)I=i.getParentElement(C[a],{nodeName:d}),I==o.element&&(I=null),I&&(p&&(I=i.renameElement(I,p)),g&&n(I,g,f),h&&t(I,h,y),O=!0)}),O)||r(o,{nodeName:p||x,className:g||null,cssStyle:h||null}));// Find similiar block element and rename it (<h2 class="foo"></h2>  =>  <h1 class="foo"></h1>)
},state:function(e,t,n,p,a,r,s){var l,h=e.selection.getSelectedOwnNodes(),d=[];n="string"==typeof n?n.toUpperCase():n;//var selectedNode = composer.selection.getSelectedNode();
for(var m=0,y=h.length;m<y;m++)l=i.getParentElement(h[m],{nodeName:n,className:p,classRegExp:a,cssStyle:r,styleRegExp:s}),l&&-1==b.lang.array(d).indexOf(l)&&d.push(l);return 0!=d.length&&d}}}(wysihtml5),wysihtml5.commands.formatCode={exec:function(l,e,t){var n,i,d,m=this.state(l);m?l.selection.executeAndRestore(function(){n=m.querySelector("code"),wysihtml5.dom.replaceWithChildNodes(m),n&&wysihtml5.dom.replaceWithChildNodes(n)}):(i=l.selection.getRange(),d=i.extractContents(),m=l.doc.createElement("pre"),n=l.doc.createElement("code"),t&&(n.className=t),m.appendChild(n),n.appendChild(d),i.insertNode(m),l.selection.selectNode(m))},state:function(n){var e=n.selection.getSelectedNode();return e&&e.nodeName&&"PRE"==e.nodeName&&e.firstChild&&e.firstChild.nodeName&&"CODE"==e.firstChild.nodeName?e:wysihtml5.dom.getParentElement(e,{nodeName:"CODE"})&&wysihtml5.dom.getParentElement(e,{nodeName:"PRE"})}},function(f){function e(o){var e=n[o];return e?[o.toLowerCase(),e.toLowerCase()]:[o.toLowerCase()]}function h(a,n,o,r,s,l){var i=a;return n&&(i+=":"+n),r&&(i+=":"+r),t[i]||(t[i]=new f.selection.HTMLApplier(e(a),n,o,!0,r,s,l)),t[i]}var// Treat <b> as <strong> and vice versa
n={strong:"b",em:"i",b:"strong",i:"em"},t={};f.commands.formatInline={exec:function(n,e,t,o,a,r,s,l,i){var d=n.selection.createRange(),m=n.selection.getOwnRanges();return!!(m&&0!=m.length)&&void(n.selection.getSelection().removeAllRanges(),h(t,o,a,r,s,n.element).toggleRange(m),l?!i&&n.cleanUp():(d.setStart(m[0].startContainer,m[0].startOffset),d.setEnd(m[m.length-1].endContainer,m[m.length-1].endOffset),n.selection.setSelection(d),n.selection.executeAndRestore(function(){i||n.cleanUp()},!0,!0)))},// Executes so that if collapsed caret is in a state and executing that state it should unformat that state
// It is achieved by selecting the entire state element before executing.
// This works on built in contenteditable inline format commands
execWithToggle:function(e,t,n,o,a,r,s){var l=this;if(this.state(e,t,n,o,a,r,s)&&e.selection.isCollapsed()&&!e.selection.caretIsLastInSelection()&&!e.selection.caretIsFirstInSelection()){var i=l.state(e,t,n,o,a)[0];e.selection.executeAndRestoreRangy(function(){i.parentNode,e.selection.selectNode(i,!0),f.commands.formatInline.exec(e,t,n,o,a,r,s,!0,!0)})}else this.state(e,t,n,o,a,r,s)&&!e.selection.isCollapsed()?e.selection.executeAndRestoreRangy(function(){f.commands.formatInline.exec(e,t,n,o,a,r,s,!0,!0)}):f.commands.formatInline.exec(e,t,n,o,a,r,s)},state:function(e,t,o,a,r,s,l){var i,d,y=e.doc,m=n[o]||o;// Check whether the document contains a node with the desired tagName
return!!(f.dom.hasElementWithTagName(y,o)||f.dom.hasElementWithTagName(y,m))&&(!a||f.dom.hasElementWithClassName(y,a))&&(i=e.selection.getOwnRanges(),i&&0!==i.length)&&(d=h(o,a,r,s,l,e.element).isAppliedToRange(i),!!(d&&d.elements)&&d.elements);// Check whether the document contains a node with the desired className
}}}(wysihtml5),function(r){r.commands.insertBlockQuote={exec:function(e,t){var s=this.state(e,t),o=e.selection.isEndToEndInNode(["H1","H2","H3","H4","H5","H6","P"]);e.selection.executeAndRestore(function(){if(s)e.config.useLineBreaks&&r.dom.lineBreaks(s).add(),r.dom.unwrap(s);else if(e.selection.isCollapsed()&&e.selection.selectLine(),o){var t=o.ownerDocument.createElement("blockquote");r.dom.insert(t).after(o),t.appendChild(o)}else e.selection.surround({nodeName:"blockquote"})})},state:function(e){var t=e.selection.getSelectedNode(),n=r.dom.getParentElement(t,{nodeName:"BLOCKQUOTE"},!1,e.element);return!!n&&n}}}(wysihtml5),wysihtml5.commands.insertHTML={exec:function(o,e,t){o.commands.support(e)?o.doc.execCommand(e,!1,t):o.selection.insertHTML(t)},state:function(){return!1}},function(i){i.commands.insertImage={/**
     * Inserts an <img>
     * If selection is already an image link, it removes it
     *
     * @example
     *    // either ...
     *    wysihtml5.commands.insertImage.exec(composer, "insertImage", "http://www.google.de/logo.jpg");
     *    // ... or ...
     *    wysihtml5.commands.insertImage.exec(composer, "insertImage", { src: "http://www.google.de/logo.jpg", title: "foo" });
     */exec:function(e,t,n){n="object"==typeof n?n:{src:n};var m,p,g=e.doc,a=this.state(e);if(a)return e.selection.setBefore(a),p=a.parentNode,p.removeChild(a),i.dom.removeEmptyTextNodes(p),"A"!==p.nodeName||p.firstChild||(e.selection.setAfter(p),p.parentNode.removeChild(p)),void i.quirks.redraw(e.element);for(var u in a=g.createElement("IMG"),n)a.setAttribute("className"==u?"class":u,n[u]);e.selection.insertNode(a),i.browser.hasProblemsSettingCaretAfterImg()?(m=g.createTextNode(i.INVISIBLE_SPACE),e.selection.insertNode(m),e.selection.setAfter(m)):e.selection.setAfter(a)},state:function(e){var t,s,l,d=e.doc;return!!i.dom.hasElementWithTagName(d,"IMG")&&(t=e.selection.getSelectedNode(),!!t)&&("IMG"===t.nodeName?t:t.nodeType===i.ELEMENT_NODE&&(s=e.selection.getText(),s=i.lang.string(s).trim(),!s)&&(l=e.selection.getNodes(i.ELEMENT_NODE,function(t){return"IMG"===t.nodeName}),1===l.length&&l[0]))}}}(wysihtml5),function(a){var e="<br>"+(a.browser.needsSpaceAfterLineBreak()?" ":"");a.commands.insertLineBreak={exec:function(t,n){t.commands.support(n)?(t.doc.execCommand(n,!1,null),!a.browser.autoScrollsToCaret()&&t.selection.scrollIntoView()):t.commands.exec("insertHTML",e)},state:function(){return!1}}}(wysihtml5),wysihtml5.commands.insertOrderedList={exec:function(n,e){wysihtml5.commands.insertList.exec(n,e,"OL")},state:function(n,e){return wysihtml5.commands.insertList.state(n,e,"OL")}},wysihtml5.commands.insertUnorderedList={exec:function(n,e){wysihtml5.commands.insertList.exec(n,e,"UL")},state:function(n,e){return wysihtml5.commands.insertList.state(n,e,"UL")}},wysihtml5.commands.insertList=function(g){var i=function(t,e){if(t&&t.nodeName){"string"==typeof e&&(e=[e]);for(var n=e.length;n--;)if(t.nodeName===e[n])return!0}return!1},p=function(e,t,n){var o={el:null,other:!1};if(e){var a=g.dom.getParentElement(e,{nodeName:"LI"}),s="UL"===t?"OL":"UL";i(e,t)?o.el=e:i(e,s)?o={el:e,other:!0}:a&&(i(a.parentNode,t)?o.el=a.parentNode:i(a.parentNode,s)&&(o={el:a.parentNode,other:!0}))}// do not count list elements outside of composer
return o.el&&!n.element.contains(o.el)&&(o.el=null),o},n=function(o,t,n){var r,l="UL"===t?"OL":"UL";// Unwrap list
// <ul><li>foo</li><li>bar</li></ul>
// becomes:
// foo<br>bar<br>
n.selection.executeAndRestore(function(){var a=e(l,n);if(a.length)for(var s=a.length;s--;)g.dom.renameElement(a[s],t.toLowerCase());else{r=e(["OL","UL"],n);for(var i=r.length;i--;)g.dom.resolveList(r[i],n.config.useLineBreaks);g.dom.resolveList(o,n.config.useLineBreaks)}})},o=function(r,t,n){var o="UL"===t?"OL":"UL";// Turn an ordered list into an unordered list
// <ol><li>foo</li><li>bar</li></ol>
// becomes:
// <ul><li>foo</li><li>bar</li></ul>
// Also rename other lists in selection
n.selection.executeAndRestore(function(){// All selection inner lists get renamed too
for(var a=[r].concat(e(o,n)),s=a.length;s--;)g.dom.renameElement(a[s],t.toLowerCase())})},e=function(t,e){for(var n=e.selection.getOwnRanges(),o=[],r=n.length;r--;)o=o.concat(n[r].getNodes([1],function(e){return i(e,t)}));return o},a=function(e,t){// Fallback for Create list
t.selection.executeAndRestoreRangy(function(){var n,i,d="_wysihtml5-temp-"+new Date().getTime(),o=t.selection.deblockAndSurround({nodeName:"div",className:d}),a=/\uFEFF/g;// This space causes new lists to never break on enter 
o.innerHTML=o.innerHTML.replace(a,""),o&&(n=g.lang.array(["","<br>",g.INVISIBLE_SPACE]).contains(o.innerHTML),i=g.dom.convertToList(o,e.toLowerCase(),t.parent.config.uneditableContainerClassname),n&&t.selection.selectNode(i.querySelector("li"),!0))})};return{exec:function(s,e,t){var r=s.doc,l="OL"===t?"insertOrderedList":"insertUnorderedList",i=s.selection.getSelectedNode(),d=p(i,t,s);d.el?d.other?o(d.el,t,s):n(d.el,t,s):s.commands.support(l)?r.execCommand(l,!1,null):a(t,s)},state:function(n,e,t){var o=n.selection.getSelectedNode(),a=p(o,t,n);return a.el&&!a.other&&a.el}}}(wysihtml5),wysihtml5.commands.italic={exec:function(n,e){wysihtml5.commands.formatInline.execWithToggle(n,e,"i")},state:function(n,e){// element.ownerDocument.queryCommandState("italic") results:
// firefox: only <i>
// chrome:  <i>, <em>, <blockquote>, ...
// ie:      <i>, <em>
// opera:   only <i>
return wysihtml5.commands.formatInline.state(n,e,"i")}},function(o){var e=/wysiwyg-text-align-[0-9a-z]+/g;o.commands.justifyCenter={exec:function(t){return o.commands.formatBlock.exec(t,"formatBlock",null,"wysiwyg-text-align-center",e)},state:function(t){return o.commands.formatBlock.state(t,"formatBlock",null,"wysiwyg-text-align-center",e)}}}(wysihtml5),function(o){var e=/wysiwyg-text-align-[0-9a-z]+/g;o.commands.justifyLeft={exec:function(t){return o.commands.formatBlock.exec(t,"formatBlock",null,"wysiwyg-text-align-left",e)},state:function(t){return o.commands.formatBlock.state(t,"formatBlock",null,"wysiwyg-text-align-left",e)}}}(wysihtml5),function(o){var e=/wysiwyg-text-align-[0-9a-z]+/g;o.commands.justifyRight={exec:function(t){return o.commands.formatBlock.exec(t,"formatBlock",null,"wysiwyg-text-align-right",e)},state:function(t){return o.commands.formatBlock.state(t,"formatBlock",null,"wysiwyg-text-align-right",e)}}}(wysihtml5),function(o){var e=/wysiwyg-text-align-[0-9a-z]+/g;o.commands.justifyFull={exec:function(t){return o.commands.formatBlock.exec(t,"formatBlock",null,"wysiwyg-text-align-justify",e)},state:function(t){return o.commands.formatBlock.state(t,"formatBlock",null,"wysiwyg-text-align-justify",e)}}}(wysihtml5),function(o){var e=/(\s|^)text-align\s*:\s*[^;\s]+;?/gi;o.commands.alignRightStyle={exec:function(t){return o.commands.formatBlock.exec(t,"formatBlock",null,null,null,"text-align: right;",e)},state:function(t){return o.commands.formatBlock.state(t,"formatBlock",null,null,null,"text-align: right;",e)}}}(wysihtml5),function(o){var e=/(\s|^)text-align\s*:\s*[^;\s]+;?/gi;o.commands.alignLeftStyle={exec:function(t){return o.commands.formatBlock.exec(t,"formatBlock",null,null,null,"text-align: left;",e)},state:function(t){return o.commands.formatBlock.state(t,"formatBlock",null,null,null,"text-align: left;",e)}}}(wysihtml5),function(o){var e=/(\s|^)text-align\s*:\s*[^;\s]+;?/gi;o.commands.alignCenterStyle={exec:function(t){return o.commands.formatBlock.exec(t,"formatBlock",null,null,null,"text-align: center;",e)},state:function(t){return o.commands.formatBlock.state(t,"formatBlock",null,null,null,"text-align: center;",e)}}}(wysihtml5),wysihtml5.commands.redo={exec:function(t){return t.undoManager.redo()},state:function(){return!1}},wysihtml5.commands.underline={exec:function(n,e){wysihtml5.commands.formatInline.execWithToggle(n,e,"u")},state:function(n,e){return wysihtml5.commands.formatInline.state(n,e,"u")}},wysihtml5.commands.undo={exec:function(t){return t.undoManager.undo()},state:function(){return!1}},wysihtml5.commands.createTable={exec:function(s,e,t){var n,l,i;if(t&&t.cols&&t.rows&&0<parseInt(t.cols,10)&&0<parseInt(t.rows,10)){for(i=t.tableStyle?"<table style=\""+t.tableStyle+"\">":"<table>",i+="<tbody>",l=0;l<t.rows;l++){for(i+="<tr>",n=0;n<t.cols;n++)i+="<td>&nbsp;</td>";i+="</tr>"}i+="</tbody></table>",s.commands.exec("insertHTML",i)}},state:function(){return!1}},wysihtml5.commands.mergeTableCells={exec:function(n,e){n.tableSelection&&n.tableSelection.start&&n.tableSelection.end&&(this.state(n,e)?wysihtml5.dom.table.unmergeCell(n.tableSelection.start):wysihtml5.dom.table.mergeCellsBetween(n.tableSelection.start,n.tableSelection.end))},state:function(o){if(o.tableSelection){var e=o.tableSelection.start,t=o.tableSelection.end;if(e&&t&&e==t&&(wysihtml5.dom.getAttribute(e,"colspan")&&1<parseInt(wysihtml5.dom.getAttribute(e,"colspan"),10)||wysihtml5.dom.getAttribute(e,"rowspan")&&1<parseInt(wysihtml5.dom.getAttribute(e,"rowspan"),10)))return[e]}return!1}},wysihtml5.commands.addTableCells={exec:function(a,e,t){if(a.tableSelection&&a.tableSelection.start&&a.tableSelection.end){// switches start and end if start is bigger than end (reverse selection)
var n=wysihtml5.dom.table.orderSelectionEnds(a.tableSelection.start,a.tableSelection.end);"before"==t||"above"==t?wysihtml5.dom.table.addCells(n.start,t):("after"==t||"below"==t)&&wysihtml5.dom.table.addCells(n.end,t),setTimeout(function(){a.tableSelection.select(n.start,n.end)},0)}},state:function(){return!1}},wysihtml5.commands.deleteTableCells={exec:function(l,e,t){if(l.tableSelection&&l.tableSelection.start&&l.tableSelection.end){var n,i=wysihtml5.dom.table.orderSelectionEnds(l.tableSelection.start,l.tableSelection.end),o=wysihtml5.dom.table.indexOf(i.start),a=l.tableSelection.table;wysihtml5.dom.table.removeCells(i.start,t),setTimeout(function(){// move selection to next or previous if not present
n=wysihtml5.dom.table.findCell(a,o),n||("row"==t&&(n=wysihtml5.dom.table.findCell(a,{row:o.row-1,col:o.col})),"column"==t&&(n=wysihtml5.dom.table.findCell(a,{row:o.row,col:o.col-1}))),n&&l.tableSelection.select(n,n)},0)}},state:function(){return!1}},wysihtml5.commands.indentList={exec:function(n){var e=n.selection.getSelectionParentsByTag("LI");return!!e&&this.tryToPushLiLevel(e,n.selection)},state:function(){return!1},tryToPushLiLevel:function(i,e){var d,m,p,g,u,f=!1;return e.executeAndRestoreRangy(function(){for(var e=i.length;e--;)g=i[e],d="OL"===g.parentNode.nodeName?"OL":"UL",m=g.ownerDocument.createElement(d),p=wysihtml5.dom.domNode(g).prev({nodeTypes:[wysihtml5.ELEMENT_NODE]}),u=p?p.querySelector("ul, ol"):null,p&&(u?u.appendChild(g):(m.appendChild(g),p.appendChild(m)),f=!0)}),f}},wysihtml5.commands.outdentList={exec:function(n){var e=n.selection.getSelectionParentsByTag("LI");return!!e&&this.tryToPullLiLevel(e,n)},state:function(){return!1},tryToPullLiLevel:function(p,e){var t,d,g,u,f,h=!1,y=this;return e.selection.executeAndRestoreRangy(function(){for(var n=p.length;n--;)if(u=p[n],u.parentNode&&(t=u.parentNode,"OL"===t.tagName||"UL"===t.tagName)){if(h=!0,d=wysihtml5.dom.getParentElement(t.parentNode,{nodeName:["OL","UL"]},!1,e.element),g=wysihtml5.dom.getParentElement(t.parentNode,{nodeName:["LI"]},!1,e.element),d&&g)u.nextSibling&&(f=y.getAfterList(t,u),u.appendChild(f)),d.insertBefore(u,g.nextSibling);else{u.nextSibling&&(f=y.getAfterList(t,u),u.appendChild(f));for(var o=u.childNodes.length;o--;)t.parentNode.insertBefore(u.childNodes[o],t.nextSibling);t.parentNode.insertBefore(document.createElement("br"),t.nextSibling),u.parentNode.removeChild(u)}// cleanup
0===t.childNodes.length&&t.parentNode.removeChild(t)}}),h},getAfterList:function(a,e){for(var t=a.nodeName,n=document.createElement(t);e.nextSibling;)n.appendChild(e.nextSibling);return n}},function(p){var e="<span id=\"_wysihtml5-undo\" class=\"_wysihtml5-temp\">"+p.INVISIBLE_SPACE+"</span>",t="<span id=\"_wysihtml5-redo\" class=\"_wysihtml5-temp\">"+p.INVISIBLE_SPACE+"</span>",a=p.dom;p.UndoManager=p.lang.Dispatcher.extend(/** @scope wysihtml5.UndoManager.prototype */{constructor:function(t){this.editor=t,this.composer=t.composer,this.element=this.composer.element,this.position=0,this.historyStr=[],this.historyDom=[],this.transact(),this._observe()},_observe:function(){var r,s=this,e=this.composer.sandbox.getDocument();// Catch CTRL+Z and CTRL+Y
// Catch delete and backspace
a.observe(this.element,"keydown",function(e){if(!e.altKey&&(e.ctrlKey||e.metaKey)){var t=e.keyCode,n=90===t&&!e.shiftKey,o=90===t&&e.shiftKey||89===t;n?(s.undo(),e.preventDefault()):o&&(s.redo(),e.preventDefault())}}),a.observe(this.element,"keydown",function(e){var t=e.keyCode;t===r||(r=t,(8===t||46===t)&&s.transact())}),this.editor.on("newword:composer",function(){s.transact()}).on("beforecommand:composer",function(){s.transact()})},transact:function(){var e,g,u,f,h,y=this.historyStr[this.position-1],t=this.composer.getValue(!1,!1),n=0<this.element.offsetWidth&&0<this.element.offsetHeight;if(t!==y){var o=this.historyStr.length=this.historyDom.length=this.position;25<o&&(this.historyStr.shift(),this.historyDom.shift(),this.position--),this.position++,n&&(e=this.composer.selection.getRange(),g=e&&e.startContainer?e.startContainer:this.element,u=e&&e.startOffset?e.startOffset:0,g.nodeType===p.ELEMENT_NODE?f=g:(f=g.parentNode,h=this.getChildNodeIndex(f,g)),f.setAttribute("data-wysihtml5-selection-offset",u),"undefined"!=typeof h&&f.setAttribute("data-wysihtml5-selection-node",h));var d=this.element.cloneNode(!!t);this.historyDom.push(d),this.historyStr.push(t),f&&(f.removeAttribute("data-wysihtml5-selection-offset"),f.removeAttribute("data-wysihtml5-selection-node"))}},undo:function(){this.transact(),this.undoPossible()&&(this.set(this.historyDom[--this.position-1]),this.editor.fire("undo:composer"))},redo:function(){this.redoPossible()&&(this.set(this.historyDom[++this.position-1]),this.editor.fire("redo:composer"))},undoPossible:function(){return 1<this.position},redoPossible:function(){return this.position<this.historyStr.length},set:function(l){this.element.innerHTML="";for(var e=0,i=l.childNodes,n=l.childNodes.length;e<n;e++)this.element.appendChild(i[e].cloneNode(!0));// Restore selection
var o,d,m;l.hasAttribute("data-wysihtml5-selection-offset")?(o=l.getAttribute("data-wysihtml5-selection-offset"),m=l.getAttribute("data-wysihtml5-selection-node"),d=this.element):(d=this.element.querySelector("[data-wysihtml5-selection-offset]")||this.element,o=d.getAttribute("data-wysihtml5-selection-offset"),m=d.getAttribute("data-wysihtml5-selection-node"),d.removeAttribute("data-wysihtml5-selection-offset"),d.removeAttribute("data-wysihtml5-selection-node")),null!==m&&(d=this.getChildNodeByIndex(d,+m)),this.composer.selection.set(d,o)},getChildNodeIndex:function(r,e){for(var t=0,s=r.childNodes,o=s.length;t<o;t++)if(s[t]===e)return t},getChildNodeByIndex:function(n,e){return n.childNodes[e]}})}(wysihtml5),wysihtml5.views.View=Base.extend(/** @scope wysihtml5.views.View.prototype */{constructor:function(o,e,t){this.parent=o,this.element=e,this.config=t,this.config.noTextarea||this._observeViewChange()},_observeViewChange:function(){var n=this;this.parent.on("beforeload",function(){n.parent.on("change_view",function(e){e===n.name?(n.parent.currentView=n,n.show(),setTimeout(function(){n.focus()},0)):n.hide()})})},focus:function(){if(this.element.ownerDocument.querySelector(":focus")!==this.element)try{this.element.focus()}catch(e){}},hide:function(){this.element.style.display="none"},show:function(){this.element.style.display=""},disable:function(){this.element.setAttribute("disabled","disabled")},enable:function(){this.element.removeAttribute("disabled")}}),function(m){var d=m.dom,t=m.browser;m.views.Composer=m.views.View.extend(/** @scope wysihtml5.views.Composer.prototype */{name:"composer",// Needed for firefox in order to display a proper caret in an empty contentEditable
CARET_HACK:"<br>",constructor:function(o,e,t){this.base(o,e,t),this.config.noTextarea?this.editableArea=e:this.textarea=this.parent.textarea,this.config.contentEditableMode?this._initContentEditableArea():this._initSandbox()},clear:function(){this.element.innerHTML=t.displaysCaretInEmptyContentEditableCorrectly()?"":this.CARET_HACK},getValue:function(e,t){var n=this.isEmpty()?"":m.quirks.getCorrectInnerHTML(this.element);return!1!==e&&(n=this.parent.parse(n,!1!==t)),n},setValue:function(e,o){o&&(e=this.parent.parse(e));try{this.element.innerHTML=e}catch(t){this.element.innerText=e}},cleanUp:function(){this.parent.parse(this.element)},show:function(){this.editableArea.style.display=this._displayStyle||"",this.config.noTextarea||this.textarea.element.disabled||(this.disable(),this.enable())},hide:function(){this._displayStyle=d.getStyle("display").from(this.editableArea),"none"===this._displayStyle&&(this._displayStyle=null),this.editableArea.style.display="none"},disable:function(){this.parent.fire("disable:composer"),this.element.removeAttribute("contentEditable")},enable:function(){this.parent.fire("enable:composer"),this.element.setAttribute("contentEditable","true")},focus:function(e){m.browser.doesAsyncFocus()&&this.hasPlaceholderSet()&&this.clear(),this.base();var t=this.element.lastChild;e&&t&&this.selection&&("BR"===t.nodeName?this.selection.setBefore(this.element.lastChild):this.selection.setAfter(this.element.lastChild))},getTextContent:function(){return d.getTextContent(this.element)},hasPlaceholderSet:function(){return this.getTextContent()==(this.config.noTextarea?this.editableArea.getAttribute("data-placeholder"):this.textarea.element.getAttribute("placeholder"))&&this.placeholderSet},isEmpty:function(){var t=this.element.innerHTML.toLowerCase();return /^(\s|<br>|<\/br>|<p>|<\/p>)*$/i.test(t)||""===t||"<br>"===t||"<p></p>"===t||"<p><br></p>"===t||this.hasPlaceholderSet()},_initContentEditableArea:function(){var t=this;this.config.noTextarea?this.sandbox=new d.ContentEditableArea(function(){t._create()},{},this.editableArea):(this.sandbox=new d.ContentEditableArea(function(){t._create()}),this.editableArea=this.sandbox.getContentEditable(),d.insert(this.editableArea).after(this.textarea.element),this._createWysiwygFormField())},_initSandbox:function(){var t=this;this.sandbox=new d.Sandbox(function(){t._create()},{stylesheets:this.config.stylesheets}),this.editableArea=this.sandbox.getIframe();var e=this.textarea.element;d.insert(this.editableArea).after(e),this._createWysiwygFormField()},// Creates hidden field which tells the server after submit, that the user used an wysiwyg editor
_createWysiwygFormField:function(){if(this.textarea.element.form){var t=document.createElement("input");t.type="hidden",t.name="_wysihtml5_mode",t.value=1,d.insert(t).after(this.textarea.element)}},_create:function(){var e=this;this.doc=this.sandbox.getDocument(),this.element=this.config.contentEditableMode?this.sandbox.getContentEditable():this.doc.body,this.config.noTextarea?this.cleanUp():(this.textarea=this.parent.textarea,this.element.innerHTML=this.textarea.getValue(!0,!1)),this.selection=new m.Selection(this.parent,this.element,this.config.uneditableContainerClassname),this.commands=new m.Commands(this.parent),this.config.noTextarea||d.copyAttributes(["className","spellcheck","title","lang","dir","accessKey"]).from(this.textarea.element).to(this.element),d.addClass(this.element,this.config.composerClassName),this.config.style&&!this.config.contentEditableMode&&this.style(),this.observe();var n=this.config.name;n&&(d.addClass(this.element,n),!this.config.contentEditableMode&&d.addClass(this.editableArea,n)),this.enable(),!this.config.noTextarea&&this.textarea.element.disabled&&this.disable();// Simulate html5 placeholder attribute on contentEditable element
var o="string"==typeof this.config.placeholder?this.config.placeholder:this.config.noTextarea?this.editableArea.getAttribute("data-placeholder"):this.textarea.element.getAttribute("placeholder");// Make sure that the browser avoids using inline styles whenever possible
// Fire global (before-)load event
o&&d.simulatePlaceholder(this.parent,this,o),this.commands.exec("styleWithCSS",!1),this._initAutoLinking(),this._initObjectResizing(),this._initUndoManager(),this._initLineBreaking(),this.config.noTextarea||!this.textarea.element.hasAttribute("autofocus")&&document.querySelector(":focus")!=this.textarea.element||t.isIos()||setTimeout(function(){e.focus(!0)},100),t.clearsContentEditableCorrectly()||m.quirks.ensureProperClearing(this),this.initSync&&this.config.sync&&this.initSync(),this.config.noTextarea||this.textarea.hide(),this.parent.fire("beforeload").fire("load")},_initAutoLinking:function(){var p=this,e=t.canDisableAutoLinking(),n=t.doesAutoLinkingInContentEditable();if(e&&this.commands.exec("autoUrlDetect",!1),!!this.config.autoLink){(!n||n&&e)&&(this.parent.on("newword:composer",function(){d.getTextContent(p.element).match(d.autoLink.URL_REG_EXP)&&p.selection.executeAndRestore(function(e,t){for(var n=p.element.querySelectorAll("."+p.config.uneditableContainerClassname),o=!1,a=n.length;a--;)m.dom.contains(n[a],t)&&(o=!0);o||d.autoLink(t.parentNode,[p.config.uneditableContainerClassname])})}),d.observe(this.element,"blur",function(){d.autoLink(p.element,[p.config.uneditableContainerClassname])}));// Assuming we have the following:
//  <a href="http://www.google.de">http://www.google.de</a>
// If a user now changes the url in the innerHTML we want to make sure that
// it's synchronized with the href attribute (as long as the innerHTML is still a url)
var// Use a live NodeList to check whether there are any links in the document
o=this.sandbox.getDocument().getElementsByTagName("a"),// The autoLink helper method reveals a reg exp to detect correct urls
s=d.autoLink.URL_REG_EXP,l=function(e){var t=m.lang.string(d.getTextContent(e)).trim();return"www."===t.substr(0,4)&&(t="http://"+t),t};d.observe(this.element,"keydown",function(t){if(o.length){var i,e=p.selection.getSelectedNode(t.target.ownerDocument),n=d.getParentElement(e,{nodeName:"A"},4);n&&(// keydown is fired before the actual content is changed
// therefore we set a timeout to change the href
i=l(n),setTimeout(function(){var t=l(n);t===i||t.match(s)&&n.setAttribute("href",t)},0))}})}// Only do the auto linking by ourselves when the browser doesn't support auto linking
// OR when he supports auto linking but we were able to turn it off (IE9+)
},_initObjectResizing:function(){// IE sets inline styles after resizing objects
// The following lines make sure that the width/height css properties
// are copied over to the width/height attributes
if(this.commands.exec("enableObjectResizing",!0),t.supportsEvent("resizeend")){var e=["width","height"],o=e.length,a=this.element;d.observe(a,"resizeend",function(r){var t,i=r.target||r.srcElement,n=i.style,s=0;if("IMG"===i.nodeName){for(;s<o;s++)t=e[s],n[t]&&(i.setAttribute(t,parseInt(n[t],10)),n[t]="");// After resizing IE sometimes forgets to remove the old resize handles
m.quirks.redraw(a)}})}},_initUndoManager:function(){this.undoManager=new m.UndoManager(this.parent)},_initLineBreaking:function(){function e(t){var e=d.getParentElement(t,{nodeName:["P","DIV"]},2);e&&d.contains(o.element,e)&&o.selection.executeAndRestore(function(){o.config.useLineBreaks?d.replaceWithChildNodes(e):"P"!==e.nodeName&&d.renameElement(e,"p")})}var o=this,a=["LI","P","H1","H2","H3","H4","H5","H6"],l=["UL","OL","MENU"];// Under certain circumstances Chrome + Safari create nested <p> or <hX> tags after paste
// Inserting an invisible white space in front of it fixes the issue
// This is too hacky and causes selection not to replace content on paste in chrome
/* if (browser.createsNestedInvalidMarkupAfterPaste()) {
        dom.observe(this.element, "paste", function(event) {
          var invisibleSpace = that.doc.createTextNode(wysihtml5.INVISIBLE_SPACE);
          that.selection.insertNode(invisibleSpace);
        });
      }*/this.config.useLineBreaks||d.observe(this.element,["focus","keydown"],function(){if(o.isEmpty()){var n=o.doc.createElement("P");o.element.innerHTML="",o.element.appendChild(n),t.displaysCaretInEmptyContentEditableCorrectly()?o.selection.selectNode(n,!0):(n.innerHTML="<br>",o.selection.setBefore(n.firstChild))}}),d.observe(this.element,"keydown",function(t){var s=t.keyCode;if(!t.shiftKey&&(s===m.ENTER_KEY||s===m.BACKSPACE_KEY)){var p=d.getParentElement(o.selection.getSelectedNode(),{nodeName:a},4);return p?void setTimeout(function(){// Unwrap paragraph after leaving a list or a H1-6
var t,a=o.selection.getSelectedNode();if("LI"===p.nodeName){if(!a)return;t=d.getParentElement(a,{nodeName:l},2),t||e(a)}s===m.ENTER_KEY&&p.nodeName.match(/^H[1-6]$/)&&e(a)},0):void(o.config.useLineBreaks&&s===m.ENTER_KEY&&!m.browser.insertsLineBreaksOnReturn()&&(t.preventDefault(),o.commands.exec("insertLineBreak")))}})}})}(wysihtml5),function(b){var C=b.dom,t=document,n=window,e=t.createElement("div"),/**
       * Styles to copy from textarea to the composer element
       */a=["background-color","color","cursor","font-family","font-size","font-style","font-variant","font-weight","line-height","letter-spacing","text-align","text-decoration","text-indent","text-rendering","word-break","word-wrap","word-spacing"],/**
       * Styles to copy from textarea to the iframe
       */r=["background-color","border-collapse","border-bottom-color","border-bottom-style","border-bottom-width","border-left-color","border-left-style","border-left-width","border-right-color","border-right-style","border-right-width","border-top-color","border-top-style","border-top-width","clear","display","float","margin-bottom","margin-left","margin-right","margin-top","outline-color","outline-offset","outline-width","outline-style","padding-left","padding-right","padding-top","padding-bottom","position","top","left","right","bottom","z-index","vertical-align","text-align","-webkit-box-sizing","-moz-box-sizing","-ms-box-sizing","box-sizing","-webkit-box-shadow","-moz-box-shadow","-ms-box-shadow","box-shadow","-webkit-border-top-right-radius","-moz-border-radius-topright","border-top-right-radius","-webkit-border-bottom-right-radius","-moz-border-radius-bottomright","border-bottom-right-radius","-webkit-border-bottom-left-radius","-moz-border-radius-bottomleft","border-bottom-left-radius","-webkit-border-top-left-radius","-moz-border-radius-topleft","border-top-left-radius","width","height"],s=["html                 { height: 100%; }","body                 { height: 100%; padding: 1px 0 0 0; margin: -1px 0 0 0; }","body > p:first-child { margin-top: 0; }","._wysihtml5-temp     { display: none; }",b.browser.isGecko?"body.placeholder { color: graytext !important; }":"body.placeholder { color: #a9a9a9 !important; }",// Ensure that user see's broken images and can delete them
"img:-moz-broken      { -moz-force-broken-image-icon: 1; height: 24px; width: 24px; }"],l=function(o){if(o.setActive)// Following line could cause a js error when the textarea is invisible
// See https://github.com/xing/wysihtml5/issues/9
try{o.setActive()}catch(e){}else{var e=o.style,a=t.documentElement.scrollTop||t.body.scrollTop,r=t.documentElement.scrollLeft||t.body.scrollLeft,s={position:e.position,top:e.top,left:e.left,WebkitUserSelect:e.WebkitUserSelect};C.setStyles({position:"absolute",top:"-99999px",left:"-99999px",// Don't ask why but temporarily setting -webkit-user-select to none makes the whole thing performing smoother
WebkitUserSelect:"none"}).on(o),o.focus(),C.setStyles(s).on(o),n.scrollTo&&n.scrollTo(r,a)}};/**
   * With "setActive" IE offers a smart way of focusing elements without scrolling them into view:
   * http://msdn.microsoft.com/en-us/library/ms536738(v=vs.85).aspx
   *
   * Other browsers need a more hacky way: (pssst don't tell my mama)
   * In order to prevent the element being scrolled into view when focusing it, we simply
   * move it out of the scrollable area, focus it, and reset it's position
   */b.views.Composer.prototype.style=function(){var n,i=this,o=t.querySelector(":focus"),d=this.textarea.element,m=d.hasAttribute("placeholder"),p=m&&d.getAttribute("placeholder"),g=d.style.display,u=d.disabled;this.focusStylesHost=e.cloneNode(!1),this.blurStylesHost=e.cloneNode(!1),this.disabledStylesHost=e.cloneNode(!1),m&&d.removeAttribute("placeholder"),d===o&&d.blur(),d.disabled=!1,d.style.display=n="none",(d.getAttribute("rows")&&"auto"===C.getStyle("height").from(d)||d.getAttribute("cols")&&"auto"===C.getStyle("width").from(d))&&(d.style.display=n=g),C.copyStyles(r).from(d).to(this.editableArea).andTo(this.blurStylesHost),C.copyStyles(a).from(d).to(this.element).andTo(this.blurStylesHost),C.insertCSS(s).into(this.element.ownerDocument),d.disabled=!0,C.copyStyles(r).from(d).to(this.disabledStylesHost),C.copyStyles(a).from(d).to(this.disabledStylesHost),d.disabled=u,d.style.display=g,l(d),d.style.display=n,C.copyStyles(r).from(d).to(this.focusStylesHost),C.copyStyles(a).from(d).to(this.focusStylesHost),d.style.display=g,C.copyStyles(["display"]).from(d).to(this.editableArea);// Make sure that we don't change the display style of the iframe when copying styles oblur/onfocus
// this is needed for when the change_view event is fired where the iframe is hidden and then
// the blur event fires and re-displays it
var f=b.lang.array(r).without(["display"]);// --------- restore focus ---------
return o?o.focus():d.blur(),m&&d.setAttribute("placeholder",p),this.parent.on("focus:composer",function(){C.copyStyles(f).from(i.focusStylesHost).to(i.editableArea),C.copyStyles(a).from(i.focusStylesHost).to(i.element)}),this.parent.on("blur:composer",function(){C.copyStyles(f).from(i.blurStylesHost).to(i.editableArea),C.copyStyles(a).from(i.blurStylesHost).to(i.element)}),this.parent.observe("disable:composer",function(){C.copyStyles(f).from(i.disabledStylesHost).to(i.editableArea),C.copyStyles(a).from(i.disabledStylesHost).to(i.element)}),this.parent.observe("enable:composer",function(){C.copyStyles(f).from(i.blurStylesHost).to(i.editableArea),C.copyStyles(a).from(i.blurStylesHost).to(i.element)}),this}}(wysihtml5),function(u){var e=u.dom,t=u.browser,/**
       * Map keyCodes to query commands
       */l={66:"bold",// B
73:"italic",// I
85:"underline"// U
},o=function(s,e,t){// merge node with previous node from uneditable
var n=s.getPreviousNode(e,!0),o=s.getSelectedNode();if(1!==o.nodeType&&o.parentNode!==t&&(o=o.parentNode),n)if(1==o.nodeType){var l=o.firstChild;if(1==n.nodeType)for(;o.firstChild;)n.appendChild(o.firstChild);else for(;o.firstChild;)e.parentNode.insertBefore(o.firstChild,e);o.parentNode&&o.parentNode.removeChild(o),s.setBefore(l)}else 1==n.nodeType?n.appendChild(o):e.parentNode.insertBefore(o,e),s.setBefore(o)},i=function(a,e,t,n){if(!e.isCollapsed())e.containsUneditable()&&(a.preventDefault(),e.deleteContents());else if(e.caretIsInTheBeginnig("LI"))a.preventDefault(),n.commands.exec("outdentList");else if(e.caretIsInTheBeginnig())a.preventDefault();else{if(e.caretIsFirstInSelection()&&e.getPreviousNode()&&e.getPreviousNode().nodeName&&/^H\d$/gi.test(e.getPreviousNode().nodeName)){var i=e.getPreviousNode();if(a.preventDefault(),/^\s*$/.test(i.textContent||i.innerText))i.parentNode.removeChild(i);else{var r=i.ownerDocument.createRange();r.selectNodeContents(i),r.collapse(!1),e.setSelection(r)}}var s=e.caretIsBeforeUneditable();// Do a special delete if caret would delete uneditable
s&&(a.preventDefault(),o(e,s,t))}},r=function(t){if(!t.selection.isCollapsed())t.selection.deleteContents();else if(t.selection.caretIsInTheBeginnig("LI")&&t.commands.exec("indentList"))return;// Is &emsp; close enough to tab. Could not find enough counter arguments for now.
t.commands.exec("insertHTML","&emsp;")};u.views.Composer.prototype.observe=function(){var f=this,n=this.getValue(!1,!1),o=this.sandbox.getIframe?this.sandbox.getIframe():this.sandbox.getContentEditable(),a=this.element,s=t.supportsEventsInIframeCorrectly()||this.sandbox.getContentEditable?a:this.sandbox.getWindow();// --------- destroy:composer event ---------
// DOMNodeRemoved event is not supported in IE 8
if(e.observe(o,"DOMNodeRemoved",function(){clearInterval(d),f.parent.fire("destroy:composer")}),!t.supportsMutationEvents())var d=setInterval(function(){e.contains(document.documentElement,o)||(clearInterval(d),f.parent.fire("destroy:composer"))},250);// --------- User interaction tracking --
e.observe(s,["drop","paste","mouseup","focus","keyup"],function(){setTimeout(function(){f.parent.fire("interaction").fire("interaction:composer")},0)}),this.config.handleTables&&(!this.tableClickHandle&&this.doc.execCommand&&u.browser.supportsCommand(this.doc,"enableObjectResizing")&&u.browser.supportsCommand(this.doc,"enableInlineTableEditing")&&(this.sandbox.getIframe?this.tableClickHandle=e.observe(o,["focus","mouseup","mouseover"],function(){f.doc.execCommand("enableObjectResizing",!1,"false"),f.doc.execCommand("enableInlineTableEditing",!1,"false"),f.tableClickHandle.stop()}):setTimeout(function(){f.doc.execCommand("enableObjectResizing",!1,"false"),f.doc.execCommand("enableInlineTableEditing",!1,"false")},0)),this.tableSelection=u.quirks.tableCellsSelection(a,f.parent)),e.observe(s,"focus",function(t){f.parent.fire("focus",t).fire("focus:composer",t),setTimeout(function(){n=f.getValue(!1,!1)},0)}),e.observe(s,"blur",function(o){if(n!==f.getValue(!1,!1)){//create change event if supported (all except IE8)
var e=o;"function"==typeof Object.create&&(e=Object.create(o,{type:{value:"change"}})),f.parent.fire("change",e).fire("change:composer",e)}f.parent.fire("blur",o).fire("blur:composer",o)}),e.observe(a,"dragenter",function(){f.parent.fire("unset_placeholder")}),e.observe(a,["drop","paste","beforepaste"],function(t){f.parent.fire(t.type,t).fire(t.type+":composer",t)}),this.config.copyedFromMarking&&e.observe(a,"copy",function(t){t.clipboardData&&(t.clipboardData.setData("text/html",f.config.copyedFromMarking+f.selection.getHtml()),t.preventDefault()),f.parent.fire(t.type,t).fire(t.type+":composer",t)}),e.observe(a,"keyup",function(e){var t=e.keyCode;(t===u.SPACE_KEY||t===u.ENTER_KEY)&&f.parent.fire("newword:composer")}),this.parent.on("paste:composer",function(){setTimeout(function(){f.parent.fire("newword:composer")},0)}),t.canSelectImagesInContentEditable()||e.observe(a,"mousedown",function(e){var t=e.target,n=a.querySelectorAll("img"),o=a.querySelectorAll("."+f.config.uneditableContainerClassname+" img"),r=u.lang.array(n).without(o);"IMG"===t.nodeName&&u.lang.array(r).contains(t)&&f.selection.selectNode(t)}),t.canSelectImagesInContentEditable()||e.observe(a,"drop",function(){setTimeout(function(){f.selection.getSelection().removeAllRanges()},0)}),t.hasHistoryIssue()&&t.supportsSelectionModify()&&e.observe(a,"keydown",function(r){if(r.metaKey||r.ctrlKey){var e=r.keyCode,t=a.ownerDocument.defaultView,n=t.getSelection();(37===e||39===e)&&(37===e&&(n.modify("extend","left","lineboundary"),!r.shiftKey&&n.collapseToStart()),39===e&&(n.modify("extend","right","lineboundary"),!r.shiftKey&&n.collapseToEnd()),r.preventDefault())}}),e.observe(a,"keydown",function(o){var e=o.keyCode,t=l[e];(o.ctrlKey||o.metaKey)&&!o.altKey&&t&&(f.commands.exec(t),o.preventDefault()),8===e?i(o,f.selection,a,f):f.config.handleTabKey&&9===e&&(o.preventDefault(),r(f,a))}),e.observe(a,"keydown",function(e){var t,s=f.selection.getSelectedNode(!0),n=e.keyCode;s&&"IMG"===s.nodeName&&(n===u.BACKSPACE_KEY||n===u.DELETE_KEY)&&(t=s.parentNode,t.removeChild(s),"A"===t.nodeName&&!t.firstChild&&t.parentNode.removeChild(t),setTimeout(function(){u.quirks.redraw(a)},0),e.preventDefault())}),!this.config.contentEditableMode&&t.hasIframeFocusIssue()&&(e.observe(o,"focus",function(){setTimeout(function(){f.doc.querySelector(":focus")!==f.element&&f.focus()},0)}),e.observe(this.element,"blur",function(){setTimeout(function(){f.selection.getSelection().removeAllRanges()},0)}));// --------- Show url in tooltip when hovering links or images ---------
var m={IMG:"Image: ",A:"Link: "};e.observe(a,"mouseover",function(r){var e,s=r.target,t=s.nodeName;if("A"===t||"IMG"===t){var n=s.hasAttribute("title");n||(e=m[t]+(s.getAttribute("href")||s.getAttribute("src")),s.setAttribute("title",e))}})}}(wysihtml5),function(s){s.views.Synchronizer=Base.extend(/** @scope wysihtml5.views.Synchronizer.prototype */{constructor:function(o,e,t){this.editor=o,this.textarea=e,this.composer=t,this._observe()},/**
     * Sync html from composer to textarea
     * Takes care of placeholders
     * @param {Boolean} shouldParseHtml Whether the html should be sanitized before inserting it into the textarea
     */fromComposerToTextarea:function(e){this.textarea.setValue(s.lang.string(this.composer.getValue(!1,!1)).trim(),e)},/**
     * Sync value of textarea to composer
     * Takes care of placeholders
     * @param {Boolean} shouldParseHtml Whether the html should be sanitized before inserting it into the composer
     */fromTextareaToComposer:function(n){var e=this.textarea.getValue(!1,!1);e?this.composer.setValue(e,n):(this.composer.clear(),this.editor.fire("set_placeholder"))},/**
     * Invoke syncing based on view state
     * @param {Boolean} shouldParseHtml Whether the html should be sanitized before inserting it into the composer/textarea
     */sync:function(t){"textarea"===this.editor.currentView.name?this.fromTextareaToComposer(t):this.fromComposerToTextarea(t)},/**
     * Initializes interval-based syncing
     * also makes sure that on-submit the composer's content is synced with the textarea
     * immediately when the form gets submitted
     */_observe:function(){var l,i=this,e=this.textarea.element.form,t=function(){l=setInterval(function(){i.fromComposerToTextarea()},400)},n=function(){clearInterval(l),l=null};t(),e&&(s.dom.observe(e,"submit",function(){i.sync(!0)}),s.dom.observe(e,"reset",function(){setTimeout(function(){i.fromTextareaToComposer()},0)})),this.editor.on("change_view",function(o){"composer"!==o||l?"textarea"===o&&(i.fromComposerToTextarea(!0),n()):(i.fromTextareaToComposer(!0),t())}),this.editor.on("destroy:composer",n)}})}(wysihtml5),wysihtml5.views.Textarea=wysihtml5.views.View.extend(/** @scope wysihtml5.views.Textarea.prototype */{name:"textarea",constructor:function(o,e,t){this.base(o,e,t),this._observe()},clear:function(){this.element.value=""},getValue:function(n){var e=this.isEmpty()?"":this.element.value;return!1!==n&&(e=this.parent.parse(e)),e},setValue:function(n,o){o&&(n=this.parent.parse(n)),this.element.value=n},cleanUp:function(){var t=this.parent.parse(this.element.value);this.element.value=t},hasPlaceholderSet:function(){var o=wysihtml5.browser.supportsPlaceholderAttributeOn(this.element),e=this.element.getAttribute("placeholder")||null,t=this.element.value;return o&&!t||t===e},isEmpty:function(){return!wysihtml5.lang.string(this.element.value).trim()||this.hasPlaceholderSet()},_observe:function(){var a=this.element,r=this.parent,t={focusin:"focus",focusout:"blur"},/**
         * Calling focus() or blur() on an element doesn't synchronously trigger the attached focus/blur events
         * This is the case for focusin and focusout, so let's use them whenever possible, kkthxbai
         */e=wysihtml5.browser.supportsEvent("focusin")?["focusin","focusout","change"]:["focus","blur","change"];r.on("beforeload",function(){wysihtml5.dom.observe(a,e,function(n){var e=t[n.type]||n.type;r.fire(e).fire(e+":textarea")}),wysihtml5.dom.observe(a,["paste","drop"],function(){setTimeout(function(){r.fire("paste").fire("paste:textarea")},0)})})}}),function(r){var e,s={// Give the editor a name, the name will also be set as class name on the iframe and on the iframe's body
name:e,// Whether the editor should look like the textarea (by adopting styles)
style:!0,// Id of the toolbar element, pass falsey value if you don't want any toolbar logic
toolbar:e,// Whether toolbar is displayed after init by script automatically.
// Can be set to false if toolobar is set to display only on editable area focus
showToolbarAfterInit:!0,// Whether urls, entered by the user should automatically become clickable-links
autoLink:!0,// Includes table editing events and cell selection tracking
handleTables:!0,// Tab key inserts tab into text as default behaviour. It can be disabled to regain keyboard navigation
handleTabKey:!0,// Object which includes parser rules to apply when html gets cleaned
// See parser_rules/*.js for examples
parserRules:{tags:{br:{},span:{},div:{},p:{}},classes:{}},// Object which includes parser when the user inserts content via copy & paste. If null parserRules will be used instead
pasteParserRulesets:null,// Parser method to use when the user inserts content
parser:r.dom.parse,// Class name which should be set on the contentEditable element in the created sandbox iframe, can be styled via the 'stylesheets' option
composerClassName:"wysihtml5-editor",// Class name to add to the body when the wysihtml5 editor is supported
bodyClassName:"wysihtml5-supported",// By default wysihtml5 will insert a <br> for line breaks, set this to false to use <p>
useLineBreaks:!0,// Array (or single string) of stylesheet urls to be loaded in the editor's iframe
stylesheets:[],// Placeholder text to use, defaults to the placeholder attribute on the textarea element
placeholderText:e,// Whether the rich text editor should be rendered on touch devices (wysihtml5 >= 0.3.0 comes with basic support for iOS 5)
supportTouchDevices:!0,// Whether senseless <span> elements (empty or without attributes) should be removed/replaced with their content
cleanUp:!0,// Whether to use div instead of secure iframe
contentEditableMode:!1,// Classname of container that editor should not touch and pass through
// Pass false to disable
uneditableContainerClassname:"wysihtml5-uneditable-container",// Browsers that support copied source handling will get a marking of the origin of the copied source (for determinig code cleanup rules on paste)
// Also copied source is based directly on selection - 
// (very useful for webkit based browsers where copy will otherwise contain a lot of code and styles based on whatever and not actually in selection).
// If falsy value is passed source override is also disabled
copyedFromMarking:"<meta name=\"copied-from\" content=\"wysihtml5\">"};r.Editor=r.lang.Dispatcher.extend(/** @scope wysihtml5.Editor.prototype */{constructor:function(e,t){// Sort out unsupported/unwanted browsers here
if(this.editableElement="string"==typeof e?document.getElementById(e):e,this.config=r.lang.object({}).merge(s).merge(t).get(),this._isCompatible=r.browser.supported(),"textarea"!=this.editableElement.nodeName.toLowerCase()&&(this.config.contentEditableMode=!0,this.config.noTextarea=!0),this.config.noTextarea||(this.textarea=new r.views.Textarea(this,this.editableElement,this.config),this.currentView=this.textarea),!this._isCompatible||!this.config.supportTouchDevices&&r.browser.isTouchDevice()){var n=this;return void setTimeout(function(){n.fire("beforeload").fire("load")},0)}// Add class name to body, to indicate that the editor is supported
r.dom.addClass(document.body,this.config.bodyClassName),this.composer=new r.views.Composer(this,this.editableElement,this.config),this.currentView=this.composer,"function"==typeof this.config.parser&&this._initParser(),this.on("beforeload",this.handleBeforeLoad)},handleBeforeLoad:function(){this.config.noTextarea||(this.synchronizer=new r.views.Synchronizer(this,this.textarea,this.composer)),this.config.toolbar&&(this.toolbar=new r.toolbar.Toolbar(this,this.config.toolbar,this.config.showToolbarAfterInit))},isCompatible:function(){return this._isCompatible},clear:function(){return this.currentView.clear(),this},getValue:function(n,e){return this.currentView.getValue(n,e)},setValue:function(n,e){return(this.fire("unset_placeholder"),!n)?this.clear():(this.currentView.setValue(n,e),this)},cleanUp:function(){this.currentView.cleanUp()},focus:function(t){return this.currentView.focus(t),this},/**
     * Deactivate editor (make it readonly)
     */disable:function(){return this.currentView.disable(),this},/**
     * Activate editor
     */enable:function(){return this.currentView.enable(),this},isEmpty:function(){return this.currentView.isEmpty()},hasPlaceholderSet:function(){return this.currentView.hasPlaceholderSet()},parse:function(e,t){var n=this.config.contentEditableMode?document:this.composer?this.composer.sandbox.getDocument():null,o=this.config.parser(e,{rules:this.config.parserRules,cleanUp:this.config.cleanUp,context:n,uneditableClass:this.config.uneditableContainerClassname,clearInternals:t});return"object"==typeof e&&r.quirks.redraw(e),o},/**
     * Prepare html parser logic
     *  - Observes for paste and drop
     */_initParser:function(){var e,a=this;r.browser.supportsModenPaste()?this.on("paste:composer",function(t){t.preventDefault(),e=r.dom.getPastedHtml(t),e&&a._cleanAndPaste(e)}):this.on("beforepaste:composer",function(e){e.preventDefault(),r.dom.getPastedHtmlWithDiv(a.composer,function(t){t&&a._cleanAndPaste(t)})})},_cleanAndPaste:function(e){var t=r.quirks.cleanPastedHTML(e,{referenceNode:this.composer.element,rules:this.config.pasteParserRulesets||[{set:this.config.parserRules}],uneditableClass:this.config.uneditableContainerClassname});this.composer.selection.deleteContents(),this.composer.selection.insertHTML(t)}})}(wysihtml5),function(r){var i=r.dom;r.toolbar.Dialog=r.lang.Dispatcher.extend(/** @scope wysihtml5.toolbar.Dialog.prototype */{constructor:function(n,e){this.link=n,this.container=e},_observe:function(){if(!this._observed){var d=this,e=function(n){var e=d._serialize();e==d.elementToChange?d.fire("edit",e):d.fire("save",e),d.hide(),n.preventDefault(),n.stopPropagation()};i.observe(d.link,"click",function(){i.hasClass(d.link,"wysihtml5-command-dialog-opened")&&setTimeout(function(){d.hide()},0)}),i.observe(this.container,"keydown",function(n){var t=n.keyCode;t===r.ENTER_KEY&&e(n),t===r.ESCAPE_KEY&&(d.fire("cancel"),d.hide())}),i.delegate(this.container,"[data-wysihtml5-dialog-action=save]","click",e),i.delegate(this.container,"[data-wysihtml5-dialog-action=cancel]","click",function(t){d.fire("cancel"),d.hide(),t.preventDefault(),t.stopPropagation()});for(var t=this.container.querySelectorAll("input, select, textarea"),n=0,o=t.length,a=function(){clearInterval(d.interval)};n<o;n++)i.observe(t[n],"change",a);this._observed=!0}},/**
     * Grabs all fields in the dialog and puts them in key=>value style in an object which
     * then gets returned
     */_serialize:function(){for(var a=this.elementToChange||{},e=this.container.querySelectorAll("[data-wysihtml5-dialog-field]"),t=e.length,n=0;n<t;n++)a[e[n].getAttribute("data-wysihtml5-dialog-field")]=e[n].value;return a},/**
     * Takes the attributes of the "elementToChange"
     * and inserts them in their corresponding dialog input fields
     *
     * Assume the "elementToChange" looks like this:
     *    <a href="http://www.google.com" target="_blank">foo</a>
     *
     * and we have the following dialog:
     *    <input type="text" data-wysihtml5-dialog-field="href" value="">
     *    <input type="text" data-wysihtml5-dialog-field="target" value="">
     *
     * after calling _interpolate() the dialog will look like this
     *    <input type="text" data-wysihtml5-dialog-field="href" value="http://www.google.com">
     *    <input type="text" data-wysihtml5-dialog-field="target" value="_blank">
     *
     * Basically it adopted the attribute values into the corresponding input fields
     *
     */_interpolate:function(i){for(var e,d,m,p=document.querySelector(":focus"),t=this.container.querySelectorAll("[data-wysihtml5-dialog-field]"),n=t.length,o=0;o<n;o++)// Never change elements where the user is currently typing in
(e=t[o],e!==p)&&(// Don't update hidden fields
// See https://github.com/xing/wysihtml5/pull/14
i&&"hidden"===e.type||(d=e.getAttribute("data-wysihtml5-dialog-field"),m=this.elementToChange&&"boolean"!=typeof this.elementToChange?this.elementToChange.getAttribute(d)||"":e.defaultValue,e.value=m))},/**
     * Show the dialog element
     */show:function(t){if(!i.hasClass(this.link,"wysihtml5-command-dialog-opened")){var e=this,n=this.container.querySelector("input, select, textarea");if(this.elementToChange=t,this._observe(),this._interpolate(),t&&(this.interval=setInterval(function(){e._interpolate(!0)},500)),i.addClass(this.link,"wysihtml5-command-dialog-opened"),this.container.style.display="",this.fire("show"),n&&!t)try{n.focus()}catch(e){}}},/**
     * Hide the dialog element
     */hide:function(){clearInterval(this.interval),this.elementToChange=null,i.removeClass(this.link,"wysihtml5-command-dialog-opened"),this.container.style.display="none",this.fire("hide")}})}(wysihtml5),function(g){var u=g.dom,e={position:"relative"},t={left:0,margin:0,opacity:0,overflow:"hidden",padding:0,position:"absolute",top:0,zIndex:1},n={cursor:"inherit",fontSize:"50px",height:"50px",marginTop:"-25px",outline:0,padding:0,position:"absolute",right:"-4px",top:"50%"},o={"x-webkit-speech":"",speech:""};g.toolbar.Speech=function(a,r){var s=document.createElement("input");if(!g.browser.supportsSpeechApiOn(s))return void(r.style.display="none");var l=a.editor.textarea.element.getAttribute("lang");l&&(o.lang=l);var i=document.createElement("div");g.lang.object(t).merge({width:r.offsetWidth+"px",height:r.offsetHeight+"px"}),u.insert(s).into(i),u.insert(i).into(r),u.setStyles(n).on(s),u.setAttributes(o).on(s),u.setStyles(t).on(i),u.setStyles(e).on(r);var d="onwebkitspeechchange"in s?"webkitspeechchange":"speechchange";u.observe(s,d,function(){a.execCommand("insertText",s.value),s.value=""}),u.observe(s,"click",function(t){u.hasClass(r,"wysihtml5-command-disabled")&&t.preventDefault(),t.stopPropagation()})}}(wysihtml5),function(i){var e="wysihtml5-command-disabled",g="wysihtml5-commands-disabled",u="wysihtml5-command-active",f="wysihtml5-action-active",h=i.dom;i.toolbar.Toolbar=Base.extend(/** @scope wysihtml5.toolbar.Toolbar.prototype */{constructor:function(t,n,o){this.editor=t,this.container="string"==typeof n?document.getElementById(n):n,this.composer=t.composer,this._getLinks("command"),this._getLinks("action"),this._observe(),o&&this.show(),null!=t.config.classNameCommandDisabled&&(e=t.config.classNameCommandDisabled),null!=t.config.classNameCommandsDisabled&&(g=t.config.classNameCommandsDisabled),null!=t.config.classNameCommandActive&&(u=t.config.classNameCommandActive),null!=t.config.classNameActionActive&&(f=t.config.classNameActionActive);for(var a=this.container.querySelectorAll("[data-wysihtml5-command=insertSpeech]"),r=a.length,s=0;s<r;s++)new i.toolbar.Speech(this,a[s])},_getLinks:function(e){for(var t,g,u,f,h,y=this[e+"Links"]=i.lang.array(this.container.querySelectorAll("[data-wysihtml5-"+e+"]")).get(),n=y.length,o=0,b=this[e+"Mapping"]={};o<n;o++)t=y[o],u=t.getAttribute("data-wysihtml5-"+e),f=t.getAttribute("data-wysihtml5-"+e+"-value"),g=this.container.querySelector("[data-wysihtml5-"+e+"-group='"+u+"']"),h=this._getDialog(t,u),b[u+":"+f]={link:t,group:g,name:u,value:f,dialog:h,state:!1}},_getDialog:function(l,t){var e,n,d=this,o=this.container.querySelector("[data-wysihtml5-dialog='"+t+"']");return o&&(e=i.toolbar["Dialog_"+t]?new i.toolbar["Dialog_"+t](l,o):new i.toolbar.Dialog(l,o),e.on("show",function(){n=d.composer.selection.getBookmark(),d.editor.fire("show:dialog",{command:t,dialogContainer:o,commandLink:l})}),e.on("save",function(a){n&&d.composer.selection.setBookmark(n),d._execCommand(t,a),d.editor.fire("save:dialog",{command:t,dialogContainer:o,commandLink:l})}),e.on("cancel",function(){d.editor.focus(!1),d.editor.fire("cancel:dialog",{command:t,dialogContainer:o,commandLink:l})})),e},/**
     * @example
     *    var toolbar = new wysihtml5.Toolbar();
     *    // Insert a <blockquote> element or wrap current selection in <blockquote>
     *    toolbar.execCommand("formatBlock", "blockquote");
     */execCommand:function(o,e){if(!this.commandsDisabled){var t=this.commandMapping[o+":"+e];// Show dialog when available
t&&t.dialog&&!t.state?t.dialog.show():this._execCommand(o,e)}},_execCommand:function(n,e){// Make sure that composer is focussed (false => don't move caret to the end)
this.editor.focus(!1),this.composer.commands.exec(n,e),this._updateLinkStates()},execAction:function(n){var e=this.editor;"change_view"===n&&e.textarea&&(e.currentView===e.textarea?e.fire("change_view","composer"):e.fire("change_view","textarea")),"showSource"==n&&e.fire("showSource")},_observe:function(){for(var r=this,e=this.editor,t=this.container,n=this.commandLinks.concat(this.actionLinks),o=n.length,a=0;a<o;a++)// 'javascript:;' and unselectable=on Needed for IE, but done in all browsers to make sure that all get the same css applied
// (you know, a:link { ... } doesn't match anchors with missing href attribute)
"A"===n[a].nodeName?h.setAttributes({href:"javascript:;",unselectable:"on"}).on(n[a]):h.setAttributes({unselectable:"on"}).on(n[a]);// Needed for opera and chrome
h.delegate(t,"[data-wysihtml5-command], [data-wysihtml5-action]","mousedown",function(t){t.preventDefault()}),h.delegate(t,"[data-wysihtml5-command]","click",function(e){var t=this,n=t.getAttribute("data-wysihtml5-command"),o=t.getAttribute("data-wysihtml5-command-value");r.execCommand(n,o),e.preventDefault()}),h.delegate(t,"[data-wysihtml5-action]","click",function(e){var t=this.getAttribute("data-wysihtml5-action");r.execAction(t),e.preventDefault()}),e.on("interaction:composer",function(){r._updateLinkStates()}),e.on("focus:composer",function(){r.bookmark=null}),this.editor.config.handleTables&&(e.on("tableselect:composer",function(){r.container.querySelectorAll("[data-wysihtml5-hiddentools=\"table\"]")[0].style.display=""}),e.on("tableunselect:composer",function(){r.container.querySelectorAll("[data-wysihtml5-hiddentools=\"table\"]")[0].style.display="none"})),e.on("change_view",function(n){e.textarea&&setTimeout(function(){r.commandsDisabled="composer"!==n,r._updateLinkStates(),r.commandsDisabled?h.addClass(t,g):h.removeClass(t,g)},0)})},_updateLinkStates:function(){var t,o,a,r,g=this.commandMapping,n=this.actionMapping;// every millisecond counts... this is executed quite often
for(t in g)(r=g[t],this.commandsDisabled?(o=!1,h.removeClass(r.link,u),r.group&&h.removeClass(r.group,u),r.dialog&&r.dialog.hide()):(o=this.composer.commands.state(r.name,r.value),h.removeClass(r.link,e),r.group&&h.removeClass(r.group,e)),r.state!==o)&&(r.state=o,o?(h.addClass(r.link,u),r.group&&h.addClass(r.group,u),r.dialog&&("object"==typeof o||i.lang.object(o).isArray()?(!r.dialog.multiselect&&i.lang.object(o).isArray()&&(o=1!==o.length||o[0],r.state=o),r.dialog.show(o)):r.dialog.hide())):(h.removeClass(r.link,u),r.group&&h.removeClass(r.group,u),r.dialog&&r.dialog.hide()));for(t in n)a=n[t],"change_view"===a.name&&(a.state=this.editor.currentView===this.editor.textarea,a.state?h.addClass(a.link,f):h.removeClass(a.link,f))},show:function(){this.container.style.display=""},hide:function(){this.container.style.display="none"}})}(wysihtml5),function(t){t.toolbar.Dialog_createTable=t.toolbar.Dialog.extend({show:function(t){this.base(t)}})}(wysihtml5),function(i){i.dom;i.toolbar.Dialog_foreColorStyle=i.toolbar.Dialog.extend({multiselect:!0,_serialize:function(){for(var a={},e=this.container.querySelectorAll("[data-wysihtml5-dialog-field]"),t=e.length,n=0;n<t;n++)a[e[n].getAttribute("data-wysihtml5-dialog-field")]=e[n].value;return a},_interpolate:function(e){for(var t,p=document.querySelector(":focus"),n=this.container.querySelectorAll("[data-wysihtml5-dialog-field]"),o=n.length,a=0,g=this.elementToChange?i.lang.object(this.elementToChange).isArray()?this.elementToChange[0]:this.elementToChange:null,s=g?g.getAttribute("style"):null,l=s?i.quirks.styleParser.parseColor(s,"color"):null;a<o;a++)// Never change elements where the user is currently typing in
(t=n[a],t!==p)&&(// Don't update hidden fields3
e&&"hidden"===t.type||"color"===t.getAttribute("data-wysihtml5-dialog-field")&&(l?l[3]&&1!=l[3]?t.value="rgba("+l[0]+","+l[1]+","+l[2]+","+l[3]+");":t.value="rgb("+l[0]+","+l[1]+","+l[2]+");":t.value="rgb(0,0,0);"))}})}(wysihtml5),function(s){s.dom;s.toolbar.Dialog_fontSizeStyle=s.toolbar.Dialog.extend({multiselect:!0,_serialize:function(){return{size:this.container.querySelector("[data-wysihtml5-dialog-field=\"size\"]").value}},_interpolate:function(){var e=document.querySelector(":focus"),t=this.container.querySelector("[data-wysihtml5-dialog-field='size']"),n=this.elementToChange?s.lang.object(this.elementToChange).isArray()?this.elementToChange[0]:this.elementToChange:null,o=n?n.getAttribute("style"):null,a=o?s.quirks.styleParser.parseFontSize(o):null;t&&t!==e&&a&&!/^\s*$/.test(a)&&(t.value=a)}})}(wysihtml5);/*!

 handlebars v1.3.0

Copyright (C) 2011 by Yehuda Katz

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.

@license
*/var Handlebars=function(){var s=function(){"use strict";function n(t){this.string=t}var e;return n.prototype.toString=function(){return""+this.string},e=n}(),t=function(l){"use strict";function m(t){return o[t]||"&amp;"}function e(o,e){for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(o[t]=e[t])}var t={},n=l,o={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},r=/[&<>"'`]/g,s=/[&<>"'`]/;t.extend=e;var i=Object.prototype.toString;t.toString=i;var d=function(t){return"function"==typeof t};d(/x/)&&(d=function(t){return"function"==typeof t&&"[object Function]"===i.call(t)});var d;t.isFunction=d;var p=Array.isArray||function(t){return!!(t&&"object"==typeof t)&&"[object Array]"===i.call(t)};return t.isArray=p,t.escapeExpression=function(t){return t instanceof n?t.toString():t||0===t?(t=""+t,s.test(t)?t.replace(r,m):t):""},t.isEmpty=function(t){return!(t||0===t)||!!(p(t)&&0===t.length)},t}(s),n=function(){"use strict";function o(t,l){var o;l&&l.firstLine&&(o=l.firstLine,t+=" - "+o+":"+l.firstColumn);for(var i=Error.prototype.constructor.call(this,t),s=0;s<a.length;s++)this[a[s]]=i[a[s]];o&&(this.lineNumber=o,this.column=l.firstColumn)}var e,a=["description","fileName","lineNumber","message","name","number","stack"];return o.prototype=new Error,e=o}(),o=function(g,t){"use strict";function o(n,e){this.helpers=n||{},this.partials=e||{},a(this)}function a(s){s.registerHelper("helperMissing",function(t){if(2!==arguments.length)throw new i("Missing helper: '"+t+"'")}),s.registerHelper("blockHelperMissing",function(e,t){var o=t.inverse||function(){},a=t.fn;return u(e)&&(e=e.call(this)),!0===e?a(this):!1===e||null==e?o(this):y(e)?0<e.length?s.helpers.each(e,t):o(this):a(e)}),s.registerHelper("each",function(a,l){var n,i=l.fn,o=l.inverse,r=0,p="";if(u(a)&&(a=a.call(this)),l.data&&(n=b(l.data)),a&&"object"==typeof a)if(y(a))for(var g=a.length;g>r;r++)n&&(n.index=r,n.first=0==r,n.last=r==a.length-1),p+=i(a[r],{data:n});else for(var m in a)a.hasOwnProperty(m)&&(n&&(n.key=m,n.index=r,n.first=0==r),p+=i(a[m],{data:n}),r++);return 0==r&&(p=o(this)),p}),s.registerHelper("if",function(n,o){return u(n)&&(n=n.call(this)),(o.hash.includeZero||n)&&!f.isEmpty(n)?o.fn(this):o.inverse(this)}),s.registerHelper("unless",function(t,e){return s.helpers["if"].call(this,t,{fn:e.inverse,inverse:e.fn,hash:e.hash})}),s.registerHelper("with",function(n,o){return u(n)&&(n=n.call(this)),f.isEmpty(n)?void 0:o.fn(n)}),s.registerHelper("log",function(t,e){var n=e.data&&null!=e.data.level?parseInt(e.data.level,10):1;s.log(n,t)})}function r(n,e){d.log(n,e)}var s={},f=g,i=t;s.VERSION="1.3.0",s.COMPILER_REVISION=4,s.REVISION_CHANGES={1:"<= 1.0.rc.2",2:"== 1.0.0-rc.3",3:"== 1.0.0-rc.4",4:">= 1.0.0"};var y=f.isArray,u=f.isFunction,l=f.toString;s.HandlebarsEnvironment=o,o.prototype={constructor:o,logger:void 0,log:r,registerHelper:function(o,e,t){if("[object Object]"===l.call(o)){if(t||e)throw new i("Arg not supported with multiple helpers");f.extend(this.helpers,o)}else t&&(e.not=t),this.helpers[o]=e},registerPartial:function(n,e){"[object Object]"===l.call(n)?f.extend(this.partials,n):this.partials[n]=e}};var d={methodMap:{0:"debug",1:"info",2:"warn",3:"error"},DEBUG:0,INFO:1,WARN:2,ERROR:3,level:3,log:function(n,e){if(d.level<=n){var t=d.methodMap[n];"undefined"!=typeof console&&console[t]&&console[t].call(console,e)}}};s.logger=d,s.log=r;var b=function(n){var e={};return f.extend(e,n),e};return s.createFrame=b,s}(t,n),a=function(n,e,t){"use strict";function o(e){var t=e&&e[0]||1,n=d;if(t!==n){if(n>t){var o=l[n],a=l[t];throw new i("Template was precompiled with an older version of Handlebars than the current runtime. Please update your precompiler to a newer version ("+o+") or downgrade your runtime to an older version ("+a+").")}throw new i("Template was precompiled with a newer version of Handlebars than the current runtime. Please update your runtime to a newer version ("+e[1]+").")}}function a(a,r,t){var e=function(n,e){return e=e||{},r(n,e.data||t)};return e.program=a,e.depth=0,e}var r={},s=n,i=e,d=t.COMPILER_REVISION,l=t.REVISION_CHANGES;return r.checkRevision=o,r.template=function(p,g){if(!g)throw new i("No environment passed to template");var t=function(n){function e(){return n.apply(this,arguments)}return e.toString=function(){return n.toString()},e}(function(n,t,o,a,r,e){var s=g.VM.invokePartial.apply(this,arguments);if(null!=s)return s;if(g.compile)return r[t]=g.compile(n,{data:void 0!==e},g),r[t](o,{helpers:a,partials:r,data:e});throw new i("The partial "+t+" could not be compiled when running in runtime-only mode")}),e={escapeExpression:s.escapeExpression,invokePartial:t,programs:[],program:function(r,e,t){var n=this.programs[r];return t?n=a(r,e,t):n||(n=this.programs[r]=a(r,e)),n},merge:function(o,e){var t=o||e;return o&&e&&o!==e&&(t={},s.extend(t,e),s.extend(t,o)),t},programWithDepth:g.VM.programWithDepth,noop:g.VM.noop,compilerInfo:null};return function(t,n){n=n||{};var o,a,i=n.partial?n:g;n.partial||(o=n.helpers,a=n.partials);var s=p.call(e,i,t,o,a,n.data);return n.partial||g.VM.checkRevision(e.compilerInfo),s}},r.programWithDepth=function(e,s,n){var o=Array.prototype.slice.call(arguments,3),t=function(a,e){return e=e||{},s.apply(this,[a,e.data||n].concat(o))};return t.program=e,t.depth=o.length,t},r.program=a,r.invokePartial=function(s,t,n,o,a,r){if(void 0===s)throw new i("The partial "+t+" could not be found");return s instanceof Function?s(n,{partial:!0,helpers:o,partials:a,data:r}):void 0},r.noop=function(){return""},r}(t,n,o),r=function(p,g,n,t,o){"use strict";var a,r=p,e=t,s=o,i=function(){var o=new r.HandlebarsEnvironment;return e.extend(o,r),o.SafeString=g,o.Exception=n,o.Utils=e,o.VM=s,o.template=function(t){return s.template(t,o)},o},d=i();return d.create=i,a=d}(o,s,n,t,a);return r}();/**
 * English translation for bootstrap-wysihtml5
 */this.wysihtml5=this.wysihtml5||{},this.wysihtml5.tpl=this.wysihtml5.tpl||{},this.wysihtml5.tpl.blockquote=Handlebars.template(function(m,e,t,p,o){function g(o){var e,a="";return a+="btn-"+f((e=(e=(e=o&&o.options,null==e||!1===e?e:e.toolbar),null==e||!1===e?e:e.size),"function"==typeof e?e.apply(o):e)),a}this.compilerInfo=[4,">= 1.0.0"],t=this.merge(t,m.helpers),o=o||{};var r,u="",f=this.escapeExpression,l=this;return u+="<li>\n  <a class=\"btn ",r=t["if"].call(e,(r=(r=e&&e.options,null==r||!1===r?r:r.toolbar),null==r||!1===r?r:r.size),{hash:{},inverse:l.noop,fn:l.program(1,g,o),data:o}),(r||0===r)&&(u+=r),u+=" btn-default\" data-wysihtml5-command=\"formatBlock\" data-wysihtml5-command-value=\"blockquote\" data-wysihtml5-display-format-name=\"false\" tabindex=\"-1\">\n    ",r=t["if"].call(e,(r=(r=e&&e.options,null==r||!1===r?r:r.toolbar),null==r||!1===r?r:r.fa),{hash:{},inverse:l.program(5,function(){return"\n      <span class=\"glyphicon glyphicon-quote\"></span>\n    "},o),fn:l.program(3,function(){return" \n      <span class=\"fa fa-quote-left\"></span>\n    "},o),data:o}),(r||0===r)&&(u+=r),u+="\n  </a>\n</li>\n",u}),this.wysihtml5.tpl.color=Handlebars.template(function(m,e,t,p,o){function g(o){var e,a="";return a+="btn-"+f((e=(e=(e=o&&o.options,null==e||!1===e?e:e.toolbar),null==e||!1===e?e:e.size),"function"==typeof e?e.apply(o):e)),a}this.compilerInfo=[4,">= 1.0.0"],t=this.merge(t,m.helpers),o=o||{};var r,u="",f=this.escapeExpression,l=this;return u+="<li class=\"dropdown\">\n  <a class=\"btn btn-default dropdown-toggle ",r=t["if"].call(e,(r=(r=e&&e.options,null==r||!1===r?r:r.toolbar),null==r||!1===r?r:r.size),{hash:{},inverse:l.noop,fn:l.program(1,g,o),data:o}),(r||0===r)&&(u+=r),u+="\" data-toggle=\"dropdown\" tabindex=\"-1\">\n    <span class=\"current-color\">"+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.colours),null==r||!1===r?r:r.black),"function"==typeof r?r.apply(e):r))+"</span>\n    <b class=\"caret\"></b>\n  </a>\n  <ul class=\"dropdown-menu\">\n    <li><div class=\"wysihtml5-colors\" data-wysihtml5-command-value=\"black\"></div><a class=\"wysihtml5-colors-title\" data-wysihtml5-command=\"foreColor\" data-wysihtml5-command-value=\"black\">"+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.colours),null==r||!1===r?r:r.black),"function"==typeof r?r.apply(e):r))+"</a></li>\n    <li><div class=\"wysihtml5-colors\" data-wysihtml5-command-value=\"silver\"></div><a class=\"wysihtml5-colors-title\" data-wysihtml5-command=\"foreColor\" data-wysihtml5-command-value=\"silver\">"+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.colours),null==r||!1===r?r:r.silver),"function"==typeof r?r.apply(e):r))+"</a></li>\n    <li><div class=\"wysihtml5-colors\" data-wysihtml5-command-value=\"gray\"></div><a class=\"wysihtml5-colors-title\" data-wysihtml5-command=\"foreColor\" data-wysihtml5-command-value=\"gray\">"+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.colours),null==r||!1===r?r:r.gray),"function"==typeof r?r.apply(e):r))+"</a></li>\n    <li><div class=\"wysihtml5-colors\" data-wysihtml5-command-value=\"maroon\"></div><a class=\"wysihtml5-colors-title\" data-wysihtml5-command=\"foreColor\" data-wysihtml5-command-value=\"maroon\">"+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.colours),null==r||!1===r?r:r.maroon),"function"==typeof r?r.apply(e):r))+"</a></li>\n    <li><div class=\"wysihtml5-colors\" data-wysihtml5-command-value=\"red\"></div><a class=\"wysihtml5-colors-title\" data-wysihtml5-command=\"foreColor\" data-wysihtml5-command-value=\"red\">"+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.colours),null==r||!1===r?r:r.red),"function"==typeof r?r.apply(e):r))+"</a></li>\n    <li><div class=\"wysihtml5-colors\" data-wysihtml5-command-value=\"purple\"></div><a class=\"wysihtml5-colors-title\" data-wysihtml5-command=\"foreColor\" data-wysihtml5-command-value=\"purple\">"+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.colours),null==r||!1===r?r:r.purple),"function"==typeof r?r.apply(e):r))+"</a></li>\n    <li><div class=\"wysihtml5-colors\" data-wysihtml5-command-value=\"green\"></div><a class=\"wysihtml5-colors-title\" data-wysihtml5-command=\"foreColor\" data-wysihtml5-command-value=\"green\">"+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.colours),null==r||!1===r?r:r.green),"function"==typeof r?r.apply(e):r))+"</a></li>\n    <li><div class=\"wysihtml5-colors\" data-wysihtml5-command-value=\"olive\"></div><a class=\"wysihtml5-colors-title\" data-wysihtml5-command=\"foreColor\" data-wysihtml5-command-value=\"olive\">"+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.colours),null==r||!1===r?r:r.olive),"function"==typeof r?r.apply(e):r))+"</a></li>\n    <li><div class=\"wysihtml5-colors\" data-wysihtml5-command-value=\"navy\"></div><a class=\"wysihtml5-colors-title\" data-wysihtml5-command=\"foreColor\" data-wysihtml5-command-value=\"navy\">"+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.colours),null==r||!1===r?r:r.navy),"function"==typeof r?r.apply(e):r))+"</a></li>\n    <li><div class=\"wysihtml5-colors\" data-wysihtml5-command-value=\"blue\"></div><a class=\"wysihtml5-colors-title\" data-wysihtml5-command=\"foreColor\" data-wysihtml5-command-value=\"blue\">"+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.colours),null==r||!1===r?r:r.blue),"function"==typeof r?r.apply(e):r))+"</a></li>\n    <li><div class=\"wysihtml5-colors\" data-wysihtml5-command-value=\"orange\"></div><a class=\"wysihtml5-colors-title\" data-wysihtml5-command=\"foreColor\" data-wysihtml5-command-value=\"orange\">"+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.colours),null==r||!1===r?r:r.orange),"function"==typeof r?r.apply(e):r))+"</a></li>\n  </ul>\n</li>\n",u}),this.wysihtml5.tpl.emphasis=Handlebars.template(function(p,e,g,t,o){function u(o){var e,a="";return a+="btn-"+h((e=(e=(e=o&&o.options,null==e||!1===e?e:e.toolbar),null==e||!1===e?e:e.size),"function"==typeof e?e.apply(o):e)),a}function r(n,e){var t,r="";return r+="\n    <a class=\"btn ",t=g["if"].call(n,(t=(t=n&&n.options,null==t||!1===t?t:t.toolbar),null==t||!1===t?t:t.size),{hash:{},inverse:i.noop,fn:i.program(1,u,e),data:e}),(t||0===t)&&(r+=t),r+=" btn-default\" data-wysihtml5-command=\"small\" title=\"CTRL+S\" tabindex=\"-1\">"+h((t=(t=(t=n&&n.locale,null==t||!1===t?t:t.emphasis),null==t||!1===t?t:t.small),"function"==typeof t?t.apply(n):t))+"</a>\n    ",r}this.compilerInfo=[4,">= 1.0.0"],g=this.merge(g,p.helpers),o=o||{};var s,f="",h=this.escapeExpression,i=this;return f+="<li>\n  <div class=\"btn-group\">\n    <a class=\"btn ",s=g["if"].call(e,(s=(s=e&&e.options,null==s||!1===s?s:s.toolbar),null==s||!1===s?s:s.size),{hash:{},inverse:i.noop,fn:i.program(1,u,o),data:o}),(s||0===s)&&(f+=s),f+=" btn-default\" data-wysihtml5-command=\"bold\" title=\"CTRL+B\" tabindex=\"-1\">"+h((s=(s=(s=e&&e.locale,null==s||!1===s?s:s.emphasis),null==s||!1===s?s:s.bold),"function"==typeof s?s.apply(e):s))+"</a>\n    <a class=\"btn ",s=g["if"].call(e,(s=(s=e&&e.options,null==s||!1===s?s:s.toolbar),null==s||!1===s?s:s.size),{hash:{},inverse:i.noop,fn:i.program(1,u,o),data:o}),(s||0===s)&&(f+=s),f+=" btn-default\" data-wysihtml5-command=\"italic\" title=\"CTRL+I\" tabindex=\"-1\">"+h((s=(s=(s=e&&e.locale,null==s||!1===s?s:s.emphasis),null==s||!1===s?s:s.italic),"function"==typeof s?s.apply(e):s))+"</a>\n    <a class=\"btn ",s=g["if"].call(e,(s=(s=e&&e.options,null==s||!1===s?s:s.toolbar),null==s||!1===s?s:s.size),{hash:{},inverse:i.noop,fn:i.program(1,u,o),data:o}),(s||0===s)&&(f+=s),f+=" btn-default\" data-wysihtml5-command=\"underline\" title=\"CTRL+U\" tabindex=\"-1\">"+h((s=(s=(s=e&&e.locale,null==s||!1===s?s:s.emphasis),null==s||!1===s?s:s.underline),"function"==typeof s?s.apply(e):s))+"</a>\n    ",s=g["if"].call(e,(s=(s=(s=e&&e.options,null==s||!1===s?s:s.toolbar),null==s||!1===s?s:s.emphasis),null==s||!1===s?s:s.small),{hash:{},inverse:i.noop,fn:i.program(3,r,o),data:o}),(s||0===s)&&(f+=s),f+="\n  </div>\n</li>\n",f}),this.wysihtml5.tpl["font-styles"]=Handlebars.template(function(m,e,t,p,o){function g(o){var e,a="";return a+="btn-"+f((e=(e=(e=o&&o.options,null==e||!1===e?e:e.toolbar),null==e||!1===e?e:e.size),"function"==typeof e?e.apply(o):e)),a}this.compilerInfo=[4,">= 1.0.0"],t=this.merge(t,m.helpers),o=o||{};var r,u="",f=this.escapeExpression,l=this;return u+="<li class=\"dropdown\">\n  <a class=\"btn btn-default dropdown-toggle ",r=t["if"].call(e,(r=(r=e&&e.options,null==r||!1===r?r:r.toolbar),null==r||!1===r?r:r.size),{hash:{},inverse:l.noop,fn:l.program(1,g,o),data:o}),(r||0===r)&&(u+=r),u+="\" data-toggle=\"dropdown\">\n    ",r=t["if"].call(e,(r=(r=e&&e.options,null==r||!1===r?r:r.toolbar),null==r||!1===r?r:r.fa),{hash:{},inverse:l.program(5,function(){return"\n      <span class=\"glyphicon glyphicon-font\"></span>\n    "},o),fn:l.program(3,function(){return"\n      <span class=\"fa fa-font\"></span>\n    "},o),data:o}),(r||0===r)&&(u+=r),u+="\n    <span class=\"current-font\">"+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.font_styles),null==r||!1===r?r:r.normal),"function"==typeof r?r.apply(e):r))+"</span>\n    <b class=\"caret\"></b>\n  </a>\n  <ul class=\"dropdown-menu\">\n    <li><a data-wysihtml5-command=\"formatBlock\" data-wysihtml5-command-value=\"p\" tabindex=\"-1\">"+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.font_styles),null==r||!1===r?r:r.normal),"function"==typeof r?r.apply(e):r))+"</a></li>\n    <li><a data-wysihtml5-command=\"formatBlock\" data-wysihtml5-command-value=\"h1\" tabindex=\"-1\">"+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.font_styles),null==r||!1===r?r:r.h1),"function"==typeof r?r.apply(e):r))+"</a></li>\n    <li><a data-wysihtml5-command=\"formatBlock\" data-wysihtml5-command-value=\"h2\" tabindex=\"-1\">"+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.font_styles),null==r||!1===r?r:r.h2),"function"==typeof r?r.apply(e):r))+"</a></li>\n    <li><a data-wysihtml5-command=\"formatBlock\" data-wysihtml5-command-value=\"h3\" tabindex=\"-1\">"+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.font_styles),null==r||!1===r?r:r.h3),"function"==typeof r?r.apply(e):r))+"</a></li>\n    <li><a data-wysihtml5-command=\"formatBlock\" data-wysihtml5-command-value=\"h4\" tabindex=\"-1\">"+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.font_styles),null==r||!1===r?r:r.h4),"function"==typeof r?r.apply(e):r))+"</a></li>\n    <li><a data-wysihtml5-command=\"formatBlock\" data-wysihtml5-command-value=\"h5\" tabindex=\"-1\">"+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.font_styles),null==r||!1===r?r:r.h5),"function"==typeof r?r.apply(e):r))+"</a></li>\n    <li><a data-wysihtml5-command=\"formatBlock\" data-wysihtml5-command-value=\"h6\" tabindex=\"-1\">"+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.font_styles),null==r||!1===r?r:r.h6),"function"==typeof r?r.apply(e):r))+"</a></li>\n  </ul>\n</li>\n",u}),this.wysihtml5.tpl.html=Handlebars.template(function(m,e,t,p,o){function g(o){var e,a="";return a+="btn-"+f((e=(e=(e=o&&o.options,null==e||!1===e?e:e.toolbar),null==e||!1===e?e:e.size),"function"==typeof e?e.apply(o):e)),a}this.compilerInfo=[4,">= 1.0.0"],t=this.merge(t,m.helpers),o=o||{};var r,u="",f=this.escapeExpression,l=this;return u+="<li>\n  <div class=\"btn-group\">\n    <a class=\"btn ",r=t["if"].call(e,(r=(r=e&&e.options,null==r||!1===r?r:r.toolbar),null==r||!1===r?r:r.size),{hash:{},inverse:l.noop,fn:l.program(1,g,o),data:o}),(r||0===r)&&(u+=r),u+=" btn-default\" data-wysihtml5-action=\"change_view\" title=\""+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.html),null==r||!1===r?r:r.edit),"function"==typeof r?r.apply(e):r))+"\" tabindex=\"-1\">\n      ",r=t["if"].call(e,(r=(r=e&&e.options,null==r||!1===r?r:r.toolbar),null==r||!1===r?r:r.fa),{hash:{},inverse:l.program(5,function(){return"\n        <span class=\"glyphicon glyphicon-pencil\"></span>\n      "},o),fn:l.program(3,function(){return"\n        <span class=\"fa fa-pencil\"></span>\n      "},o),data:o}),(r||0===r)&&(u+=r),u+="\n    </a>\n  </div>\n</li>\n",u}),this.wysihtml5.tpl.image=Handlebars.template(function(m,e,t,p,o){function g(o){var e,a="";return a+="btn-"+f((e=(e=(e=o&&o.options,null==e||!1===e?e:e.toolbar),null==e||!1===e?e:e.size),"function"==typeof e?e.apply(o):e)),a}this.compilerInfo=[4,">= 1.0.0"],t=this.merge(t,m.helpers),o=o||{};var r,u="",f=this.escapeExpression,l=this;return u+="<li>\n  <div class=\"bootstrap-wysihtml5-insert-image-modal modal fade\" data-wysihtml5-dialog=\"insertImage\">\n    <div class=\"modal-dialog ",r=t["if"].call(e,(r=(r=e&&e.options,null==r||!1===r?r:r.toolbar),null==r||!1===r?r:r.smallmodals),{hash:{},inverse:l.noop,fn:l.program(1,function(){return"modal-sm"},o),data:o}),(r||0===r)&&(u+=r),u+="\">\n      <div class=\"modal-content\">\n        <div class=\"modal-header\">\n          <a class=\"close\" data-dismiss=\"modal\">&times;</a>\n          <h3>"+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.image),null==r||!1===r?r:r.insert),"function"==typeof r?r.apply(e):r))+"</h3>\n        </div>\n        <div class=\"modal-body\">\n          <div class=\"form-group\">\n            <input value=\"http://\" class=\"bootstrap-wysihtml5-insert-image-url form-control\" data-wysihtml5-dialog-field=\"src\">\n          </div> \n        </div>\n        <div class=\"modal-footer\">\n          <a class=\"btn btn-default\" data-dismiss=\"modal\" data-wysihtml5-dialog-action=\"cancel\" href=\"#\">"+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.image),null==r||!1===r?r:r.cancel),"function"==typeof r?r.apply(e):r))+"</a>\n          <a class=\"btn btn-primary\" data-dismiss=\"modal\"  data-wysihtml5-dialog-action=\"save\" href=\"#\">"+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.image),null==r||!1===r?r:r.insert),"function"==typeof r?r.apply(e):r))+"</a>\n        </div>\n      </div>\n    </div>\n  </div>\n  <a class=\"btn ",r=t["if"].call(e,(r=(r=e&&e.options,null==r||!1===r?r:r.toolbar),null==r||!1===r?r:r.size),{hash:{},inverse:l.noop,fn:l.program(3,g,o),data:o}),(r||0===r)&&(u+=r),u+=" btn-default\" data-wysihtml5-command=\"insertImage\" title=\""+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.image),null==r||!1===r?r:r.insert),"function"==typeof r?r.apply(e):r))+"\" tabindex=\"-1\">\n    ",r=t["if"].call(e,(r=(r=e&&e.options,null==r||!1===r?r:r.toolbar),null==r||!1===r?r:r.fa),{hash:{},inverse:l.program(7,function(){return"\n      <span class=\"glyphicon glyphicon-picture\"></span>\n    "},o),fn:l.program(5,function(){return"\n      <span class=\"fa fa-file-image-o\"></span>\n    "},o),data:o}),(r||0===r)&&(u+=r),u+="\n  </a>\n</li>\n",u}),this.wysihtml5.tpl.link=Handlebars.template(function(m,e,t,p,o){function g(o){var e,a="";return a+="btn-"+f((e=(e=(e=o&&o.options,null==e||!1===e?e:e.toolbar),null==e||!1===e?e:e.size),"function"==typeof e?e.apply(o):e)),a}this.compilerInfo=[4,">= 1.0.0"],t=this.merge(t,m.helpers),o=o||{};var r,u="",f=this.escapeExpression,l=this;return u+="<li>\n  <div class=\"bootstrap-wysihtml5-insert-link-modal modal fade\" data-wysihtml5-dialog=\"createLink\">\n    <div class=\"modal-dialog ",r=t["if"].call(e,(r=(r=e&&e.options,null==r||!1===r?r:r.toolbar),null==r||!1===r?r:r.smallmodals),{hash:{},inverse:l.noop,fn:l.program(1,function(){return"modal-sm"},o),data:o}),(r||0===r)&&(u+=r),u+="\">\n      <div class=\"modal-content\">\n        <div class=\"modal-header\">\n          <a class=\"close\" data-dismiss=\"modal\">&times;</a>\n          <h3>"+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.link),null==r||!1===r?r:r.insert),"function"==typeof r?r.apply(e):r))+"</h3>\n        </div>\n        <div class=\"modal-body\">\n          <div class=\"form-group\">\n            <input value=\"http://\" class=\"bootstrap-wysihtml5-insert-link-url form-control\" data-wysihtml5-dialog-field=\"href\">\n          </div> \n          <div class=\"checkbox\">\n            <label> \n              <input type=\"checkbox\" class=\"bootstrap-wysihtml5-insert-link-target\" checked>"+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.link),null==r||!1===r?r:r.target),"function"==typeof r?r.apply(e):r))+"\n            </label>\n          </div>\n        </div>\n        <div class=\"modal-footer\">\n          <a class=\"btn btn-default\" data-dismiss=\"modal\" data-wysihtml5-dialog-action=\"cancel\" href=\"#\">"+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.link),null==r||!1===r?r:r.cancel),"function"==typeof r?r.apply(e):r))+"</a>\n          <a href=\"#\" class=\"btn btn-primary\" data-dismiss=\"modal\" data-wysihtml5-dialog-action=\"save\">"+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.link),null==r||!1===r?r:r.insert),"function"==typeof r?r.apply(e):r))+"</a>\n        </div>\n      </div>\n    </div>\n  </div>\n  <a class=\"btn ",r=t["if"].call(e,(r=(r=e&&e.options,null==r||!1===r?r:r.toolbar),null==r||!1===r?r:r.size),{hash:{},inverse:l.noop,fn:l.program(3,g,o),data:o}),(r||0===r)&&(u+=r),u+=" btn-default\" data-wysihtml5-command=\"createLink\" title=\""+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.link),null==r||!1===r?r:r.insert),"function"==typeof r?r.apply(e):r))+"\" tabindex=\"-1\">\n    ",r=t["if"].call(e,(r=(r=e&&e.options,null==r||!1===r?r:r.toolbar),null==r||!1===r?r:r.fa),{hash:{},inverse:l.program(7,function(){return"\n      <span class=\"glyphicon glyphicon-share\"></span>\n    "},o),fn:l.program(5,function(){return"\n      <span class=\"fa fa-share-square-o\"></span>\n    "},o),data:o}),(r||0===r)&&(u+=r),u+="\n  </a>\n</li>\n",u}),this.wysihtml5.tpl.lists=Handlebars.template(function(m,e,t,p,o){function g(o){var e,a="";return a+="btn-"+f((e=(e=(e=o&&o.options,null==e||!1===e?e:e.toolbar),null==e||!1===e?e:e.size),"function"==typeof e?e.apply(o):e)),a}this.compilerInfo=[4,">= 1.0.0"],t=this.merge(t,m.helpers),o=o||{};var r,u="",f=this.escapeExpression,l=this;return u+="<li>\n  <div class=\"btn-group\">\n    <a class=\"btn ",r=t["if"].call(e,(r=(r=e&&e.options,null==r||!1===r?r:r.toolbar),null==r||!1===r?r:r.size),{hash:{},inverse:l.noop,fn:l.program(1,g,o),data:o}),(r||0===r)&&(u+=r),u+=" btn-default\" data-wysihtml5-command=\"insertUnorderedList\" title=\""+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.lists),null==r||!1===r?r:r.unordered),"function"==typeof r?r.apply(e):r))+"\" tabindex=\"-1\">\n    ",r=t["if"].call(e,(r=(r=e&&e.options,null==r||!1===r?r:r.toolbar),null==r||!1===r?r:r.fa),{hash:{},inverse:l.program(5,function(){return"\n      <span class=\"glyphicon glyphicon-list\"></span>\n    "},o),fn:l.program(3,function(){return"\n      <span class=\"fa fa-list-ul\"></span>\n    "},o),data:o}),(r||0===r)&&(u+=r),u+="\n    </a>\n    <a class=\"btn ",r=t["if"].call(e,(r=(r=e&&e.options,null==r||!1===r?r:r.toolbar),null==r||!1===r?r:r.size),{hash:{},inverse:l.noop,fn:l.program(1,g,o),data:o}),(r||0===r)&&(u+=r),u+=" btn-default\" data-wysihtml5-command=\"insertOrderedList\" title=\""+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.lists),null==r||!1===r?r:r.ordered),"function"==typeof r?r.apply(e):r))+"\" tabindex=\"-1\">\n    ",r=t["if"].call(e,(r=(r=e&&e.options,null==r||!1===r?r:r.toolbar),null==r||!1===r?r:r.fa),{hash:{},inverse:l.program(9,function(){return"\n      <span class=\"glyphicon glyphicon-th-list\"></span>\n    "},o),fn:l.program(7,function(){return"\n      <span class=\"fa fa-list-ol\"></span>\n    "},o),data:o}),(r||0===r)&&(u+=r),u+="\n    </a>\n    <a class=\"btn ",r=t["if"].call(e,(r=(r=e&&e.options,null==r||!1===r?r:r.toolbar),null==r||!1===r?r:r.size),{hash:{},inverse:l.noop,fn:l.program(1,g,o),data:o}),(r||0===r)&&(u+=r),u+=" btn-default\" data-wysihtml5-command=\"Outdent\" title=\""+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.lists),null==r||!1===r?r:r.outdent),"function"==typeof r?r.apply(e):r))+"\" tabindex=\"-1\">\n    ",r=t["if"].call(e,(r=(r=e&&e.options,null==r||!1===r?r:r.toolbar),null==r||!1===r?r:r.fa),{hash:{},inverse:l.program(13,function(){return"\n      <span class=\"glyphicon glyphicon-indent-right\"></span>\n    "},o),fn:l.program(11,function(){return"\n      <span class=\"fa fa-outdent\"></span>\n    "},o),data:o}),(r||0===r)&&(u+=r),u+="\n    </a>\n    <a class=\"btn ",r=t["if"].call(e,(r=(r=e&&e.options,null==r||!1===r?r:r.toolbar),null==r||!1===r?r:r.size),{hash:{},inverse:l.noop,fn:l.program(1,g,o),data:o}),(r||0===r)&&(u+=r),u+=" btn-default\" data-wysihtml5-command=\"Indent\" title=\""+f((r=(r=(r=e&&e.locale,null==r||!1===r?r:r.lists),null==r||!1===r?r:r.indent),"function"==typeof r?r.apply(e):r))+"\" tabindex=\"-1\">\n    ",r=t["if"].call(e,(r=(r=e&&e.options,null==r||!1===r?r:r.toolbar),null==r||!1===r?r:r.fa),{hash:{},inverse:l.program(17,function(){return"\n      <span class=\"glyphicon glyphicon-indent-left\"></span>\n    "},o),fn:l.program(15,function(){return"\n      <span class=\"fa fa-indent\"></span>\n    "},o),data:o}),(r||0===r)&&(u+=r),u+="\n    </a>\n  </div>\n</li>\n",u}),function(t){"use strict";"function"==typeof define&&define.amd?define("bootstrap.wysihtml5",["jquery","wysihtml5","bootstrap","bootstrap.wysihtml5.templates","bootstrap.wysihtml5.commands"],t):t(jQuery,wysihtml5)}(function(n,e){"use strict";(function(p,i){var e=function(e,t,n){if(i.tpl[e])return i.tpl[e]({locale:t,options:n})},n=function(e,n){this.el=e;var o=p.extend(!0,{},t,n);for(var a in o.customTemplates)o.customTemplates.hasOwnProperty(a)&&(i.tpl[a]=o.customTemplates[a]);this.toolbar=this.createToolbar(e,o),this.editor=this.createEditor(o)};n.prototype={constructor:n,createEditor:function(t){// Add the toolbar to a clone of the options object so multiple instances
// of the WYISYWG don't break because 'toolbar' is already defined
t=t||{},t=p.extend(!0,{},t),t.toolbar=this.toolbar[0],this.initializeEditor(this.el[0],t)},initializeEditor:function(e,t){var n=new i.Editor(this.el[0],t);if(n.on("beforeload",this.syncBootstrapDialogEvents),n.on("beforeload",this.loadParserRules),n.composer.editableArea.contentDocument?this.addMoreShortcuts(n,n.composer.editableArea.contentDocument.body||n.composer.editableArea.contentDocument,t.shortcuts):this.addMoreShortcuts(n,n.composer.editableArea,t.shortcuts),t&&t.events)for(var o in t.events)t.events.hasOwnProperty(o)&&n.on(o,t.events[o]);return n},loadParserRules:function(){"string"===p.type(this.config.parserRules)&&p.ajax({dataType:"json",url:this.config.parserRules,context:this,error:function(o,e,t){console.log(t)},success:function(t){this.config.parserRules=t,console.log("parserrules loaded")}}),this.config.pasteParserRulesets&&"string"===p.type(this.config.pasteParserRulesets)&&p.ajax({dataType:"json",url:this.config.pasteParserRulesets,context:this,error:function(o,e,t){console.log(t)},success:function(t){this.config.pasteParserRulesets=t}})},//sync wysihtml5 events for dialogs with bootstrap events
syncBootstrapDialogEvents:function(){var t=this;p.map(this.toolbar.commandMapping,function(t){return[t]}).filter(function(t){return t.dialog}).map(function(t){return t.dialog}).forEach(function(e){e.on("show",function(){p(this.container).modal("show")}),e.on("hide",function(){p(this.container).modal("hide"),setTimeout(t.composer.focus,0)}),p(e.container).on("shown.bs.modal",function(){p(this).find("input, select, textarea").first().focus()})}),this.on("change_view",function(){p(this.toolbar.container.children).find("a.btn").not("[data-wysihtml5-action=\"change_view\"]").toggleClass("disabled")})},createToolbar:function(n,s){var g=this,o=p("<ul/>",{class:"wysihtml5-toolbar",style:"display:none"}),a=s.locale||t.locale||"en";r.hasOwnProperty(a)||(console.debug("Locale '"+a+"' not found. Available locales are: "+Object.keys(r)+". Falling back to 'en'."),a="en");var l=p.extend(!0,{},r.en,r[a]);for(var d in s.toolbar)s.toolbar[d]&&o.append(e(d,l,s));return o.find("a[data-wysihtml5-command=\"formatBlock\"]").click(function(n){var t=n.delegateTarget||n.target||n.srcElement,e=p(t),o=e.data("wysihtml5-display-format-name"),a=e.data("wysihtml5-format-name")||e.html();(void 0===o||"true"===o)&&g.toolbar.find(".current-font").text(a)}),o.find("a[data-wysihtml5-command=\"foreColor\"]").click(function(n){var t=n.target||n.srcElement,e=p(t);g.toolbar.find(".current-color").text(e.html())}),this.el.before(o),o},addMoreShortcuts:function(e,t,l){/* some additional shortcuts */i.dom.observe(t,"keydown",function(t){var n=t.keyCode,o=l[n];if((t.ctrlKey||t.metaKey||t.altKey)&&o&&i.commands[o]){var a=e.toolbar.commandMapping[o+":null"];a&&a.dialog&&!a.state?a.dialog.show():i.commands[o].exec(e.composer,o),t.preventDefault()}})}};// these define our public api
var l={resetDefaults:function(){p.fn.wysihtml5.defaultOptions=p.extend(!0,{},p.fn.wysihtml5.defaultOptionsCache)},bypassDefaults:function(o){return this.each(function(){var e=p(this);e.data("wysihtml5",new n(e,o))})},shallowExtend:function(n){var e=p.extend({},p.fn.wysihtml5.defaultOptions,n||{},p(this).data()),t=this;return l.bypassDefaults.apply(t,[e])},deepExtend:function(n){var e=p.extend(!0,{},p.fn.wysihtml5.defaultOptions,n||{}),t=this;return l.bypassDefaults.apply(t,[e])},init:function(n){var e=this;return l.shallowExtend.apply(e,[n])}};p.fn.wysihtml5=function(t){return l[t]?l[t].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof t&&t?void p.error("Method "+t+" does not exist on jQuery.wysihtml5"):l.init.apply(this,arguments)},p.fn.wysihtml5.Constructor=n;var t=p.fn.wysihtml5.defaultOptions={toolbar:{"font-styles":!0,color:!1,emphasis:{small:!0},blockquote:!0,lists:!0,html:!1,link:!0,image:!0,smallmodals:!1},useLineBreaks:!1,parserRules:{classes:{"wysiwyg-color-silver":1,"wysiwyg-color-gray":1,"wysiwyg-color-white":1,"wysiwyg-color-maroon":1,"wysiwyg-color-red":1,"wysiwyg-color-purple":1,"wysiwyg-color-fuchsia":1,"wysiwyg-color-green":1,"wysiwyg-color-lime":1,"wysiwyg-color-olive":1,"wysiwyg-color-yellow":1,"wysiwyg-color-navy":1,"wysiwyg-color-blue":1,"wysiwyg-color-teal":1,"wysiwyg-color-aqua":1,"wysiwyg-color-orange":1},tags:{b:{},i:{},strong:{},em:{},p:{},br:{},ol:{},ul:{},li:{},h1:{},h2:{},h3:{},h4:{},h5:{},h6:{},blockquote:{},u:1,img:{check_attributes:{width:"numbers",alt:"alt",src:"url",height:"numbers"}},a:{check_attributes:{href:"url"},set_attributes:{target:"_blank",rel:"nofollow"}},span:1,div:1,small:1,code:1,pre:1}},locale:"en",shortcuts:{83:"small",// S
75:"createLink"// K
}};"undefined"==typeof p.fn.wysihtml5.defaultOptionsCache&&(p.fn.wysihtml5.defaultOptionsCache=p.extend(!0,{},p.fn.wysihtml5.defaultOptions));var r=p.fn.wysihtml5.locale={}})(n,e)}),function(o){o.commands.small={exec:function(e,t){return o.commands.formatInline.exec(e,t,"small")},state:function(e,t){return o.commands.formatInline.state(e,t,"small")}}}(wysihtml5),function(t){"function"==typeof define&&define.amd?define("bootstrap.wysihtml5.en-US",["jquery","bootstrap.wysihtml5"],t):t(jQuery)}(function(t){t.fn.wysihtml5.locale.en=t.fn.wysihtml5.locale["en-US"]={font_styles:{normal:"Normal text",h1:"Heading 1",h2:"Heading 2",h3:"Heading 3",h4:"Heading 4",h5:"Heading 5",h6:"Heading 6"},emphasis:{bold:"Bold",italic:"Italic",underline:"Underline",small:"Small"},lists:{unordered:"Unordered list",ordered:"Ordered list",outdent:"Outdent",indent:"Indent"},link:{insert:"Insert link",cancel:"Cancel",target:"Open link in new window"},image:{insert:"Insert image",cancel:"Cancel"},html:{edit:"Edit HTML"},colours:{black:"Black",silver:"Silver",gray:"Grey",maroon:"Maroon",red:"Red",purple:"Purple",green:"Green",olive:"Olive",navy:"Navy",blue:"Blue",orange:"Orange"}}});